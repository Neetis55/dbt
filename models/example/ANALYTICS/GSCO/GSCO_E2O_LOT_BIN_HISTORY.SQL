{{ 
config
(
  description = 'E2open view for LOT_BIN_HISTORY table', 
  materialized = 'view', 
  schema = 'GSCO', 
  tags = ['E2OPEN'],
  alias = 'E2O_LOT_BIN_HISTORY'
) 
}}

SELECT 
	SYSTEM_LOT_NAME,
	MES_LOT_NAME,
	TX_TYPE,
	WAFER_SCRIBE,
	WAFER_SLOT,
	WAFER_SLICE,
	GLOBAL_WAFERID,
	PUCK_ID,
	LOT_TX_ID,
	LOT_ID,
	BIN_REFERENCE,
	IS_BIN_DELETED,
	BIN_NAME,
	BACKSIDE_SCRIBE,
	BIN_TYPE,
	BIN_PART,
	BIN_STAGE_SET,
	BIN_LOCATION,
	BIN_GOOD_QTY,
	BIN_REJECTED_QTY,
	BIN_ESTIMATED_QTY,
	GOOD_QUANTITY_1,
	REJECT_QUANTITY_1,
	TOTAL_WAFER_QUANTITY,
	GOOD_QUANTITY_2,
	REJECT_QUANTITY_2,
	TOTAL_DIE_QUANTITY,
	CURRENT_LOT_PART_NAME,
	CURRENT_LOT_PART_REV,
	STAGE_SET,
	LOCATION,
	("BIN_FRATION_(%)") AS BIN_FRATION_PCT,
	("REJECT_BIN_FRACTION_(%)") AS REJECT_BIN_FRACTION_PCT,
	SORT_PROGRAM_AND_REVISION,
	TEST_PROGRAM_REV,
	PART_GROUP_1,
	PART_GROUP_2,
	BIN_DESCRIPTION,
	BIN_STATUS,
	OPEN_FLAG::NUMBER AS OPEN_FLAG,
	LOT_TYPE,
	LOT_STATE,
	FINANCE_STAGE,
	AGING_DAY,
	COMMENTS,
	MOST_RECENT_MOVE_TX_TIME,
	RMA_NUMBER,
	DIVISION,
	MES_TX_TIME,
	SYSTEM_TX_TIME,
	MES_TX_TYPE,
	UOM_QUANTITY_1,
	UOM_QUANTITY_2,
	LOT_CATEGORY,
	SHIPMENT_INVOICE_NUMBER,
	SORT_LOADBOARD_ID,
	MRB_CASE_NUMBERS,
	SORT_PROBER_ID,
	TARGET_PART_ID,
	SUPPLIER_LOCATION,
	FAB_LOT_ID,
	SORT_TESTER_ID,
	SORT_LOT_ID,
	FINAL_TEST_TESTER_ID,
	FINAL_TEST_LOADBOARD_ID,
	FINAL_TEST_HANDLER_ID,
	SALES_ORDER_ID,
	JIT_LOCATION,
	SUPPLIER_NAME,
	SUPPLIER_PO_NUMBER,
	SORT_DUT_BOARD_ID,
	FINAL_TEST_LOT_ID,
	SHIP_TO_CUSTOMER,
	FINAL_TEST_DUT_BOARD_ID,
	MASK_SET,
	MASK_SET_REVISION,
	DATE_CODE_2,
	TRACE_CODE_2,
	COUNTRY_OF_DIFFUSION,
	COUNTRY_OF_SUBSTRATE,
	HTS_COUNTRY,
	COUNTRY_OF_BUMP,
	ECAT,
	SORT_PROBE_CARD,
	SIC_POWDER_LOT_NUMBER,
	WIP_START_DATE,
	WIP_END_DATE,
	DISPOSITION_DATE,
	SEAL_OPEN_DATE,
	SCHEDULED_START_DATE,
	SORT_START_DATE,
	INK_DATE,
	SORT_END_DATE,
	FINAL_TEST_START_DATE,
	FINAL_TEST_END_DATE,
	SHIPMENT_TRANSFER_PRICE_USED,
	PDPW,
	BOULE_DATE_CODE,
	RETURN_SHIPMENT_FLAG,
	MAVERICK_LOT_FLAG,
	MARK_FLAG,
	FAB_END_DATE,
	FAB_START_DATE,
	ASSEMBLY_END_DATE,
	ASSEMBLY_START_DATE,
	FAB_DATE_CODE,
	DATE_CODE,
	SORT_PROGRAM_CHECKSUM,
	FINAL_TEST_PROGRAM_NAME,
	FINAL_TEST_PROGRAM_REV,
	FINAL_TEST_PROGRAM_CHECKSUM,
	SHELF_RACK,
	SHELF_ROW,
	SHELF_BIN,
	FINAL_TEST_TEMP,
	TOP_SIDE_MARK,
	BACK_SIDE_MARK,
	TRACE_CODE,
	FLOW_CODE_MBR_CODE,
	SORT_PROGRAM_NAME,
	SORT_PROGRAM_REVISION,
	BUMP_LOCATION,
	ASSEMBLY_LOT_ID,
	TESTLOADBOARD,
	BIW_INS_DTTM ,
    BIW_UPD_DTTM ,
    BIW_BATCH_ID
FROM 
{{source('STG_E2OPEN','LOT_BIN_HISTORY')}}
QUALIFY( ROW_NUMBER() OVER (PARTITION BY SYSTEM_LOT_NAME,WAFER_SCRIBE,LOT_TX_ID ORDER BY BIW_UPD_DTTM DESC)=1)
