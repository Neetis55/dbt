{{ 
config
(
  description = 'NPD LANDING PAGE REPORT VIEW', 
  materialized = 'view', 
  schema = 'NPD', 
  tags = ['MART_NPD'],
  alias = 'PROJECTS_RISK_VS_COST_RPT'
) 
}}

SELECT 
    r.SNAPSHOT_WEEK_KEY,
    r.PROJECT_NUMBER,
    r.PROCESS_DATE,
    r.PROJECT_RISKSCORE,
    c.RUNNING_COST
FROM 
{{ref ('MART_NPD_PROJECTS_RISK_SCORE_RPT')}} r
LEFT JOIN {{ref ('MART_NPD_PROJECTS_COST_RPT')}} c ON (
    r.SNAPSHOT_WEEK_KEY = c.SNAPSHOT_WEEK_KEY
    AND r.PROJECT_NUMBER = c.PROJECT_NUMBER
    AND r.PROCESS_DATE = c.PROCESS_DATE
)
WHERE r.SNAPSHOT_WEEK_KEY > (
  SELECT (SUBSTRING(MAX(SNAPSHOT_WEEK_KEY)-200,1,4)||'00')::NUMBER 
  FROM {{ref ('MART_NPD_PROJECTS_COST_RPT')}}
)