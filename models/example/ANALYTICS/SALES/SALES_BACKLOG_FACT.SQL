  {%- set v_setback_wh_size = "ALTER WAREHOUSE SET WAREHOUSE_SIZE = 'XSMALL' "-%}
{{ config(
  description = 'Backlog Fact view for Sales Analytics Team', 
  materialized = 'view', 
  schema = 'SALES', 
  tags = 'MART_SALES',
  alias = 'BACKLOG_FACT'
) }} 
--- Need to work with Tejaswi, to fix the column mapping
WITH 
BACKLOG AS (
SELECT
    BACKLOG_KEY,
    SNAPSHOT_DATE_KEY,
    DIRECT_CUSTOMER_KEY,
    INDIRECT_CUSTOMER_KEY,       
    END_CUSTOMER_KEY,      
    DIRECT_CORPORATION_KEY,
    END_CORPORATION_KEY,        
    MARKET_PRODUCT_NUMBER_KEY, 
    INTERNAL_PART_NUMBER_KEY,   
    PROCESS_DATE,
    DIRECT_CUSTOMER_CODE,
    INDIRECT_CUSTOMER_CODE,                                  
    END_CUSTOMER_CODE,                                  
    DIRECT_CORPORATION_CODE,
    END_CORPORATION_CODE,
    MARKET_PRODUCT_NUMBER,
    INTERNAL_PART_NUMBER,
    CUSTOMER_PART_NUMBER,
    SOURCE_OF_SALE,
    SALES_ORDER_LINE_ITEM_DELIVERY,
    REGION,
    LEGACY_SALES_ORDER_NUMBER,
    LEGACY_SALES_ITEM_NUMBER,
    LEGACY_SALES_DELIVERY_NUMBER,
    SALES_QUOTE_NUM,
    ORDER_TYPE_CODE,
    ACCRUAL_AMOUNT_USD,
    ACCRUAL_CATEGORY,
    ACCRUAL_COMMENTS,
    ACCRUAL_FACTOR,
    ACCRUAL_RULE_ID,
    ACCRUAL_RULE_SET,
    ACCRUAL_TRANSACTION_DATE,
    ACCRUAL_TYPE,
    ACTIVITY,
    BACKLOG_GROSS_USD, 
    BACKLOG_GROSS_EUR,
    BACKLOG_GROSS_JPY,
    BACKLOG_NET_USD, 
    BACKLOG_NET_EUR,
    BACKLOG_NET_JPY,
    BACKLOG_NET_QUANTITY,
    BACKLOG_GROSS_AMOUNT_TRANSACTION_CURRENCY,
    BACKLOG_NET_AMOUNT_TRANSACTION_CURRENCY,
    BILL_SOURCE_CODE,
    IS_BLANKET_ORDER,
    BOOKING_AND_BILLING_CODE,
    BOOKING_CATEGORY,
    IS_BOOKING,
    CUSTOMER_OF_INTEREST,
    CONTRACT_CURRENCY,
    ACCRUAL_AMOUNT_CONTRACT_CURRENCY,
    GROSS_AMOUNT_CONTRACT_CURRENCY,
    BACKLOG_NET_AMOUNT_CONTRACT_CURRENCY,
    CUSTOMER_REQUESTED_DATE,
    IS_CRD_DELQ,
    CREDIT_ACCOUNT,
    REQUESTED_SHIP_DATE,
    IS_CRSD_DELQ,
    CUSTOMER_SERVICE_REPRESENTATIVE,
    TRANSACTION_CURRENCY_ISO_CODE,
    CUSTOMER_PA_NUMBER,
    CUSTOMER_PO_NUMBER,
    CUSTOMER_RECIEPT_BANK_CODE,
    DEBIT_ACCOUNT,
    DELIVERY_REQUEST_DATE,
    DELIVERY_SOURCE_CD,
    ORDER_DELIVERY_HOLD_STATUS,
    DEMAND_BANK,
    DEMAND_CLASS,
    DEMAND_TYPE,
    ORDER_DELIVERY_STATUS_DTME,
    ENTRY_DATE,
    EARLIEST_POSSIBLE_SHIP_DATE,
    FMS_SERVICE_PROGRAM,
    HANDLING_CODE,
    ORDER_HDR_HOLD_STATUS,
    INVENTORY_INSURANCE_COVERAGE,
    INVOICE_NUM,
    INVOICED_QUANTITY,
    ORDER_ITM_HOLD_STATUS,
    JOURNAL_DESCRIPTION,
    LIABILITY_AGREEMENT,
    ORDER_LINE_STATUS,
    MANUFACTURER_RESCHEDULED_SHIP_DATE,
    IS_MRSD_DELQ,
    ORIGINAL_SCHEDULED_SHIP_DATE,
    IS_MSD_DELQ,
    NNCO_AGREEMENT_TYPE,
    IS_NNCO,
    OBR_TRX_ID,
    OPERATING_UNIT,
    ORA_DELIVERY_STATUS_CODE,
    DELIVERY_STATUS_CODE,
    LINE_NUMBER,
    ORDER_DLVRY_SOURCE_CODE,
    ORDER_NUMBER,
    ORDER_SOURCE_CODE,
    ORDER_STATUS,
    PLANNED_DELIVERY_DATE,
    IS_PDD_DELQ,
    PICK_QUANTITY,
    PRICE_SOURCE,
    RESCHEDULED_DELIVERY_DATE,
    IS_RDD_DELQ,
    SCHEDULED_SHIPPED_DATE,
    IS_SAMPLES,
    SHIP_CONFIRMED_QTY,
    SOLD_TO_CUST_CODE,
    SOURCE_DEMAND_BANK,
    SERVICE_PROGRAM_CODE,
    SERVICE_PROGRAM_CUSTOMER,
    TRANSACTION_DATE,
    TRANSIT_DAYS,
    IS_TRUE_BACKLOG,
    IS_SALES_TRUE_BACKLOG,
    ACCRUAL_AMOUNT_TRANSACTION_CURRENCY,
    UNIT_PRICE_TRANSACTION_CURRENCY,
    UNIT_PRICE_CRRT_AMT,
    UNIT_PRICE_SOURCE_CD,
    UNIT_PRICE_USD,
    UNIT_PRICE_EUR,
    UNIT_PRICE_JPY,
    IS_WS_FLAG,
    BUSINESS_CLASS_CODE,
    ACCRUAL_STATUS,
    CPN_REVISION_CODE,
    FILE_NAME, 
    BIW_INS_DTTM,
    BIW_UPD_DTTM,
    BIW_BATCH_ID,
    BIW_MD5_KEY
FROM 
{{ref('MART_SALES_BACKLOG_FACT')}}
),

CUSTOMER_BRIDGE AS (
SELECT
  BACKLOG_KEY,
  SNAPSHOT_DATE_KEY,
  INDIRECT_CORPORATION_KEY,
  ADJUSTED_END_CORPORATION_KEY,
  REFERENCE_CORPORATION_KEY,
  INDIRECT_CORPORATION_CODE,
  ADJUSTED_END_CORPORATION_CODE,
  REFERENCE_CORPORATION_CODE
  FROM 
  {{ref('MART_SALES_BACKLOG_CUSTOMER_BRIDGE')}}
  )

SELECT 
    BLKG.BACKLOG_KEY,
    BLKG.SNAPSHOT_DATE_KEY,
    BLKG.DIRECT_CUSTOMER_KEY,
    BLKG.INDIRECT_CUSTOMER_KEY,
    BLKG.END_CUSTOMER_KEY,
    BLKG.DIRECT_CORPORATION_KEY,
    BRIDGE.INDIRECT_CORPORATION_KEY,
    BLKG.END_CORPORATION_KEY,
    BRIDGE.ADJUSTED_END_CORPORATION_KEY,
    BRIDGE.REFERENCE_CORPORATION_KEY,
    BLKG.MARKET_PRODUCT_NUMBER_KEY,
    BLKG.INTERNAL_PART_NUMBER_KEY,
    BLKG.PROCESS_DATE,
    BLKG.DIRECT_CUSTOMER_CODE,
    BLKG.INDIRECT_CUSTOMER_CODE,                                  
    BLKG.END_CUSTOMER_CODE,                                  
    BLKG.DIRECT_CORPORATION_CODE,
    BRIDGE.INDIRECT_CORPORATION_CODE,
    BLKG.END_CORPORATION_CODE,
    BRIDGE.ADJUSTED_END_CORPORATION_CODE,
    BRIDGE.REFERENCE_CORPORATION_CODE,
    BLKG.MARKET_PRODUCT_NUMBER,
    BLKG.INTERNAL_PART_NUMBER,
    BLKG.CUSTOMER_PART_NUMBER,
    BLKG.SOURCE_OF_SALE,
    BLKG.SALES_ORDER_LINE_ITEM_DELIVERY,
    BLKG.REGION,
    BLKG.LEGACY_SALES_ORDER_NUMBER,
    BLKG.LEGACY_SALES_ITEM_NUMBER,
    BLKG.LEGACY_SALES_DELIVERY_NUMBER,
    BLKG.SALES_QUOTE_NUM,
    BLKG.ORDER_TYPE_CODE,
    BLKG.ACCRUAL_AMOUNT_USD,
    BLKG.ACCRUAL_CATEGORY,
    BLKG.ACCRUAL_COMMENTS,
    BLKG.ACCRUAL_FACTOR,
    BLKG.ACCRUAL_RULE_ID,
    BLKG.ACCRUAL_RULE_SET,
    BLKG.ACCRUAL_TRANSACTION_DATE,
    BLKG.ACCRUAL_TYPE,
    BLKG.ACTIVITY,
    BLKG.BACKLOG_GROSS_USD, 
    BLKG.BACKLOG_GROSS_EUR,
    BLKG.BACKLOG_GROSS_JPY,
    BLKG.BACKLOG_NET_USD, 
    BLKG.BACKLOG_NET_EUR,
    BLKG.BACKLOG_NET_JPY,
    BLKG.BACKLOG_NET_QUANTITY,
    BLKG.BACKLOG_GROSS_AMOUNT_TRANSACTION_CURRENCY,
    BLKG.BACKLOG_NET_AMOUNT_TRANSACTION_CURRENCY,
    BLKG.BILL_SOURCE_CODE,
    BLKG.IS_BLANKET_ORDER,
    BLKG.BOOKING_AND_BILLING_CODE,
    BLKG.BOOKING_CATEGORY,
    BLKG.IS_BOOKING,
    BLKG.CUSTOMER_OF_INTEREST,
    BLKG.CONTRACT_CURRENCY,
    BLKG.ACCRUAL_AMOUNT_CONTRACT_CURRENCY,
    BLKG.GROSS_AMOUNT_CONTRACT_CURRENCY,
    BLKG.BACKLOG_NET_AMOUNT_CONTRACT_CURRENCY,
    BLKG.CUSTOMER_REQUESTED_DATE,
    BLKG.IS_CRD_DELQ,
    BLKG.CREDIT_ACCOUNT,
    BLKG.REQUESTED_SHIP_DATE,
    BLKG.IS_CRSD_DELQ,
    BLKG.CUSTOMER_SERVICE_REPRESENTATIVE,
    BLKG.TRANSACTION_CURRENCY_ISO_CODE,
    BLKG.CUSTOMER_PA_NUMBER,
    BLKG.CUSTOMER_PO_NUMBER,
    BLKG.CUSTOMER_RECIEPT_BANK_CODE,
    BLKG.DEBIT_ACCOUNT,
    BLKG.DELIVERY_REQUEST_DATE,
    BLKG.DELIVERY_SOURCE_CD,
    BLKG.ORDER_DELIVERY_HOLD_STATUS,
    BLKG.DEMAND_BANK,
    BLKG.DEMAND_CLASS,
    BLKG.DEMAND_TYPE,
    BLKG.ORDER_DELIVERY_STATUS_DTME,
    BLKG.ENTRY_DATE,
    BLKG.EARLIEST_POSSIBLE_SHIP_DATE,
    BLKG.FMS_SERVICE_PROGRAM,
    BLKG.HANDLING_CODE,
    BLKG.ORDER_HDR_HOLD_STATUS,
    BLKG.INVENTORY_INSURANCE_COVERAGE,
    BLKG.INVOICE_NUM,
    BLKG.INVOICED_QUANTITY,
    BLKG.ORDER_ITM_HOLD_STATUS,
    BLKG.JOURNAL_DESCRIPTION,
    BLKG.LIABILITY_AGREEMENT,
    BLKG.ORDER_LINE_STATUS,
    BLKG.MANUFACTURER_RESCHEDULED_SHIP_DATE,
    BLKG.IS_MRSD_DELQ,
    BLKG.ORIGINAL_SCHEDULED_SHIP_DATE,
    BLKG.IS_MSD_DELQ,
    BLKG.NNCO_AGREEMENT_TYPE,
    BLKG.IS_NNCO,
    BLKG.OBR_TRX_ID,
    BLKG.OPERATING_UNIT,
    BLKG.ORA_DELIVERY_STATUS_CODE,
    BLKG.DELIVERY_STATUS_CODE,
    BLKG.LINE_NUMBER,
    BLKG.ORDER_DLVRY_SOURCE_CODE,
    BLKG.ORDER_NUMBER,
    BLKG.ORDER_SOURCE_CODE,
    BLKG.ORDER_STATUS,
    BLKG.PLANNED_DELIVERY_DATE,
    BLKG.IS_PDD_DELQ,
    BLKG.PICK_QUANTITY,
    BLKG.PRICE_SOURCE,
    BLKG.RESCHEDULED_DELIVERY_DATE,
    BLKG.IS_RDD_DELQ,
    BLKG.SCHEDULED_SHIPPED_DATE,
    BLKG.IS_SAMPLES,
    BLKG.SHIP_CONFIRMED_QTY,
    BLKG.SOLD_TO_CUST_CODE,
    BLKG.SOURCE_DEMAND_BANK,
    BLKG.SERVICE_PROGRAM_CODE,
    BLKG.SERVICE_PROGRAM_CUSTOMER,
    BLKG.TRANSACTION_DATE,
    BLKG.TRANSIT_DAYS,
    BLKG.IS_TRUE_BACKLOG,
    BLKG.IS_SALES_TRUE_BACKLOG,
    BLKG.ACCRUAL_AMOUNT_TRANSACTION_CURRENCY,
    BLKG.UNIT_PRICE_TRANSACTION_CURRENCY,
    BLKG.UNIT_PRICE_CRRT_AMT,
    BLKG.UNIT_PRICE_SOURCE_CD,
    BLKG.UNIT_PRICE_USD,
    BLKG.UNIT_PRICE_EUR,
    BLKG.UNIT_PRICE_JPY,
    BLKG.IS_WS_FLAG,
    BLKG.BUSINESS_CLASS_CODE,
    BLKG.ACCRUAL_STATUS,
    BLKG.CPN_REVISION_CODE,
    BLKG.FILE_NAME,
    BLKG.BIW_INS_DTTM,
    BLKG.BIW_UPD_DTTM,
    BLKG.BIW_BATCH_ID,
    BLKG.BIW_MD5_KEY
FROM 
BACKLOG AS BLKG
LEFT JOIN CUSTOMER_BRIDGE AS BRIDGE 
ON BLKG. BACKLOG_KEY = BRIDGE.BACKLOG_KEY
AND BLKG. SNAPSHOT_DATE_KEY = BRIDGE.SNAPSHOT_DATE_KEY