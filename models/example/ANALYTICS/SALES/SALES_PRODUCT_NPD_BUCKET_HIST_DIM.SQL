{{
    config(
         description = 'Product NPD Bucket View'
        ,materialized='view'
        ,schema ='SALES'
        ,tags ='MART_SALES'
        ,alias='PRODUCT_NPD_BUCKET_HIST_DIM'
        )
}}

WITH MART_PART AS (
SELECT 
    PART_KEY,
    PART_ID, 
    CASE 
        WHEN NEW_PART_DEFINITION_DATE='1900-01-01' 
            THEN PART_ADD_TIMESTAMP
        ELSE NEW_PART_DEFINITION_DATE
    END NEW_PART_DEFINITION_DATE , 
    BIW_INS_DTTM,
    BIW_UPD_DTTM,
    BIW_BATCH_ID
FROM 
{{ref('MART_ENGINEERING_PART')}} 
),
MART_PRODUCT AS (
SELECT
    PRODUCT_KEY,
    PRODUCT_ID,    
    BIW_INS_DTTM,
    BIW_UPD_DTTM,
    BIW_BATCH_ID
FROM {{ref('MART_SALES_PRODUCT')}} 
),
ALL_PRODUCT AS (
    SELECT
        COALESCE(PART.PART_KEY,PRODUCT.PRODUCT_KEY) AS PART_KEY,
        COALESCE(PART.PART_ID,PRODUCT.PRODUCT_ID) AS PART_ID,
        CASE 
        WHEN PART.NEW_PART_DEFINITION_DATE > '1990-01-01'::DATE 
            THEN 
                CASE 
                    WHEN MONTH(NEW_PART_DEFINITION_DATE) =12 AND  DAY(NEW_PART_DEFINITION_DATE) = 31
                    THEN NEW_PART_DEFINITION_DATE + INTERVAL '1 DAY'
                    ELSE NEW_PART_DEFINITION_DATE 
                    END 
        ELSE  '1990-01-02'::DATE 
        END AS NEW_PART_DEFINITION_DATE,
        COALESCE(PART.BIW_INS_DTTM,PRODUCT.BIW_INS_DTTM) AS BIW_INS_DTTM,
        COALESCE(PART.BIW_UPD_DTTM,PRODUCT.BIW_UPD_DTTM) AS BIW_UPD_DTTM,
        COALESCE(PART.BIW_BATCH_ID,PRODUCT.BIW_BATCH_ID) AS BIW_BATCH_ID
    FROM MART_PART AS PART
    FULL OUTER JOIN  MART_PRODUCT AS PRODUCT
    ON PART.PART_KEY=PRODUCT.PRODUCT_KEY
)
SELECT 
P.PART_KEY,
CASE 
    WHEN BCKT.NPD_BUCKET = 'New Request' 
        THEN '1990-01-01'::DATE 
    WHEN BCKT.NPD_BUCKET = '0 to 3 years' 
        THEN P.NEW_PART_DEFINITION_DATE
    WHEN BCKT.NPD_BUCKET = '3 to 5 years' 
        THEN DATEADD(YEAR, 3, P.NEW_PART_DEFINITION_DATE)
    WHEN BCKT.NPD_BUCKET = '5 to 7 years' 
        THEN DATEADD(YEAR, 5, P.NEW_PART_DEFINITION_DATE)
    WHEN BCKT.NPD_BUCKET = '7 to 10 years' 
        THEN DATEADD(YEAR, 7, P.NEW_PART_DEFINITION_DATE)
    WHEN BCKT.NPD_BUCKET = 'Greater than 10 years' 
        THEN DATEADD(YEAR, 10, P.NEW_PART_DEFINITION_DATE) 
END EFFECTIVE_FROM,
CASE 
    WHEN BCKT.NPD_BUCKET = 'New Request' 
        THEN P.NEW_PART_DEFINITION_DATE - INTERVAL '1 DAY'
    WHEN BCKT.NPD_BUCKET = '0 to 3 years' 
        THEN P.NEW_PART_DEFINITION_DATE + INTERVAL '3 YEAR'- INTERVAL '1 DAY'
    WHEN BCKT.NPD_BUCKET = '3 to 5 years' 
        THEN P.NEW_PART_DEFINITION_DATE + INTERVAL '5 YEAR'- INTERVAL '1 DAY'
    WHEN BCKT.NPD_BUCKET = '5 to 7 years' 
        THEN P.NEW_PART_DEFINITION_DATE + INTERVAL '7 YEAR' - INTERVAL '1 DAY'
    WHEN BCKT.NPD_BUCKET = '7 to 10 years' 
        THEN P.NEW_PART_DEFINITION_DATE + INTERVAL '10 YEAR' - INTERVAL '1 DAY'
    WHEN BCKT.NPD_BUCKET = 'Greater than 10 years' 
        THEN '9999-12-31'::DATE
END EFFECTIVE_TO,
P.PART_ID,
P.NEW_PART_DEFINITION_DATE,
BCKT.NPD_BUCKET,
P.BIW_INS_DTTM,
P.BIW_UPD_DTTM,
P.BIW_BATCH_ID
FROM 
    ALL_PRODUCT AS P
CROSS JOIN (SELECT TOP 6 * FROM {{ref('MART_SALES_PRODUCT_NPD_BUCKET_REF')}} ) BCKT 
