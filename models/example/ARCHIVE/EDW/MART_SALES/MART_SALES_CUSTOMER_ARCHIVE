--dbt run --full-refresh --select MART_SALES_CUSTOMER_ARCHIVE
--dbt run --select MART_SALES_CUSTOMER_ARCHIVE
{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['CUSTOMER_KEY','SNAPSHOT_DATE' ]-%}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
{%-set v_all_column_list =  edw_get_column_list( ref('ETL_MART_SALES_CUSTOMER') ) -%}
{%-set v_update_column_list =  edw_get_quoted_column_list( ref('ETL_MART_SALES_CUSTOMER') ,v_pk_list|list + ['BIW_INS_DTTM']|list) -%}
--DBT Variable
--SELECT {{v_all_column_list}}
--SELECT {{v_update_column_list}}
{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'DBT_MART_SALES_CUSTOMER_ARCHIVE'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}

{{
    config(
         description = 'Building table CUSTOMER dimension for sales mart '
        ,transient=false
        ,materialized='incremental'
        ,schema ='MART_SALES'
        ,alias='CUSTOMER_ARCHIVE'
        ,unique_key= v_pk_list
        ,merge_update_columns = ['CUSTOMER_CODE', 'ERP_SITE_USE_ID', 'ERP_STATUS', 'CRM_CUSTOMER_OID', 'CRM_STATUS', 'CUSTOMER_NAME', 'CUSTOMER_TYPE_CODE'
                                , 'CUSTOMER_TYPE_DESCRIPTION', 'CUSTOMER_SOURCE', 'BUSINESS_CLASS_CODE', 'CORPORATION_CODE', 'CORPORATION_DESCRIPTION', 'END_CORPORATION_CODE'
                                , 'END_CORPORATION_DESCRIPTION', 'SALES_ORGANIZATION_CODE', 'END_USE_CODE', 'END_USE_DESCRIPTION', 'CURRENCY_CODE', 'ISO_CURRENCY_CODE', 'HAS_CREDIT_HOLD'
                                , 'HAS_SERVICE_HOLD', 'HAS_APPROVAL', 'ORDER_PROCESSING_REGION_CODE', 'CRD_SHIP_EARLY_DAYS_QUANTITY', 'HAS_CRD_PARTIAL', 'SHIP_VIA_CODE', 'HAS_SHIP_TO_CRD'
                                , 'SHIP_LATE_DAYS_QUANTITY', 'BILL_CUSTOMER_CODE', 'HANDLING_METHOD_CODE', 'HANDLING_METHOD_CODE_DESCRIPTION', 'IS_EDI_CUSTOMER', 'FINAL_DESTINATION_DESCRIPTION'
                                , 'BILL_COUNTRY_SOURCE_CODE', 'FOB_OPTION_CODE', 'PAYMENT_TERM_CODE', 'FINANCIAL_BANK_ID', 'TRANSIT_DAYS_QUANTITY', 'DELIVERY_TYPE_CODE', 'DATE_CODE_MAXIMUM_AGE_QUANTITY'
                                , 'IS_CPN_REQUIRED', 'VAT_TAX_CODE', 'MINIMUM_DOLLAR_VALUE_AMOUNT', 'IS_MINIMUM_DOLLAR_VALUE_VALID', 'CORPORATION_CATEGORY_CODE', 'CORPORATION_CATEGORY_DESCRIPTION'
                                , 'CUSTOMER_ENTITY_CODE', 'FORECAST_TYPE_CODE', 'IS_FORECAST_CUSTOMER', 'FORECAST_CUSTOMER_STATUS_CODE', 'REPLENISHMENT_CODE', 'SERVICE_TYPE_CODE'
                                , 'CHANGE_ORDER_APROVAL_REQUIRED_CODE', 'UDC_GENERIC_PROG_DESCRIPTION', 'CREATE_BY_ID', 'CREATE_DTTM', 'LAST_UPDATE_BY_ID', 'LAST_UPDATE_DTTM', 'IS_DELETED'
                                , 'QUALITY_CODE', 'FISCAL_ACCOUNT_NUMBER', 'CREDIT_LIMIT_AMOUNT', 'DIVISION', 'SALES_STRUCTURE', 'MARKET_SEGMENT_CODE', 'IS_ASSEMBLY_LOCATION', 'OPERATING_UNIT'
                                , 'COF_CODE', 'COG_CODE', 'CUSTOMER_SHUT_DOWN_FROM_DATE', 'CUSTOMER_SHUT_DOWN_TO_DATE', 'FOB_OPTION_DESCRIPTION', 'TAX_CODE', 'ORACLE_ORDER_TYPE', 'ORACLE_PAYMENT_TERM'
                                , 'ORACLE_SITE_STATUS', 'ORACLE_SITE_NUMBER', 'ORACLE_SHIP_METHOD', 'FREE_TRADE_ZONE', 'COLLECTOR_NAME', 'IS_SHUTDOWN', 'CSR_USER_ID', 'CSR_FIRST_NAME', 'CSR_LAST_NAME'
                                , 'CSR_EMAIL', 'CSR_PHONE', 'CSR_CONTACT_LAST_UPDATE_BY', 'CSR_CONTACT_CREATED_BY', 'FQA_USER_ID', 'FQA_FIRST_NAME', 'FQA_LAST_NAME', 'FQA_EMAIL', 'FQA_PHONE'
                                , 'FQA_CONTACT_LAST_UPDATE_BY', 'FQA_CONTACT_CREATED_BY', 'BUYER_USER_ID', 'BUYER_FIRST_NAME', 'BUYER_LAST_NAME', 'BUYER_EMAIL', 'BUYER_PHONE', 'BUYER_CONTACT_LAST_UPDATE_BY'
                                , 'BUYER_CONTACT_CREATED_BY', 'FSE_USER_ID', 'FSE_FIRST_NAME', 'FSE_LAST_NAME', 'FSE_EMAIL', 'FSE_PHONE', 'FSE_CONTACT_LAST_UPDATE_BY', 'FSE_CONTACT_CREATED_BY'
                                , 'BIW_UPD_DTTM', 'BIW_BATCH_ID', 'BIW_MD5_KEY']
        ,tags ='MART_SALES'
        ,post_hook= [v_sql_upd_success_batch]	
        )
}}

WITH CUST AS (
  select 
    MD5(CUSTOMER_CODE) AS CUSTOMER_KEY, 
    CURRENT_DATE SNAPSHOT_DATE, 
    CUSTOMER_CODE, 
    ERP_SITE_USE_ID, 
    ERP_STATUS, 
    CRM_CUSTOMER_OID, 
    CRM_STATUS, 
    CUSTOMER_NAME, 
    CUSTOMER_TYPE_CODE, 
    CUSTOMER_TYPE_DESCRIPTION, 
    CUSTOMER_SOURCE, 
    BUSINESS_CLASS_CODE, 
    CORPORATION_CODE, 
    CORPORATION_DESCRIPTION, 
    END_CORPORATION_CODE, 
    END_CORPORATION_DESCRIPTION, 
    SALES_ORGANIZATION_CODE, 
    END_USE_CODE, 
    END_USE_DESCRIPTION, 
    CURRENCY_CODE, 
    ISO_CURRENCY_CODE, 
    HAS_CREDIT_HOLD, 
    HAS_SERVICE_HOLD, 
    HAS_APPROVAL, 
    ORDER_PROCESSING_REGION_CODE, 
    CRD_SHIP_EARLY_DAYS_QUANTITY, 
    HAS_CRD_PARTIAL, 
    SHIP_VIA_CODE, 
    HAS_SHIP_TO_CRD, 
    SHIP_LATE_DAYS_QUANTITY, 
    BILL_CUSTOMER_CODE, 
    HANDLING_METHOD_CODE, 
    HANDLING_METHOD_CODE_DESCRIPTION, 
    IS_EDI_CUSTOMER, 
    FINAL_DESTINATION_DESCRIPTION, 
    BILL_COUNTRY_SOURCE_CODE, 
    FOB_OPTION_CODE, 
    PAYMENT_TERM_CODE, 
    FINANCIAL_BANK_ID, 
    TRANSIT_DAYS_QUANTITY, 
    DELIVERY_TYPE_CODE, 
    DATE_CODE_MAXIMUM_AGE_QUANTITY, 
    IS_CPN_REQUIRED, 
    VAT_TAX_CODE, 
    MINIMUM_DOLLAR_VALUE_AMOUNT, 
    IS_MINIMUM_DOLLAR_VALUE_VALID, 
    CORPORATION_CATEGORY_CODE, 
    CORPORATION_CATEGORY_DESCRIPTION, 
    CUSTOMER_ENTITY_CODE, 
    FORECAST_TYPE_CODE, 
    IS_FORECAST_CUSTOMER, 
    FORECAST_CUSTOMER_STATUS_CODE, 
    REPLENISHMENT_CODE, 
    SERVICE_TYPE_CODE, 
    CHANGE_ORDER_APROVAL_REQUIRED_CODE, 
    UDC_GENERIC_PROG_DESCRIPTION, 
    CREATE_BY_ID, 
    CREATE_DTTM, 
    LAST_UPDATE_BY_ID, 
    LAST_UPDATE_DTTM, 
    IS_DELETED, 
    QUALITY_CODE, 
    FISCAL_ACCOUNT_NUMBER, 
    CREDIT_LIMIT_AMOUNT, 
    DIVISION, 
    SALES_STRUCTURE, 
    MARKET_SEGMENT_CODE, 
    IS_ASSEMBLY_LOCATION, 
    OPERATING_UNIT, 
    COF_CODE, 
    COG_CODE, 
    CUSTOMER_SHUT_DOWN_FROM_DATE, 
    CUSTOMER_SHUT_DOWN_TO_DATE, 
    FOB_OPTION_DESCRIPTION, 
    TAX_CODE, 
    ORACLE_ORDER_TYPE, 
    ORACLE_PAYMENT_TERM, 
    ORACLE_SITE_STATUS, 
    ORACLE_SITE_NUMBER, 
    ORACLE_SHIP_METHOD, 
    FREE_TRADE_ZONE, 
    COLLECTOR_NAME, 
    IS_SHUTDOWN, 
    CSR_USER_ID, 
    CSR_FIRST_NAME, 
    CSR_LAST_NAME, 
    CSR_EMAIL, 
    CSR_PHONE, 
    CSR_CONTACT_LAST_UPDATE_BY, 
    CSR_CONTACT_CREATED_BY, 
    FQA_USER_ID, 
    FQA_FIRST_NAME, 
    FQA_LAST_NAME, 
    FQA_EMAIL, 
    FQA_PHONE, 
    FQA_CONTACT_LAST_UPDATE_BY, 
    FQA_CONTACT_CREATED_BY, 
    BUYER_USER_ID, 
    BUYER_FIRST_NAME, 
    BUYER_LAST_NAME, 
    BUYER_EMAIL, 
    BUYER_PHONE, 
    BUYER_CONTACT_LAST_UPDATE_BY, 
    BUYER_CONTACT_CREATED_BY, 
    FSE_USER_ID, 
    FSE_FIRST_NAME, 
    FSE_LAST_NAME, 
    FSE_EMAIL, 
    FSE_PHONE, 
    FSE_CONTACT_LAST_UPDATE_BY, 
    FSE_CONTACT_CREATED_BY, 
    BIW_INS_DTTM, 
    BIW_UPD_DTTM, 
    BIW_BATCH_ID, 
    BIW_MD5_KEY 
  FROM 
    {{ref('ETL_MART_SALES_CUSTOMER') }}
) 
SELECT 
  CUSTOMER_KEY, 
  SNAPSHOT_DATE, 
  CUSTOMER_CODE, 
  ERP_SITE_USE_ID, 
  ERP_STATUS, 
  CRM_CUSTOMER_OID, 
  CRM_STATUS, 
  CUSTOMER_NAME, 
  CUSTOMER_TYPE_CODE, 
  CUSTOMER_TYPE_DESCRIPTION, 
  CUSTOMER_SOURCE, 
  BUSINESS_CLASS_CODE, 
  CORPORATION_CODE, 
  CORPORATION_DESCRIPTION, 
  END_CORPORATION_CODE, 
  END_CORPORATION_DESCRIPTION, 
  SALES_ORGANIZATION_CODE, 
  END_USE_CODE, 
  END_USE_DESCRIPTION, 
  CURRENCY_CODE, 
  ISO_CURRENCY_CODE, 
  HAS_CREDIT_HOLD, 
  HAS_SERVICE_HOLD, 
  HAS_APPROVAL, 
  ORDER_PROCESSING_REGION_CODE, 
  CRD_SHIP_EARLY_DAYS_QUANTITY, 
  HAS_CRD_PARTIAL, 
  SHIP_VIA_CODE, 
  HAS_SHIP_TO_CRD, 
  SHIP_LATE_DAYS_QUANTITY, 
  BILL_CUSTOMER_CODE, 
  HANDLING_METHOD_CODE, 
  HANDLING_METHOD_CODE_DESCRIPTION, 
  IS_EDI_CUSTOMER, 
  FINAL_DESTINATION_DESCRIPTION, 
  BILL_COUNTRY_SOURCE_CODE, 
  FOB_OPTION_CODE, 
  PAYMENT_TERM_CODE, 
  FINANCIAL_BANK_ID, 
  TRANSIT_DAYS_QUANTITY, 
  DELIVERY_TYPE_CODE, 
  DATE_CODE_MAXIMUM_AGE_QUANTITY, 
  IS_CPN_REQUIRED, 
  VAT_TAX_CODE, 
  MINIMUM_DOLLAR_VALUE_AMOUNT, 
  IS_MINIMUM_DOLLAR_VALUE_VALID, 
  CORPORATION_CATEGORY_CODE, 
  CORPORATION_CATEGORY_DESCRIPTION, 
  CUSTOMER_ENTITY_CODE, 
  FORECAST_TYPE_CODE, 
  IS_FORECAST_CUSTOMER, 
  FORECAST_CUSTOMER_STATUS_CODE, 
  REPLENISHMENT_CODE, 
  SERVICE_TYPE_CODE, 
  CHANGE_ORDER_APROVAL_REQUIRED_CODE, 
  UDC_GENERIC_PROG_DESCRIPTION, 
  CREATE_BY_ID, 
  CREATE_DTTM, 
  LAST_UPDATE_BY_ID, 
  LAST_UPDATE_DTTM, 
  IS_DELETED, 
  QUALITY_CODE, 
  FISCAL_ACCOUNT_NUMBER, 
  CREDIT_LIMIT_AMOUNT, 
  DIVISION, 
  SALES_STRUCTURE, 
  MARKET_SEGMENT_CODE, 
  IS_ASSEMBLY_LOCATION, 
  OPERATING_UNIT, 
  COF_CODE, 
  COG_CODE, 
  CUSTOMER_SHUT_DOWN_FROM_DATE, 
  CUSTOMER_SHUT_DOWN_TO_DATE, 
  FOB_OPTION_DESCRIPTION, 
  TAX_CODE, 
  ORACLE_ORDER_TYPE, 
  ORACLE_PAYMENT_TERM, 
  ORACLE_SITE_STATUS, 
  ORACLE_SITE_NUMBER, 
  ORACLE_SHIP_METHOD, 
  FREE_TRADE_ZONE, 
  COLLECTOR_NAME, 
  IS_SHUTDOWN, 
  CSR_USER_ID, 
  CSR_FIRST_NAME, 
  CSR_LAST_NAME, 
  CSR_EMAIL, 
  CSR_PHONE, 
  CSR_CONTACT_LAST_UPDATE_BY, 
  CSR_CONTACT_CREATED_BY, 
  FQA_USER_ID, 
  FQA_FIRST_NAME, 
  FQA_LAST_NAME, 
  FQA_EMAIL, 
  FQA_PHONE, 
  FQA_CONTACT_LAST_UPDATE_BY, 
  FQA_CONTACT_CREATED_BY, 
  BUYER_USER_ID, 
  BUYER_FIRST_NAME, 
  BUYER_LAST_NAME, 
  BUYER_EMAIL, 
  BUYER_PHONE, 
  BUYER_CONTACT_LAST_UPDATE_BY, 
  BUYER_CONTACT_CREATED_BY, 
  FSE_USER_ID, 
  FSE_FIRST_NAME, 
  FSE_LAST_NAME, 
  FSE_EMAIL, 
  FSE_PHONE, 
  FSE_CONTACT_LAST_UPDATE_BY, 
  FSE_CONTACT_CREATED_BY, 
'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
{{V_BIW_BATCH_ID}}	 as BIW_BATCH_ID,
  BIW_MD5_KEY 
FROM 
  CUST
