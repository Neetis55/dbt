{{
    config(
         description = 'Product view for Sales Analytics Team'
        ,materialized='view'
        ,schema ='SALES'
        ,tags ='MART_SALES'
        ,alias='PRODUCT_DIM'
        )
}}

WITH MART_PART
AS (
SELECT 
    PART_KEY,
    PART_ID, 
    EFFECTIVE_DATE, 
    PART_DESCRIPTION, 
    PART_SOURCE, 
    LEGACY_PART_ID, 
    PAL1_CODE, 
    PAL2_CODE, 
    PAL2_DESCRIPTION, 
    PAL3_CODE, 
    PAL3_DESCRIPTION, 
    PAL4_CODE, 
    PAL4_DESCRIPTION, 
    PART_CLASS_CODE, 
    PART_CLASS_DESCRIPTION, 
    PART_TRANS_STATUS_CODE, 
    PART_TRANS_STATUS_DESCRIPTION, 
    AEC_QUALIFIED_CODE, 
    APS_BUILD_CATEGORY_CODE,
    CASE_OUTLINE_CODE, 
    COMMODITY_CODE, 
    ECAT_CODE, 
    ECCN_CODE, 
    ERP_RESOURCE_ASY_CODE, 
    ERP_RESOURCE_ASY_DESCRIPTION, 
    ERP_RESOURCE_BSP_CODE, 
    ERP_RESOURCE_FAB_CODE, 
    ERP_RESOURCE_FSP_CODE, 
    ERP_RESOURCE_MEF_CODE, 
    ERP_RESOURCE_SWF_CODE, 
    ERP_RESOURCE_TST_CODE, 
    HTS_EU_CODE, 
    HTS_EU_CODE_DESCRIPTION, 
    HTS_US_CODE, 
    HTS_US_CODE_DESCRIPTION, 
    MARKET_LEADTIME_WEEKS, 
    --MOQ_QUANTITY, 
    MPQ_PRI_CONTAINER_CODE, 
    MPQ_PRI_CONTAINER_QUANTITY, 
    MSL_VALUE, 
    MSL_TEMPERATURE, 
    PART_COMP_TYPE_CODE, 
    PART_RELEASE_STATUS_CODE, 
    PART_RELEASE_STATUS_DESCRIPTION, 
    PART_SPEC_ID, 
    POQ_CONTAINER_CODE, 
    POQ_QUANTITY, 
    PPAP_CAPABLE_CODE, 
    PART_LINE_ID, 
    PART_AVAILABILITY_STATUS_CODE, 
    QUALITY_LVL_CODE, 
    QUALITY_LVL_TARGET_MARKET_DESCRIPTION, 
    SBU_CODE, 
    SOQ_CONTAINER_CODE, 
    PDPW_VALUE, 
    IS_UL_LISTED, 
    UOM_OPERATIONS_CODE, 
    WAFER_SIZE_VALUE, 
    LAST_CHANGE_DATE, 
    LAST_ORDER_DATE, 
    LAST_SHIP_DATE, 
    NEW_PART_DEFINITION_DATE, 
    NEW_PART_EXP_DATE, 
    PART_RELEASE_PRODUCTION_DATE, 
    IS_APS_RELEVANT, 
    IS_BURN_IN, 
    BUY_SELL_CODE, 
    IS_CUSTOM_ELEC_TEST, 
    IS_CUSTOM_MARK_ONLY, 
    IS_CUSTOM_PART_ID, 
    IS_CUSTOMER_CONSIGN_TO_ON, 
    IS_ENG_PART, 
    IS_HALIDE_FREE, 
    IS_ITAR, 
    LEADED_DIE_ATTACH_CODE, 
    MILITARY_COMPLIANCE_CODE, 
    IS_MPP, 
    IS_NCNR, 
    IS_OPN, 
    IS_PB_FREE_LEADS, 
    IS_PRICE_BOOK, 
    ROHS_CHINA_CODE, 
    ROHS_EU_EXEMPTION_CODE, 
    ROHS_EU_CODE, 
    SAMPLE_ALLOW_CODE, 
    IS_SOLE_SOURCE, 
    IS_STEP_PRICE, 
    IS_TAPE_REEL, 
    IS_VALUED_PART, 
    CREATE_BY, 
    --CREATE_DATE, 
    LAST_CHANGE_USER_ID, 
    --PART_OID_AK_ID, 
    PART_TYPE_DESCRIPTION, 
    PART_SUB_TYPE_CD, 
    LIFECYCLE_PHASE_DESCRIPTION, 
    MARKET_PART_LIFECYCLE_DESCRIPTION, 
    PACKING_CONFIG_ID, 
    PART_OWNER_DESCRIPTION, 
    CORE_PART_NO_CONFIG_ID, 
    SAFE_LAUNCH_CODE, 
    DESIGN_TYPE_DESC, 
    MKT_SEG_SUBSEG_EUC_PRI_DESC, 
    WSTS_CD, 
    PROJECT_NUMBER_CD, 
    CASE_OUTLINE_ID, 
    DIE_DESIGN_CONFIG_ID, 
    WAFER_BACKSIDE_VAR_ID, 
    WAFER_FRONTSIDE_VARIANT_ID, 
    WAFER_TECH_VARIANT_ID, 
    WAFER_TECH_TYPE_ID, 
    WAFER_TECH_FAM_ID, 
    ENG_PKG_TYPE_DESC, 
    ENG_PKG_FAM_DESC, 
    DEFLT_APS_STAGE_CD, 
    DEFLT_FE_BE_CD, 
    ENGG_CHNG_ORDER_ID, 
    CUST_SPEC_CONTROLLED_CODE, 
    COMPONENT_COUNT, 
    TOTAL_COMPONENT_COUNT, 
    DISTINCT_COMPONENT_COUNT, 
    EXPERT_DATA_SOURCE_NAME, 
    PREDOMINANT_OPN_PART_ID, 
    EXPERT_USER_ID, 
    EXPERT_EMAIL, 
    EXPERT_NAME, 
    PLANNING_DIRECTOR_ID, 
    PLANNING_DIRECTOR_NAME, 
    BU_MANAGER_NAME, 
    BU_MANAGER_ID, 
    PART_QUALITY_TARGET_MARKET_TYPE,
    PART_QUALITY_TARGET_MARKET_DESCRIPTION, 
    LEGACY_COMPANY_NAME, 
    SBU_SHORT_DESCRIPTION, 
    GLOBAL_PART_ID, 
    PART_OWNER_NAME, 
    PACKAGE_GROUP_CODE, 
    DCE_CYCLE_TIME_DAYS, 
    FAMILY_LEAD_TIME_DAYS, 
    POINT_LEAD_TIME_DAYS, 
    TREND_LEAD_TIME_DAYS, 
    OVERRIDE_LEAD_TIME_DAYS, 
    PLANNING_SYSTEM_LEAD_TIME_DAYS, 
    MBOI_ASSEMBLY_SITE_CODE, 
    MBOI_TEST_SITE_CODE, 
    APS_ASSEMBLY_SITE_CODE, 
    APS_TEST_SITE_CODE, 
    AGILE_ASSEMBLY_SITE_CODE, 
    AGILE_TEST_SITE_CODE, 
    CAPACITY_GROUP_CODE, 
    WFA_SITE_CODE, 
    WPR_SITE_CODE, 
    BUSINESS_UNIT_CODE, 
    PART_AREA_CODE, 
    PART_SUB_AREA_CODE, 
    ASSEMBLY_RATIO_NUMBER, 
    AVERAGE_USAGE_NUMBER, 
    PART_PROGRAM_CODE, 
    SUPPLY_CHN_PLNG_CODE, 
    ANCHOR_STAR_PRODUCT_CODE, 
    IO_PART_CLASS, 
    IO_CATEGORY, 
    MFG_PART_ID, 
    GROUP_CODE, 
    GROUP_DESCRIPTION, 
    DIVISION_CODE, 
    DIVISION_DESCRIPTION, 
    BUSINESS_UNIT_DESCRIPTION, 
    OPERTNL_CODE, 
    OPERTNL_DESC, 
    IO_OVERRIDE_CATEGORY, 
    MARKET_PN, 
    IS_MARKET_PN, 
    ENG_PKG_VAR_ID, 
    FLOW_CODE, 
    IS_SPEC_CNTRL_BOM, 
    DOCUMENT_ISSUE, 
    ENG_PKG_CODE, 
    IS_CONTAIN_ENCRYPT, 
    SOLUTION_SELLING_TYPE, 
    CAPC_CONSTR_COLOR, 
    CAPC_CONSTR_COLOR_CALCED, 
    CAPC_CONSTR_COLOR_OVRD, 
    CAPC_CONSTR_COLOR_OVRD_UID, 
    CAPC_CONSTR_COLOR_OVRD_RSN, 
    CAPC_CONSTR_PRIM_CONSTR_RG, 
    SUBJECT_EXPORT_ADMIN_REG, 
    MAX_LINE_QUANTITY, 
    IS_PB_FREE_PART, 
    PB_FREE_PART_DESCRIPTION, 
    PB_FREE_PART_EXEMPT, 
    IS_LABEL_SYMBOL_ROHS_EU, 
    IS_LABEL_SYMBOL_ROHS_CHINA, 
    LABEL_SYMBOL_ROHS_CHINA_VALUE, 
    IS_LABEL_SYMBOL_PBFREE_2LI, 
    IS_LABEL_SYMBOL_2LI, 
    IS_LABEL_SYMBOL_ECAT, 
    IS_LABEL_SYMBOL_HALIDE_FREE, 
    IS_LABEL_SYMBOL_RU, 
    LABEL_SYMBOL_ECAT_CODE, 
    HTS_EU_8_CODE, 
    PART_REL_FCST_DATE, 
    PART_STATUS_GROUP, 
    RELEASE_DATE, 
    SOQ_QUANTITY, 
    PACKAGE_CODE_DESCRIPTION, 
    EXEMPTIONS, 
    IS_ROHS,
    NPD_DATE, 
    IS_ON_TARGET, 
    PART_ADD_TIMESTAMP, 
    BUSINESS_GROUP,
    REPORTING_UNIT,
    FSP_DATE,
    BIW_PART_SOURCE,
    BIW_INS_DTTM,
    BIW_UPD_DTTM,
    BIW_BATCH_ID,
    BIW_MD5_KEY
FROM 
{{ref('MART_ENGINEERING_PART')}} 

),
MART_PRODUCT AS (
SELECT
    PRODUCT_KEY,
    PRODUCT_ID,
    PRODUCT_SOURCE,
    MOQ_QUANTITY,
    PART_OID_AK_ID,
    CREATED_DATE,
    BIW_INS_DTTM,
    BIW_UPD_DTTM,
    BIW_BATCH_ID,
    BIW_MD5_KEY
FROM {{ref('MART_SALES_PRODUCT')}} 
)
SELECT
    COALESCE(PART.PART_KEY,PRODUCT.PRODUCT_KEY) AS PART_KEY,
    COALESCE(PART.PART_ID,PRODUCT.PRODUCT_ID) AS PART_ID,
    PART.EFFECTIVE_DATE, 
    PART.PART_DESCRIPTION, 
    COALESCE(PART.PART_SOURCE,PRODUCT.PRODUCT_SOURCE,PART.BIW_PART_SOURCE) AS DATA_SOURCE,
    PART.LEGACY_PART_ID, 
    PART.PAL1_CODE, 
    PART.PAL2_CODE,
    PART.PAL2_DESCRIPTION, 
    PART.PAL3_CODE, 
    PART.PAL3_DESCRIPTION, 
    PART.PAL4_CODE, 
    PART.PAL4_DESCRIPTION, 
    PART.PART_CLASS_CODE, 
    PART.PART_CLASS_DESCRIPTION, 
    PART.PART_TRANS_STATUS_CODE, 
    PART.PART_TRANS_STATUS_DESCRIPTION,
    PART.AEC_QUALIFIED_CODE, 
    PART.APS_BUILD_CATEGORY_CODE, 
    PART.CASE_OUTLINE_CODE, 
    PART.COMMODITY_CODE, 
    PART.ECAT_CODE, 
    PART.ECCN_CODE, 
    PART.ERP_RESOURCE_ASY_CODE, 
    PART.ERP_RESOURCE_ASY_DESCRIPTION, 
    PART.ERP_RESOURCE_BSP_CODE, 
    PART.ERP_RESOURCE_FAB_CODE, 
    PART.ERP_RESOURCE_FSP_CODE, 
    PART.ERP_RESOURCE_MEF_CODE, 
    PART.ERP_RESOURCE_SWF_CODE, 
    PART.ERP_RESOURCE_TST_CODE, 
    PART.HTS_EU_CODE, 
    PART.HTS_EU_CODE_DESCRIPTION, 
    PART.HTS_US_CODE, 
    PART.HTS_US_CODE_DESCRIPTION, 
    PART.MARKET_LEADTIME_WEEKS, 
    --PART.MOQ_QUANTITY, 
    PART.MPQ_PRI_CONTAINER_CODE, 
    PART.MPQ_PRI_CONTAINER_QUANTITY, 
    PART.MSL_VALUE, 
    PART.MSL_TEMPERATURE, 
    PART.PART_COMP_TYPE_CODE, 
    PART.PART_RELEASE_STATUS_CODE, 
    PART.PART_RELEASE_STATUS_DESCRIPTION, 
    PART.PART_SPEC_ID, 
    PART.POQ_CONTAINER_CODE, 
    PART.POQ_QUANTITY, 
    PART.PPAP_CAPABLE_CODE, 
    PART.PART_LINE_ID, 
    PART.PART_AVAILABILITY_STATUS_CODE, 
    PART.QUALITY_LVL_CODE, 
    PART.QUALITY_LVL_TARGET_MARKET_DESCRIPTION, 
    PART.SBU_CODE, 
    PART.SOQ_CONTAINER_CODE, 
    PART.PDPW_VALUE, 
    PART.IS_UL_LISTED, 
    PART.UOM_OPERATIONS_CODE, 
    PART.WAFER_SIZE_VALUE, 
    PART.LAST_CHANGE_DATE, 
    PART.LAST_ORDER_DATE, 
    PART.LAST_SHIP_DATE, 
    PART.NEW_PART_DEFINITION_DATE, 
    PART.NEW_PART_EXP_DATE, 
    PART.PART_RELEASE_PRODUCTION_DATE, 
    PART.IS_APS_RELEVANT, 
    PART.IS_BURN_IN, 
    PART.BUY_SELL_CODE, 
    PART.IS_CUSTOM_ELEC_TEST, 
    PART.IS_CUSTOM_MARK_ONLY, 
    PART.IS_CUSTOM_PART_ID, 
    PART.IS_CUSTOMER_CONSIGN_TO_ON, 
    PART.IS_ENG_PART, 
    PART.IS_HALIDE_FREE, 
    PART.IS_ITAR, 
    PART.LEADED_DIE_ATTACH_CODE, 
    PART.MILITARY_COMPLIANCE_CODE, 
    PART.IS_MPP, 
    PART.IS_NCNR, 
    PART.IS_OPN, 
    PART.IS_PB_FREE_LEADS, 
    PART.IS_PRICE_BOOK, 
    PART.ROHS_CHINA_CODE, 
    PART.ROHS_EU_EXEMPTION_CODE, 
    PART.ROHS_EU_CODE, 
    PART.SAMPLE_ALLOW_CODE, 
    PART.IS_SOLE_SOURCE, 
    PART.IS_STEP_PRICE, 
    PART.IS_TAPE_REEL, 
    PART.IS_VALUED_PART, 
    PART.CREATE_BY, 
    --PART.CREATED_DATE, 
    PART.LAST_CHANGE_USER_ID, 
    --PART.PART_OID_AK_ID, 
    PART.PART_TYPE_DESCRIPTION, 
    PART.PART_SUB_TYPE_CD, 
    PART.LIFECYCLE_PHASE_DESCRIPTION, 
    PART.MARKET_PART_LIFECYCLE_DESCRIPTION, 
    PART.PACKING_CONFIG_ID, 
    PART.PART_OWNER_DESCRIPTION, 
    PART.CORE_PART_NO_CONFIG_ID, 
    PART.SAFE_LAUNCH_CODE, 
    PART.DESIGN_TYPE_DESC, 
    PART.MKT_SEG_SUBSEG_EUC_PRI_DESC, 
    PART.WSTS_CD, 
    PART.PROJECT_NUMBER_CD, 
    PART.CASE_OUTLINE_ID, 
    PART.DIE_DESIGN_CONFIG_ID, 
    PART.WAFER_BACKSIDE_VAR_ID, 
    PART.WAFER_FRONTSIDE_VARIANT_ID, 
    PART.WAFER_TECH_VARIANT_ID, 
    PART.WAFER_TECH_TYPE_ID, 
    PART.WAFER_TECH_FAM_ID, 
    PART.ENG_PKG_TYPE_DESC, 
    PART.ENG_PKG_FAM_DESC, 
    PART.DEFLT_APS_STAGE_CD, 
    PART.DEFLT_FE_BE_CD, 
    PART.ENGG_CHNG_ORDER_ID, 
    PART.CUST_SPEC_CONTROLLED_CODE, 
    PART.COMPONENT_COUNT, 
    PART.TOTAL_COMPONENT_COUNT, 
    PART.DISTINCT_COMPONENT_COUNT, 
    PART.EXPERT_DATA_SOURCE_NAME, 
    PART.PREDOMINANT_OPN_PART_ID, 
    PART.EXPERT_USER_ID, 
    PART.EXPERT_EMAIL, 
    PART.EXPERT_NAME, 
    PART.PLANNING_DIRECTOR_ID, 
    PART.PLANNING_DIRECTOR_NAME, 
    PART.BU_MANAGER_NAME, 
    PART.BU_MANAGER_ID, 
    PART.PART_QUALITY_TARGET_MARKET_TYPE,
    PART.PART_QUALITY_TARGET_MARKET_DESCRIPTION, 
    PART.LEGACY_COMPANY_NAME, 
    PART.SBU_SHORT_DESCRIPTION, 
    PART.GLOBAL_PART_ID, 
    PART.PART_OWNER_NAME, 
    PART.PACKAGE_GROUP_CODE, 
    PART.DCE_CYCLE_TIME_DAYS, 
    PART.FAMILY_LEAD_TIME_DAYS, 
    PART.POINT_LEAD_TIME_DAYS, 
    PART.TREND_LEAD_TIME_DAYS, 
    PART.OVERRIDE_LEAD_TIME_DAYS, 
    PART.PLANNING_SYSTEM_LEAD_TIME_DAYS, 
    PART.MBOI_ASSEMBLY_SITE_CODE, 
    PART.MBOI_TEST_SITE_CODE, 
    PART.APS_ASSEMBLY_SITE_CODE, 
    PART.APS_TEST_SITE_CODE, 
    PART.AGILE_ASSEMBLY_SITE_CODE, 
    PART.AGILE_TEST_SITE_CODE, 
    PART.CAPACITY_GROUP_CODE, 
    PART.WFA_SITE_CODE, 
    PART.WPR_SITE_CODE, 
    PART.BUSINESS_UNIT_CODE, 
    PART.PART_AREA_CODE, 
    PART.PART_SUB_AREA_CODE, 
    PART.ASSEMBLY_RATIO_NUMBER, 
    PART.AVERAGE_USAGE_NUMBER, 
    PART.PART_PROGRAM_CODE, 
    PART.SUPPLY_CHN_PLNG_CODE, 
    PART.ANCHOR_STAR_PRODUCT_CODE, 
    PART.IO_PART_CLASS, 
    PART.IO_CATEGORY, 
    PART.MFG_PART_ID, 
    PART.GROUP_CODE, 
    PART.GROUP_DESCRIPTION, 
    PART.DIVISION_CODE, 
    PART.DIVISION_DESCRIPTION, 
    PART.BUSINESS_UNIT_DESCRIPTION, 
    PART.OPERTNL_CODE, 
    PART.OPERTNL_DESC, 
    PART.IO_OVERRIDE_CATEGORY, 
    PART.MARKET_PN, 
    PART.IS_MARKET_PN, 
    PART.ENG_PKG_VAR_ID, 
    PART.FLOW_CODE, 
    PART.IS_SPEC_CNTRL_BOM, 
    PART.DOCUMENT_ISSUE, 
    PART.ENG_PKG_CODE, 
    PART.IS_CONTAIN_ENCRYPT, 
    PART.SOLUTION_SELLING_TYPE, 
    PART.CAPC_CONSTR_COLOR, 
    PART.CAPC_CONSTR_COLOR_CALCED, 
    PART.CAPC_CONSTR_COLOR_OVRD, 
    PART.CAPC_CONSTR_COLOR_OVRD_UID, 
    PART.CAPC_CONSTR_COLOR_OVRD_RSN, 
    PART.CAPC_CONSTR_PRIM_CONSTR_RG, 
    PART.SUBJECT_EXPORT_ADMIN_REG, 
    PART.MAX_LINE_QUANTITY, 
    PART.IS_PB_FREE_PART, 
    PART.PB_FREE_PART_DESCRIPTION, 
    PART.PB_FREE_PART_EXEMPT, 
    PART.IS_LABEL_SYMBOL_ROHS_EU, 
    PART.IS_LABEL_SYMBOL_ROHS_CHINA, 
    PART.LABEL_SYMBOL_ROHS_CHINA_VALUE, 
    PART.IS_LABEL_SYMBOL_PBFREE_2LI, 
    PART.IS_LABEL_SYMBOL_2LI, 
    PART.IS_LABEL_SYMBOL_ECAT, 
    PART.IS_LABEL_SYMBOL_HALIDE_FREE, 
    PART.IS_LABEL_SYMBOL_RU, 
    PART.LABEL_SYMBOL_ECAT_CODE, 
    PART.HTS_EU_8_CODE, 
    PART.PART_REL_FCST_DATE, 
    PART.PART_STATUS_GROUP, 
    PART.RELEASE_DATE, 
    PART.SOQ_QUANTITY, 
    PART.PACKAGE_CODE_DESCRIPTION, 
    PART.EXEMPTIONS, 
    PART.NPD_DATE, 
    PART.IS_ON_TARGET, 
    PART.PART_ADD_TIMESTAMP,
    PART.BUSINESS_GROUP,
    PART.REPORTING_UNIT,
    PART.FSP_DATE,
    CASE 
	    WHEN PART.FSP_DATE<=TRIM(TO_TIMESTAMP_NTZ('1900-01-01 00:00:00.000')) THEN NULL
	    WHEN PART.REPORTING_UNIT='PSG - IPS' AND PART.FSP_DATE<TO_TIMESTAMP_TZ('2023-01-01 00:00:00')
	    THEN DATEADD(day,-200,PART.FSP_DATE) ELSE PART.FSP_DATE 
    END AS REVISED_NPD_DATE,
    PRODUCT.MOQ_QUANTITY,
    PRODUCT.PART_OID_AK_ID,
    PRODUCT.CREATED_DATE,
    COALESCE(PART.BIW_INS_DTTM,PRODUCT.BIW_INS_DTTM) AS BIW_INS_DTTM,
    COALESCE(PART.BIW_UPD_DTTM,PRODUCT.BIW_UPD_DTTM) AS BIW_UPD_DTTM,
    COALESCE(PART.BIW_BATCH_ID,PRODUCT.BIW_BATCH_ID) AS BIW_BATCH_ID,
    COALESCE(PART.BIW_MD5_KEY,PRODUCT.BIW_MD5_KEY) AS BIW_MD5_KEY
FROM MART_PART AS PART
FULL OUTER JOIN  MART_PRODUCT AS PRODUCT
ON PART.PART_KEY=PRODUCT.PRODUCT_KEY
