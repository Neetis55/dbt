{{ 
  config
  (
  description = 'ECC_FACT view for Sales Analytics Team', 
  materialized = 'view', 
  schema = 'SALES', 
  tags = 'MART_SALES',
  alias = 'END_CUSTOMER_CONSUMPTION_WEEKLY_FACT'
) 
}} 

{%- set V_ANALYTICS_DB = var('V_ANALYTICS_DEFAULT_DB') ~ env_var('DBT_DEP_ENV') ~'.' -%}

WITH FISCAL_WEEK_VW AS 
(
    SELECT 
        CALENDAR_DATE,
        FISCAL_WEEK_KEY
    FROM 
    {{source('ENTERPRISE','DATE')}}
    WHERE CALENDAR_DATE>= TRUNC(CURRENT_DATE - INTERVAL '5 YEAR','YEAR')
),

BILLING AS (
SELECT
    BILLING_KEY,
    BILLING_DATE_KEY AS TRANSACTION_DATE_KEY,
    DIRECT_CUSTOMER_KEY,
    END_CUSTOMER_KEY,
    DIRECT_CORPORATION_KEY,
    END_CORPORATION_KEY,
    MARKET_PRODUCT_NUMBER_KEY,
    INTERNAL_PART_NUMBER_KEY,
    MD5(COALESCE(CUSTOMER_PART_NUMBER,'-1')) AS CUSTOMER_PART_NUMBER_KEY,
    PROCESS_DATE AS TRANSACTION_DATE,
    DIRECT_CUSTOMER_CODE,
    END_CUSTOMER_CODE,
    DIRECT_CORPORATION_CODE,
    END_CORPORATION_CODE,
    MARKET_PRODUCT_NUMBER,
    INTERNAL_PART_NUMBER,
    CUSTOMER_PART_NUMBER,
    TRANSACTION_CURRENCY_ISO_CODE,
    NULL AS DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    NULL AS DISTRIBUTOR_END_CUSTOMER_NAME,
    NULL AS DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    NULL AS DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    CASE 
        WHEN LEFT(CUSTOMER_PA_NUMBER,1 ) = 'C' 
        THEN CUSTOMER_PA_NUMBER
        ELSE NULL 
    END AS  PRICE_CONTRACT,
    NULL AS  DISTRIBUTOR_INVOICE_NUMBER,
    NULL AS  DISTRIBUTOR_PO_NUMBER,
    SOURCE_OF_SALE,
    'BILLING' AS SOURCE_OF_DATA,
    CASE
        WHEN PROCESS_DATE <='2015-08-29'::DATE 
        THEN 'TBSABilling'
        ELSE ACTIVITY
    END ACTIVITY,
    BILLING_NET_AMOUNT_USD,
    BILLING_NET_AMOUNT_JPY,
    BILLING_NET_AMOUNT_EUR,
    BILLING_NET_AMOUNT_TRANSACTION_CURRENCY ,    
    BILLING_NET_QUANTITY,
    GROSS_AMOUNT_USD,
    GROSS_AMOUNT_JPY,
    GROSS_AMOUNT_EUR,
    GROSS_AMOUNT_TRANSACTION_CURRENCY,
    BILLING_GROSS_QUANTITY,
    NULL AS  LOCAL_DISTRIBUTOR_PRICE_AMOUNT,
    0  AS DISTRIBUTOR_PRICE_USD,
    NULL AS  LOCAL_AMOUNT
FROM {{ref('MART_SALES_BILLING_FACT')}} BILL
  LEFT JOIN {{ref('SALES_PRODUCT')}} PRDCT 
    ON BILL.INTERNAL_PART_NUMBER_KEY=PRDCT.PART_KEY
WHERE PROCESS_DATE >= TRUNC(CURRENT_DATE - INTERVAL '5 YEAR','YEAR')
        AND UPPER(BUSINESS_CLASS_CODE) NOT IN ('DIST', 'D3PL', 'CIPO')              
	    AND IS_TRUE_BILL = 1
        AND CASE 
            WHEN  SOURCE_OF_SALE='ON' AND LEFT(PRDCT.PAL2_CODE,1) in ('A','B','C','D','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','V','W','X','Y')
            THEN 1 
            WHEN SOURCE_OF_SALE<>'ON'
            THEN 1
            END =1
),

CUSTOMER_BRIDGE AS (
SELECT
    BILLING_KEY,
    INDIRECT_CUSTOMER_KEY,
    DIRECT_CORPORATION_KEY,
    INDIRECT_CORPORATION_KEY,
    END_CORPORATION_KEY,
    ADJUSTED_END_CORPORATION_KEY,
    REFERENCE_CORPORATION_KEY,
    PROCESS_DATE,
    INDIRECT_CUSTOMER_CODE,
    DIRECT_CORPORATION_CODE,
    INDIRECT_CORPORATION_CODE,
    END_CORPORATION_CODE,
    ADJUSTED_END_CORPORATION_CODE,
    REFERENCE_CORPORATION_CODE,
    END_CORPORATION_DEFINITION AS END_CORPORATION_DECODE
  FROM 
  {{ref('MART_SALES_BILLING_CUSTOMER_BRIDGE')}}
  WHERE PROCESS_DATE >= TRUNC(CURRENT_DATE - INTERVAL '5 YEAR','YEAR')
),

FINAL_BILLING_SQL AS (
SELECT
    FIS_WEEK.FISCAL_WEEK_KEY,--BILL.TRANSACTION_DATE_KEY,
    BILL.DIRECT_CUSTOMER_KEY,
    BRIDGE.INDIRECT_CUSTOMER_KEY,
    BILL.END_CUSTOMER_KEY,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.DIRECT_CORPORATION_KEY
        ELSE BRIDGE.DIRECT_CORPORATION_KEY
    END DIRECT_CORPORATION_KEY,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.DIRECT_CORPORATION_KEY
        ELSE BRIDGE.INDIRECT_CORPORATION_KEY
    END INDIRECT_CORPORATION_KEY,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.END_CORPORATION_KEY
        ELSE BRIDGE.END_CORPORATION_KEY
    END END_CORPORATION_KEY,
    --BRIDGE.ADJUSTED_END_CORPORATION_KEY,
    --BRIDGE.REFERENCE_CORPORATION_KEY,
    BILL.MARKET_PRODUCT_NUMBER_KEY,
    BILL.INTERNAL_PART_NUMBER_KEY,
    BILL.CUSTOMER_PART_NUMBER_KEY,

    --BILL.TRANSACTION_DATE,
    BILL.DIRECT_CUSTOMER_CODE,
    BRIDGE.INDIRECT_CUSTOMER_CODE,
    BILL.END_CUSTOMER_CODE,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.DIRECT_CORPORATION_CODE
        ELSE BRIDGE.DIRECT_CORPORATION_CODE
    END DIRECT_CORPORATION_CODE,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.DIRECT_CORPORATION_CODE
        ELSE BRIDGE.INDIRECT_CORPORATION_CODE
    END INDIRECT_CORPORATION_CODE,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.END_CORPORATION_CODE
        ELSE BRIDGE.END_CORPORATION_CODE
    END END_CORPORATION_CODE,
    --BRIDGE.ADJUSTED_END_CORPORATION_CODE,
    --BRIDGE.REFERENCE_CORPORATION_CODE,
    BILL.MARKET_PRODUCT_NUMBER,
    BILL.INTERNAL_PART_NUMBER,
    BILL.CUSTOMER_PART_NUMBER,
    BILL.TRANSACTION_CURRENCY_ISO_CODE,
    BILL.DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    BILL.DISTRIBUTOR_END_CUSTOMER_NAME,
    BILL.DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    BILL.DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    BILL.PRICE_CONTRACT,
    --BILL.DISTRIBUTOR_INVOICE_NUMBER,
    --BILL.DISTRIBUTOR_PO_NUMBER,
    BILL.SOURCE_OF_SALE,
    BILL.SOURCE_OF_DATA,
    BILL.ACTIVITY,
    BRIDGE.END_CORPORATION_DECODE,
    SUM(BILL.BILLING_NET_AMOUNT_USD) AS	COST_ADJUSTED_USD,
    SUM(BILL.BILLING_NET_AMOUNT_JPY) AS COST_ADJUSTED_JPY,
    SUM(BILL.BILLING_NET_AMOUNT_EUR) AS	COST_ADJUSTED_EUR,
    SUM(BILL.BILLING_NET_AMOUNT_USD) AS	COST_USD,
    SUM(BILL.BILLING_NET_AMOUNT_JPY) AS	COST_JPY,
    SUM(BILL.BILLING_NET_AMOUNT_EUR) AS	COST_EUR,
    SUM(DISTRIBUTOR_PRICE_USD) AS DISTRIBUTOR_PRICE_USD,
    SUM(LOCAL_AMOUNT) AS LOCAL_AMOUNT,
    SUM(BILL.BILLING_NET_AMOUNT_TRANSACTION_CURRENCY) AS LOCAL_COST_AMOUNT,
    SUM(LOCAL_DISTRIBUTOR_PRICE_AMOUNT)	AS LOCAL_DISTRIBUTOR_PRICE_AMOUNT,
    SUM(BILL.BILLING_NET_AMOUNT_USD) AS	RESALE_NET_USD,
    SUM(BILL.BILLING_NET_AMOUNT_JPY) AS	RESALE_NET_JPY,
    SUM(BILL.BILLING_NET_AMOUNT_EUR) AS	RESALE_NET_EUR,
    SUM(BILL.BILLING_NET_QUANTITY)	AS RESALE_QUANTITY,
    SUM(BILL.GROSS_AMOUNT_USD)	AS RESALE_GROSS_USD,
    SUM(BILL.GROSS_AMOUNT_JPY)AS RESALE_GROSS_JPY,
    SUM(BILL.GROSS_AMOUNT_EUR)AS RESALE_GROSS_EUR,
    SUM(BILL.GROSS_AMOUNT_TRANSACTION_CURRENCY)	AS LOCAL_GROSS_AMOUNT,
    SUM(BILL.BILLING_GROSS_QUANTITY) AS RESALE_GROSS_QUANTITY
FROM 
BILLING AS BILL
LEFT JOIN CUSTOMER_BRIDGE AS BRIDGE 
ON BILL.BILLING_KEY = BRIDGE.BILLING_KEY
INNER JOIN FISCAL_WEEK_VW FIS_WEEK 
 ON BILL.TRANSACTION_DATE = FIS_WEEK.CALENDAR_DATE
GROUP BY 
    FIS_WEEK.FISCAL_WEEK_KEY,--BILL.TRANSACTION_DATE_KEY,
    BILL.DIRECT_CUSTOMER_KEY,
    INDIRECT_CUSTOMER_KEY,
    BILL.END_CUSTOMER_KEY,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.DIRECT_CORPORATION_KEY
        ELSE BRIDGE.DIRECT_CORPORATION_KEY
    END ,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.DIRECT_CORPORATION_KEY
        ELSE BRIDGE.INDIRECT_CORPORATION_KEY
    END ,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.END_CORPORATION_KEY
        ELSE BRIDGE.END_CORPORATION_KEY
    END ,
    --ADJUSTED_END_CORPORATION_KEY,
    --REFERENCE_CORPORATION_KEY,
    BILL.MARKET_PRODUCT_NUMBER_KEY,
    BILL.INTERNAL_PART_NUMBER_KEY,
    BILL.CUSTOMER_PART_NUMBER_KEY,

    --BILL.TRANSACTION_DATE,
    BILL.DIRECT_CUSTOMER_CODE,
    INDIRECT_CUSTOMER_CODE,
    BILL.END_CUSTOMER_CODE,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.DIRECT_CORPORATION_CODE
        ELSE BRIDGE.DIRECT_CORPORATION_CODE
    END ,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.DIRECT_CORPORATION_CODE
        ELSE BRIDGE.INDIRECT_CORPORATION_CODE
    END ,
    CASE 
        WHEN BILL.SOURCE_OF_SALE <> 'ON' 
        Then BILL.END_CORPORATION_CODE
        ELSE BRIDGE.END_CORPORATION_CODE
    END ,
    --ADJUSTED_END_CORPORATION_CODE,
    --REFERENCE_CORPORATION_CODE,
    BILL.MARKET_PRODUCT_NUMBER,
    BILL.INTERNAL_PART_NUMBER,
    BILL.CUSTOMER_PART_NUMBER,
    BILL.TRANSACTION_CURRENCY_ISO_CODE,
    BILL.DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    BILL.DISTRIBUTOR_END_CUSTOMER_NAME,
    BILL.DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    BILL.DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    BILL.PRICE_CONTRACT,
    --BILL.DISTRIBUTOR_INVOICE_NUMBER,
    --BILL.DISTRIBUTOR_PO_NUMBER,
    BILL.SOURCE_OF_SALE,
    BILL.SOURCE_OF_DATA,
    BILL.ACTIVITY,
    END_CORPORATION_DECODE
),
------------------------------------------ POS ------------------------------------------------------------------------------------

POS_FACT AS 
(  
SELECT 
    TRANSACTION_KEY,
    FISCAL_SHIP_DATE_KEY AS TRANSACTION_DATE_KEY,
    DIRECT_CUSTOMER_KEY,
    INDIRECT_CUSTOMER_KEY,
    END_CUSTOMER_KEY,
    DIRECT_CORPORATION_KEY,
    INDIRECT_CORPORATION_KEY,
    END_CORPORATION_KEY,
    MARKET_PRODUCT_NUMBER_KEY ,
    INTERNAL_PART_NUMBER_KEY,
    MD5('-1') AS CUSTOMER_PART_NUMBER_KEY,
    ----------------CODE --------------------------------
    TRANSACTION_ID,
    FISCAL_SHIP_DATE AS TRANSACTION_DATE,
    DIRECT_CUSTOMER_CODE,
    INDIRECT_CUSTOMER_CODE,
    END_CUSTOMER_CODE,
    DIRECT_CORPORATION_CODE,
    INDIRECT_CORPORATION_CODE,
    END_CORPORATION_CODE,    
    MARKET_PRODUCT_NUMBER,
    INTERNAL_PART_NUMBER,  
    NULL AS CUSTOMER_PART_NUMBER,

    --------------- OTHER ATTRIBUTES ---------------
    TRANSACTION_CURRENCY_ISO_CODE,
    DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    DISTRIBUTOR_END_CUSTOMER_NAME,
    DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    NULL AS PRICE_CONTRACT,
    DISTRIBUTOR_INVOICE_NUMBER,
    DISTRIBUTOR_PO_NUMBER,
    'ON' AS SOURCE_OF_SALE,
    SOURCE_DATA_FROM AS SOURCE_OF_DATA,
    'POS' AS ACTIVITY,
    END_CORPORATION_DECODE,
    DISTRIBUTOR_COST_AMOUNT_USD * 0.97 AS COST_ADJUSTED_USD, 
    DISTRIBUTOR_COST_AMOUNT_EUR * 0.97 AS COST_ADJUSTED_EUR,
    DISTRIBUTOR_COST_AMOUNT_JPY * 0.97 AS COST_ADJUSTED_JPY,
    DISTRIBUTOR_COST_AMOUNT_USD AS COST_USD,
    DISTRIBUTOR_COST_AMOUNT_EUR AS COST_EUR,
    DISTRIBUTOR_COST_AMOUNT_JPY AS COST_JPY,
    RESALE_NET_AMOUNT_USD AS DISTRIBUTOR_PRICE_USD,
    RESALE_NET_AMOUNT AS LOCAL_AMOUNT,
    DISTRIBUTOR_COST_AMOUNT AS LOCAL_COST_AMOUNT,
    RESALE_NET_AMOUNT AS LOCAL_DISTRIBUTOR_PRICE_AMOUNT,
    RESALE_NET_AMOUNT_USD AS RESALE_NET_USD,
    RESALE_NET_AMOUNT_EUR AS RESALE_NET_EUR,
    RESALE_NET_AMOUNT_JPY AS RESALE_NET_JPY,
    RESALE_QUANTITY,
    NULL AS RESALE_GROSS_USD,
    NULL AS RESALE_GROSS_JPY,
    NULL AS RESALE_GROSS_EUR,
    NULL AS LOCAL_GROSS_AMOUNT,
    NULL AS RESALE_GROSS_QUANTITY    
FROM {{ref('MART_SALES_POINT_OF_SALES_FACT')}} POS
WHERE BIW_LOGICAL_DELETE_FLAG ='N'
AND IS_SDM_TRUE_POS = 1
AND  FISCAL_SHIP_DATE >= TRUNC(CURRENT_DATE - INTERVAL '5 YEAR','YEAR')
),

POS_BRIDGE AS (
    SELECT 
        TRANSACTION_KEY,
        FISCAL_SHIP_DATE_KEY,
        ADJUSTED_END_CORPORATION_KEY,
        REFERENCE_CORPORATION_KEY,
        ADJUSTED_END_CORPORATION_CODE,
        REFERENCE_CORPORATION_CODE
    FROM {{ref('MART_SALES_POINT_OF_SALES_CUSTOMER_BRIDGE')}} BRIDGE
    WHERE FISCAL_SHIP_DATE >= TRUNC(CURRENT_DATE - INTERVAL '5 YEAR','YEAR')
),

FINAL_POS_SQL AS
(SELECT 
    FIS_WEEK.FISCAL_WEEK_KEY,--POS.TRANSACTION_DATE_KEY,
    POS.DIRECT_CUSTOMER_KEY,
    POS.INDIRECT_CUSTOMER_KEY,
    POS.END_CUSTOMER_KEY,
    POS.DIRECT_CORPORATION_KEY,
    POS.INDIRECT_CORPORATION_KEY,
    POS.END_CORPORATION_KEY,
    --P_BRIDGE.ADJUSTED_END_CORPORATION_KEY,
    --P_BRIDGE.REFERENCE_CORPORATION_KEY,
    POS.MARKET_PRODUCT_NUMBER_KEY ,
    POS.INTERNAL_PART_NUMBER_KEY,
    POS.CUSTOMER_PART_NUMBER_KEY,
    --POS.TRANSACTION_DATE,
    POS.DIRECT_CUSTOMER_CODE,
    POS.INDIRECT_CUSTOMER_CODE,
    POS.END_CUSTOMER_CODE,
    POS.DIRECT_CORPORATION_CODE,
    POS.INDIRECT_CORPORATION_CODE,
    POS.END_CORPORATION_CODE,
    --P_BRIDGE.ADJUSTED_END_CORPORATION_CODE,
    --P_BRIDGE.REFERENCE_CORPORATION_CODE,
    POS.MARKET_PRODUCT_NUMBER,
    POS.INTERNAL_PART_NUMBER,  
    POS.CUSTOMER_PART_NUMBER,
    POS.TRANSACTION_CURRENCY_ISO_CODE,
    POS.DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    POS.DISTRIBUTOR_END_CUSTOMER_NAME,
    POS.DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    POS.DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    POS.PRICE_CONTRACT,
    --POS.DISTRIBUTOR_INVOICE_NUMBER,
    --POS.DISTRIBUTOR_PO_NUMBER,
    POS.SOURCE_OF_SALE,
    POS.SOURCE_OF_DATA,
    POS.ACTIVITY,
    POS.END_CORPORATION_DECODE,
    SUM(POS.COST_ADJUSTED_USD) AS COST_ADJUSTED_USD, 
    SUM(POS.COST_ADJUSTED_EUR) AS COST_ADJUSTED_EUR,
    SUM(POS.COST_ADJUSTED_JPY) AS COST_ADJUSTED_JPY,   
    SUM(POS.COST_USD) AS COST_USD,  
    SUM(POS.COST_EUR) AS COST_EUR,  
    SUM(POS.COST_JPY) AS COST_JPY,  
    SUM(POS.DISTRIBUTOR_PRICE_USD) AS DISTRIBUTOR_PRICE_USD,  
    SUM(POS.LOCAL_AMOUNT) AS LOCAL_AMOUNT,  
    SUM(POS.LOCAL_COST_AMOUNT) AS LOCAL_COST_AMOUNT,  
    SUM(POS.LOCAL_DISTRIBUTOR_PRICE_AMOUNT) AS LOCAL_DISTRIBUTOR_PRICE_AMOUNT,  
    SUM(POS.RESALE_NET_USD) AS RESALE_NET_USD,  
    SUM(POS.RESALE_NET_EUR) AS RESALE_NET_EUR,  
    SUM(POS.RESALE_NET_JPY) AS RESALE_NET_JPY,  
    SUM(POS.RESALE_QUANTITY) AS RESALE_QUANTITY,  
    SUM(POS.RESALE_GROSS_USD) AS RESALE_GROSS_USD,  
    SUM(POS.RESALE_GROSS_JPY) AS RESALE_GROSS_JPY,  
    SUM(POS.RESALE_GROSS_EUR) AS RESALE_GROSS_EUR,  
    SUM(POS.LOCAL_GROSS_AMOUNT) AS LOCAL_GROSS_AMOUNT,  
    SUM(POS.RESALE_GROSS_QUANTITY) AS RESALE_GROSS_QUANTITY
FROM  POS_FACT AS POS
LEFT JOIN POS_BRIDGE P_BRIDGE
    ON POS.TRANSACTION_KEY = P_BRIDGE.TRANSACTION_KEY
INNER JOIN FISCAL_WEEK_VW FIS_WEEK 
 ON POS.TRANSACTION_DATE = FIS_WEEK.CALENDAR_DATE 
GROUP BY 
    FIS_WEEK.FISCAL_WEEK_KEY,--POS.TRANSACTION_DATE_KEY,
    POS.DIRECT_CUSTOMER_KEY,
    POS.INDIRECT_CUSTOMER_KEY,
    POS.END_CUSTOMER_KEY,
    POS.DIRECT_CORPORATION_KEY,
    POS.INDIRECT_CORPORATION_KEY,
    POS.END_CORPORATION_KEY,
    --P_BRIDGE.ADJUSTED_END_CORPORATION_KEY,
    --P_BRIDGE.REFERENCE_CORPORATION_KEY,
    POS.MARKET_PRODUCT_NUMBER_KEY ,
    POS.INTERNAL_PART_NUMBER_KEY,
    POS.CUSTOMER_PART_NUMBER_KEY,
    --POS.TRANSACTION_DATE,
    POS.DIRECT_CUSTOMER_CODE,
    POS.INDIRECT_CUSTOMER_CODE,
    POS.END_CUSTOMER_CODE,
    POS.DIRECT_CORPORATION_CODE,
    POS.INDIRECT_CORPORATION_CODE,
    POS.END_CORPORATION_CODE,
    --P_BRIDGE.ADJUSTED_END_CORPORATION_CODE,
    --P_BRIDGE.REFERENCE_CORPORATION_CODE,
    POS.MARKET_PRODUCT_NUMBER,
    POS.INTERNAL_PART_NUMBER,  
    POS.CUSTOMER_PART_NUMBER,
    POS.TRANSACTION_CURRENCY_ISO_CODE,
    POS.DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    POS.DISTRIBUTOR_END_CUSTOMER_NAME,
    POS.DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    POS.DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    POS.PRICE_CONTRACT,
    --POS.DISTRIBUTOR_INVOICE_NUMBER,
    --POS.DISTRIBUTOR_PO_NUMBER,
    POS.SOURCE_OF_SALE,
    POS.SOURCE_OF_DATA,
    POS.ACTIVITY,
    POS.END_CORPORATION_DECODE
)

SELECT FISCAL_WEEK_KEY ,DIRECT_CUSTOMER_KEY ,INDIRECT_CUSTOMER_KEY ,END_CUSTOMER_KEY
,DIRECT_CORPORATION_KEY ,INDIRECT_CORPORATION_KEY ,END_CORPORATION_KEY,MARKET_PRODUCT_NUMBER_KEY ,INTERNAL_PART_NUMBER_KEY ,CUSTOMER_PART_NUMBER_KEY --,TRANSACTION_DATE
,DIRECT_CUSTOMER_CODE ,INDIRECT_CUSTOMER_CODE ,END_CUSTOMER_CODE ,DIRECT_CORPORATION_CODE ,INDIRECT_CORPORATION_CODE
,END_CORPORATION_CODE ,MARKET_PRODUCT_NUMBER
,INTERNAL_PART_NUMBER ,CUSTOMER_PART_NUMBER ,TRANSACTION_CURRENCY_ISO_CODE 
,DISTRIBUTOR_END_CUSTOMER_IDENTIFIER, DISTRIBUTOR_END_CUSTOMER_NAME ,DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER ,DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME
,PRICE_CONTRACT ,SOURCE_OF_SALE ,SOURCE_OF_DATA ,ACTIVITY
,END_CORPORATION_DECODE ,COST_ADJUSTED_USD ,COST_ADJUSTED_JPY ,COST_ADJUSTED_EUR ,COST_USD ,COST_JPY ,COST_EUR
,DISTRIBUTOR_PRICE_USD ,LOCAL_AMOUNT ,LOCAL_COST_AMOUNT ,LOCAL_DISTRIBUTOR_PRICE_AMOUNT ,RESALE_NET_USD ,RESALE_NET_JPY
,RESALE_NET_EUR ,RESALE_QUANTITY ,RESALE_GROSS_USD ,RESALE_GROSS_JPY ,RESALE_GROSS_EUR ,LOCAL_GROSS_AMOUNT
,RESALE_GROSS_QUANTITY
 FROM FINAL_BILLING_SQL
UNION ALL
SELECT FISCAL_WEEK_KEY ,DIRECT_CUSTOMER_KEY ,INDIRECT_CUSTOMER_KEY ,END_CUSTOMER_KEY
,DIRECT_CORPORATION_KEY ,INDIRECT_CORPORATION_KEY ,END_CORPORATION_KEY --,ADJUSTED_END_CORPORATION_KEY
--,REFERENCE_CORPORATION_KEY 
,MARKET_PRODUCT_NUMBER_KEY ,INTERNAL_PART_NUMBER_KEY ,CUSTOMER_PART_NUMBER_KEY --,TRANSACTION_DATE
,DIRECT_CUSTOMER_CODE ,INDIRECT_CUSTOMER_CODE ,END_CUSTOMER_CODE ,DIRECT_CORPORATION_CODE ,INDIRECT_CORPORATION_CODE
,END_CORPORATION_CODE --,ADJUSTED_END_CORPORATION_CODE ,REFERENCE_CORPORATION_CODE 
,MARKET_PRODUCT_NUMBER ,INTERNAL_PART_NUMBER ,CUSTOMER_PART_NUMBER ,TRANSACTION_CURRENCY_ISO_CODE 
,DISTRIBUTOR_END_CUSTOMER_IDENTIFIER, DISTRIBUTOR_END_CUSTOMER_NAME ,DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER ,DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME
,PRICE_CONTRACT ,SOURCE_OF_SALE ,SOURCE_OF_DATA ,ACTIVITY
,END_CORPORATION_DECODE ,COST_ADJUSTED_USD ,COST_ADJUSTED_JPY ,COST_ADJUSTED_EUR ,COST_USD ,COST_JPY ,COST_EUR
,DISTRIBUTOR_PRICE_USD ,LOCAL_AMOUNT ,LOCAL_COST_AMOUNT ,LOCAL_DISTRIBUTOR_PRICE_AMOUNT ,RESALE_NET_USD ,RESALE_NET_JPY
,RESALE_NET_EUR ,RESALE_QUANTITY ,RESALE_GROSS_USD ,RESALE_GROSS_JPY ,RESALE_GROSS_EUR ,LOCAL_GROSS_AMOUNT
,RESALE_GROSS_QUANTITY FROM FINAL_POS_SQL