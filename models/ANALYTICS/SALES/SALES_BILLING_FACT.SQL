{{ config(
  description = 'Billing Fact view for Sales Analytics Team', 
  materialized = 'view', 
  schema = 'SALES', 
  tags = 'MART_SALES',
  alias = 'BILLING_FACT'
) }} 

WITH 
BILLING AS (
SELECT
  BILLING_KEY,
  BILLING_DATE_KEY,
  DIRECT_CUSTOMER_KEY,
  INTERNAL_PART_NUMBER_KEY,
  MARKET_PRODUCT_NUMBER_KEY,
  DIRECT_CUSTOMER_CODE,
  INTERNAL_PART_NUMBER,
  MARKET_PRODUCT_NUMBER,
  DIRECT_CORPORATION_KEY,
  DIRECT_CORPORATION_CODE,
  END_CORPORATION_KEY,
  END_CORPORATION_CODE,
  PROCESS_DATE,
  SOURCE_OF_SALE,
  SALES_ORDER_NUMBER,
  SALES_ITEM_NUMBER,
  SALES_DELIVERY_NUMBER,
  REGION,
  ORDER_TYPE,
  HANDLING_CODE,
  CUSTOMER_PART_NUMBER,
  CUSTOMER_PA_NUMBER,
  END_CUSTOMER_CODE,
  DIST_END_CUSTOMER_CODE,
  INDIRECT_CUSTOMER_CODE,
  REQUESTED_DATE,
  ORIGINAL_SCHEDULED_SHIP_DATE,
  SCHEDULED_SHIPPED_DATE,
  EARLIEST_POSSIBLE_SHIP_DATE,
  PLANNED_DELIVERY_DATE,
  RESCHEDULED_DELIVERY_DATE,
  REQUESTED_SHIP_DATE,
  ENTRY_DATE,
  CUSTOMER_OF_INTEREST,
  IS_NNCO,
  NNCO_AGREEMENT_TYPE,
  ODM_END_CORP_CODE,
  BILL_TO_COUNTRY,
  BILL_TO_CUST_CODE,
  SUB_CORP_CODE,
  SHIP_FROM_AREA,
  CUSTOMER_PO_NUMBER,
  QUOTE_ID,
  OPERATING_UNIT,
  ITEM_STATUS,
  IS_REVERSAL_REQUIRED,
  ACTIVITY,
  BOOKING_CATEGORY,
  BILL_SOURCE_CODE,
  BUSINESS_CLASS_CODE,
  CREDIT_REASON_CODE,
  CREDIT_CODE_DESCRIPTION,
  PRICE_SOURCE,
  GL_POSTED_DATE,
  TRANSACTION_DATE,
  CUSTOMER_TRX_ID,
  CUSTOMER_TRX_LINE_ID,
  OBR_TRX_ID,
  TRX_LINE_NUMBER,
  BILLING_DOCUMENT_NUMBER,
  ORIGINAL_DOCUMENT_NUMBER,
  IS_TRUE_BILL,
  GL_REVENUE_ACCOUNT,
  ACCRUAL_CATEGORY,
  JOURNAL_DESCRIPTION,
  LEDGER,
  DEBIT_ACCOUNT,
  CREDIT_ACCOUNT,
  ACCRUAL_RULE_SET,
  ACCRUAL_RULE_ID,
  ACCRUAL_COMMENTS,
  ACCRUAL_TYPE,
  ACCRUAL_FACTOR,
  ACCRUAL_TRANSACTION_DATE,
  IS_ACCRUAL_DSA,
  IS_ACCRUAL_DCD,
  IS_ACCRUAL_REB,
  IS_ACCRUAL_DSC,
  IS_ACCRUAL_REVERSAL,
  IS_QUANTITY_OVERRIDE,
  TRANSACTION_CURRENCY_ISO_CODE,
  CONTRACT_CURRENCY,
  BILLING_GROSS_QUANTITY,
  BILLING_NET_QUANTITY,
  UNIT_PRICE_USD,
  UNIT_PRICE_EUR,
  UNIT_PRICE_JPY,
  UNIT_PRICE_TRANSACTION_CURRENCY,
  GROSS_AMOUNT_EUR,
  GROSS_AMOUNT_JPY,
  GROSS_AMOUNT_USD,
  GROSS_AMOUNT_TRANSACTION_CURRENCY,
  GROSS_AMOUNT_CONTRACT_CURRENCY,
  BILLING_NET_AMOUNT_EUR,
  BILLING_NET_AMOUNT_JPY,
  BILLING_NET_AMOUNT_USD,
  BILLING_NET_AMOUNT_TRANSACTION_CURRENCY,
  BILLING_NET_AMOUNT_CONTRACT_CURRENCY,
  ACCRUAL_AMOUNT_USD,
  ACCRUAL_AMOUNT_TRANSACTION_CURRENCY,
  ACCRUAL_AMOUNT_CONTRACT_CURRENCY,
  DW_CREATE_DT,
  BILL.BIW_INS_DTTM,
  BILL.BIW_UPD_DTTM,
  BILL.BIW_BATCH_ID
FROM {{ref('MART_SALES_BILLING_FACT')}} BILL
--NOV-23 KALI D: SDM SPECIFIC LOGIC, REQUESTED FROM SHAN AND YING
  LEFT JOIN {{ref('SALES_PRODUCT')}} PRDCT 
    ON BILL.INTERNAL_PART_NUMBER_KEY=PRDCT.PART_KEY
WHERE  
  CASE 
    WHEN  SOURCE_OF_SALE='ON' AND LEFT(PRDCT.PAL2_CODE,1) in ('A','B','C','D','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','V','W','X','Y')
      THEN 1 
    WHEN SOURCE_OF_SALE<>'ON'
      THEN 1
  END =1
)
,CUSTOMER_BRIDGE AS (
SELECT
  BILLING_KEY,
  INDIRECT_CUSTOMER_KEY,
  DIRECT_CORPORATION_KEY,
  INDIRECT_CORPORATION_KEY,
  END_CORPORATION_KEY,
  ADJUSTED_END_CORPORATION_KEY,
  REFERENCE_CORPORATION_KEY,
  INDIRECT_CUSTOMER_CODE,
  DIRECT_CORPORATION_CODE,
  INDIRECT_CORPORATION_CODE,
  END_CORPORATION_CODE,
  ADJUSTED_END_CORPORATION_CODE,
  REFERENCE_CORPORATION_CODE,
  END_CORPORATION_DEFINITION
  FROM 
  {{ref('MART_SALES_BILLING_CUSTOMER_BRIDGE')}}
  )
  
  SELECT
  BILL.BILLING_KEY,
  BILL.BILLING_DATE_KEY,
  BILL.DIRECT_CUSTOMER_KEY,
  BRIDGE.INDIRECT_CUSTOMER_KEY,
  CASE 
    WHEN BILL.SOURCE_OF_SALE <> 'ON' 
      Then BILL.DIRECT_CORPORATION_KEY
    ELSE BRIDGE.DIRECT_CORPORATION_KEY
  END DIRECT_CORPORATION_KEY,
   CASE 
    WHEN BILL.SOURCE_OF_SALE <> 'ON' 
      Then BILL.DIRECT_CORPORATION_KEY
    ELSE BRIDGE.INDIRECT_CORPORATION_KEY
  END INDIRECT_CORPORATION_KEY,
  CASE 
    WHEN BILL.SOURCE_OF_SALE <> 'ON' 
      Then BILL.END_CORPORATION_KEY
    ELSE BRIDGE.END_CORPORATION_KEY
  END END_CORPORATION_KEY,
  BRIDGE.ADJUSTED_END_CORPORATION_KEY,
  BRIDGE.REFERENCE_CORPORATION_KEY,
  BILL.INTERNAL_PART_NUMBER_KEY,
  BILL.MARKET_PRODUCT_NUMBER_KEY,
  BILL.DIRECT_CUSTOMER_CODE,
  BRIDGE.INDIRECT_CUSTOMER_CODE,
    CASE 
    WHEN BILL.SOURCE_OF_SALE <> 'ON' 
      Then BILL.DIRECT_CORPORATION_CODE
    ELSE BRIDGE.DIRECT_CORPORATION_CODE
  END DIRECT_CORPORATION_CODE,
    CASE 
    WHEN BILL.SOURCE_OF_SALE <> 'ON' 
      Then BILL.DIRECT_CORPORATION_CODE
    ELSE BRIDGE.INDIRECT_CORPORATION_CODE
  END INDIRECT_CORPORATION_CODE,
    CASE 
    WHEN BILL.SOURCE_OF_SALE <> 'ON' 
      Then BILL.END_CORPORATION_CODE
    ELSE BRIDGE.END_CORPORATION_CODE
  END END_CORPORATION_CODE,
  BRIDGE.ADJUSTED_END_CORPORATION_CODE,
  BRIDGE.REFERENCE_CORPORATION_CODE,
  BILL.INTERNAL_PART_NUMBER,
  BILL.MARKET_PRODUCT_NUMBER,
  BRIDGE.END_CORPORATION_DEFINITION,
  BILL.PROCESS_DATE,
  BILL.SOURCE_OF_SALE,
  BILL.SALES_ORDER_NUMBER,
  BILL.SALES_ITEM_NUMBER,
  BILL.SALES_DELIVERY_NUMBER,
  BILL.REGION,
  BILL.ORDER_TYPE,
  BILL.HANDLING_CODE,
  BILL.CUSTOMER_PART_NUMBER,
  BILL.CUSTOMER_PA_NUMBER,
  BILL.END_CUSTOMER_CODE,
  BILL.DIST_END_CUSTOMER_CODE,
  BILL.REQUESTED_DATE,
  BILL.ORIGINAL_SCHEDULED_SHIP_DATE,
  BILL.SCHEDULED_SHIPPED_DATE,
  BILL.EARLIEST_POSSIBLE_SHIP_DATE,
  BILL.PLANNED_DELIVERY_DATE,
  BILL.RESCHEDULED_DELIVERY_DATE,
  BILL.REQUESTED_SHIP_DATE,
  BILL.ENTRY_DATE,
  BILL.CUSTOMER_OF_INTEREST,
  BILL.IS_NNCO,
  BILL.NNCO_AGREEMENT_TYPE,
  BILL.ODM_END_CORP_CODE,
  BILL.BILL_TO_COUNTRY,
  BILL.BILL_TO_CUST_CODE,
  BILL.SUB_CORP_CODE,
  BILL.SHIP_FROM_AREA,
  BILL.CUSTOMER_PO_NUMBER,
  BILL.QUOTE_ID,
  BILL.OPERATING_UNIT,
  BILL.ITEM_STATUS,
  BILL.IS_REVERSAL_REQUIRED,
  BILL.ACTIVITY,
  BILL.BOOKING_CATEGORY,
  BILL.BILL_SOURCE_CODE,
  BILL.BUSINESS_CLASS_CODE,
  BILL.CREDIT_REASON_CODE,
  BILL.CREDIT_CODE_DESCRIPTION,
  BILL.PRICE_SOURCE,
  BILL.GL_POSTED_DATE,
  BILL.TRANSACTION_DATE,
  BILL.CUSTOMER_TRX_ID,
  BILL.CUSTOMER_TRX_LINE_ID,
  BILL.OBR_TRX_ID,
  BILL.TRX_LINE_NUMBER,
  BILL.BILLING_DOCUMENT_NUMBER,
  BILL.ORIGINAL_DOCUMENT_NUMBER,
  BILL.IS_TRUE_BILL,
  BILL.GL_REVENUE_ACCOUNT,
  BILL.ACCRUAL_CATEGORY,
  BILL.JOURNAL_DESCRIPTION,
  BILL.LEDGER,
  BILL.DEBIT_ACCOUNT,
  BILL.CREDIT_ACCOUNT,
  BILL.ACCRUAL_RULE_SET,
  BILL.ACCRUAL_RULE_ID,
  BILL.ACCRUAL_COMMENTS,
  BILL.ACCRUAL_TYPE,
  BILL.ACCRUAL_FACTOR,
  BILL.ACCRUAL_TRANSACTION_DATE,
  BILL.IS_ACCRUAL_DSA,
  BILL.IS_ACCRUAL_DCD,
  BILL.IS_ACCRUAL_REB,
  BILL.IS_ACCRUAL_DSC,
  BILL.IS_ACCRUAL_REVERSAL,
  BILL.IS_QUANTITY_OVERRIDE,
  BILL.TRANSACTION_CURRENCY_ISO_CODE,
  BILL.CONTRACT_CURRENCY,
  BILL.BILLING_GROSS_QUANTITY,
  BILL.BILLING_NET_QUANTITY,
  BILL.UNIT_PRICE_USD,
  BILL.UNIT_PRICE_EUR,
  BILL.UNIT_PRICE_JPY,
  BILL.UNIT_PRICE_TRANSACTION_CURRENCY,
  BILL.GROSS_AMOUNT_EUR,
  BILL.GROSS_AMOUNT_JPY,
  BILL.GROSS_AMOUNT_USD,
  BILL.GROSS_AMOUNT_TRANSACTION_CURRENCY,
  BILL.GROSS_AMOUNT_CONTRACT_CURRENCY,
  BILL.BILLING_NET_AMOUNT_EUR,
  BILL.BILLING_NET_AMOUNT_JPY,
  BILL.BILLING_NET_AMOUNT_USD,
  BILL.BILLING_NET_AMOUNT_TRANSACTION_CURRENCY,
  BILL.BILLING_NET_AMOUNT_CONTRACT_CURRENCY,
  BILL.ACCRUAL_AMOUNT_USD,
  BILL.ACCRUAL_AMOUNT_TRANSACTION_CURRENCY,
  BILL.ACCRUAL_AMOUNT_CONTRACT_CURRENCY,
  BILL.DW_CREATE_DT,
  BILL.BIW_INS_DTTM,
  BILL.BIW_UPD_DTTM,
  BILL.BIW_BATCH_ID
FROM 
BILLING AS BILL
LEFT JOIN CUSTOMER_BRIDGE AS BRIDGE 
ON BILL. BILLING_KEY = BRIDGE.BILLING_KEY