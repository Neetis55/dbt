{{
    config(
         description = 'END_CUSTOMER_CONSUMPTION_FACT_QUARTERLY view for Sales Analytics Team'
        ,materialized='view'
        ,schema ='SALES'
        ,tags ='MART_SALES'
        ,alias='END_CUSTOMER_CONSUMPTION_FACT_QUARTERLY'
        )
}}
WITH ECCQUARTERLY AS (
  SELECT
    FISCAL_WEEK_KEY,
    COST_ADJUSTED_USD,
    COST_ADJUSTED_JPY,
    COST_ADJUSTED_EUR,
    COST_USD,
    COST_JPY,
    COST_EUR,
    DISTRIBUTOR_PRICE_USD,
    LOCAL_AMOUNT,
    LOCAL_COST_AMOUNT,
    LOCAL_DISTRIBUTOR_PRICE_AMOUNT,
    RESALE_NET_USD,
    RESALE_NET_JPY,
    RESALE_NET_EUR,
    RESALE_QUANTITY,
    RESALE_GROSS_USD,
    RESALE_GROSS_JPY,
    RESALE_GROSS_EUR,
    LOCAL_GROSS_AMOUNT,
    RESALE_GROSS_QUANTITY,  
    DIRECT_CUSTOMER_KEY,
    INDIRECT_CUSTOMER_KEY,
    END_CUSTOMER_KEY,
    DIRECT_CORPORATION_KEY,
    INDIRECT_CORPORATION_KEY,
    END_CORPORATION_KEY,
    --ADJUSTED_END_CORPORATION_KEY,
    --REFERENCE_CORPORATION_KEY,
    --  MARKET_PRODUCT_NUMBER_KEY,
    --  INTERNAL_PART_NUMBER_KEY,
    CUSTOMER_PART_NUMBER_KEY,
    DIRECT_CUSTOMER_CODE,
    INDIRECT_CUSTOMER_CODE,
    END_CUSTOMER_CODE,
    DIRECT_CORPORATION_CODE,
    INDIRECT_CORPORATION_CODE,
    END_CORPORATION_CODE,
    --ADJUSTED_END_CORPORATION_CODE,
    --REFERENCE_CORPORATION_CODE,
    MARKET_PRODUCT_NUMBER,
    INTERNAL_PART_NUMBER,
    CUSTOMER_PART_NUMBER,
    TRANSACTION_CURRENCY_ISO_CODE,
    DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    DISTRIBUTOR_END_CUSTOMER_NAME,
    DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    PRICE_CONTRACT,
    SOURCE_OF_SALE,
    SOURCE_OF_DATA,
    ACTIVITY,
    END_CORPORATION_DECODE
  FROM 
    {{ref ('SALES_END_CUSTOMER_CONSUMPTION_WEEKLY_FACT')}}
),

WEEKINQUARTER AS (
  SELECT
    FISCAL_WEEK_KEY,
    FISCAL_QUARTER
  FROM 
  {{source('ENTERPRISE','FISCAL_WEEK')}}
)

  SELECT
    SUM(ECCQTR.COST_ADJUSTED_USD) AS COST_ADJUSTED_USD,
    SUM(ECCQTR.COST_ADJUSTED_JPY) AS COST_ADJUSTED_JPY,
    SUM(ECCQTR.COST_ADJUSTED_EUR) AS COST_ADJUSTED_EUR,
    SUM(ECCQTR.COST_USD) AS COST_USD,
    SUM(ECCQTR.COST_JPY) AS COST_JPY,
    SUM(ECCQTR.COST_EUR) AS COST_EUR,
    SUM(ECCQTR.DISTRIBUTOR_PRICE_USD) AS DISTRIBUTOR_PRICE_USD,
    SUM(ECCQTR.LOCAL_AMOUNT) AS LOCAL_AMOUNT,
    SUM(ECCQTR.LOCAL_COST_AMOUNT) AS LOCAL_COST_AMOUNT,
    SUM(ECCQTR.LOCAL_DISTRIBUTOR_PRICE_AMOUNT) AS LOCAL_DISTRIBUTOR_PRICE_AMOUNT,
    SUM(ECCQTR.RESALE_NET_USD) AS RESALE_NET_USD,
    SUM(ECCQTR.RESALE_NET_JPY) AS RESALE_NET_JPY,
    SUM(ECCQTR.RESALE_NET_EUR) AS RESALE_NET_EUR,
    SUM(ECCQTR.RESALE_QUANTITY) AS RESALE_QUANTITY,
    SUM(ECCQTR.RESALE_GROSS_USD) AS RESALE_GROSS_USD,
    SUM(ECCQTR.RESALE_GROSS_JPY) AS RESALE_GROSS_JPY,
    SUM(ECCQTR.RESALE_GROSS_EUR) AS RESALE_GROSS_EUR,
    SUM(ECCQTR.LOCAL_GROSS_AMOUNT) AS LOCAL_GROSS_AMOUNT,
    SUM(ECCQTR.RESALE_GROSS_QUANTITY) AS RESALE_GROSS_QUANTITY,  
    WEERKQTR.FISCAL_QUARTER,
    ECCQTR.DIRECT_CUSTOMER_KEY,
    ECCQTR.INDIRECT_CUSTOMER_KEY,
    ECCQTR.END_CUSTOMER_KEY,
    ECCQTR.DIRECT_CORPORATION_KEY,
    ECCQTR.INDIRECT_CORPORATION_KEY,
    ECCQTR.END_CORPORATION_KEY,
    --ECCQTR.ADJUSTED_END_CORPORATION_KEY,
    --ECCQTR.REFERENCE_CORPORATION_KEY,
    --  ECCQTR.MARKET_PRODUCT_NUMBER_KEY,
    --  ECCQTR.INTERNAL_PART_NUMBER_KEY,
    ECCQTR.CUSTOMER_PART_NUMBER_KEY,
    ECCQTR.DIRECT_CUSTOMER_CODE,
    ECCQTR.INDIRECT_CUSTOMER_CODE,
    ECCQTR.END_CUSTOMER_CODE,
    ECCQTR.DIRECT_CORPORATION_CODE,
    ECCQTR.INDIRECT_CORPORATION_CODE,
    ECCQTR.END_CORPORATION_CODE,
    --ECCQTR.ADJUSTED_END_CORPORATION_CODE,
    --ECCQTR.REFERENCE_CORPORATION_CODE,
    ECCQTR.MARKET_PRODUCT_NUMBER,
    ECCQTR.INTERNAL_PART_NUMBER,
    ECCQTR.CUSTOMER_PART_NUMBER,
    ECCQTR.TRANSACTION_CURRENCY_ISO_CODE,
    ECCQTR.DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    ECCQTR.DISTRIBUTOR_END_CUSTOMER_NAME,
    ECCQTR.DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    ECCQTR.DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    ECCQTR.PRICE_CONTRACT,
    ECCQTR.SOURCE_OF_SALE,
    ECCQTR.SOURCE_OF_DATA,
    ECCQTR.ACTIVITY,
    ECCQTR.END_CORPORATION_DECODE
  FROM ECCQUARTERLY ECCQTR
  JOIN WEEKINQUARTER AS WEERKQTR 
  ON ECCQTR.FISCAL_WEEK_KEY = WEERKQTR.FISCAL_WEEK_KEY
  WHERE 
    ECCQTR.SOURCE_OF_SALE IN ('ON')
  GROUP BY 
    WEERKQTR.FISCAL_QUARTER,
    ECCQTR.DIRECT_CUSTOMER_KEY,
    ECCQTR.INDIRECT_CUSTOMER_KEY,
    ECCQTR.END_CUSTOMER_KEY,
    ECCQTR.DIRECT_CORPORATION_KEY,
    ECCQTR.INDIRECT_CORPORATION_KEY,
    ECCQTR.END_CORPORATION_KEY,
    --ECCQTR.ADJUSTED_END_CORPORATION_KEY,
    --ECCQTR.REFERENCE_CORPORATION_KEY,
    --  ECCQTR.MARKET_PRODUCT_NUMBER_KEY,
    --  ECCQTR.INTERNAL_PART_NUMBER_KEY,
    ECCQTR.CUSTOMER_PART_NUMBER_KEY,
    ECCQTR.DIRECT_CUSTOMER_CODE,
    ECCQTR.INDIRECT_CUSTOMER_CODE,
    ECCQTR.END_CUSTOMER_CODE,
    ECCQTR.DIRECT_CORPORATION_CODE,
    ECCQTR.INDIRECT_CORPORATION_CODE,
    ECCQTR.END_CORPORATION_CODE,
    --ECCQTR.ADJUSTED_END_CORPORATION_CODE,
    --ECCQTR.REFERENCE_CORPORATION_CODE,
    ECCQTR.MARKET_PRODUCT_NUMBER,
    ECCQTR.INTERNAL_PART_NUMBER,
    ECCQTR.CUSTOMER_PART_NUMBER,
    ECCQTR.TRANSACTION_CURRENCY_ISO_CODE,
    ECCQTR.DISTRIBUTOR_END_CUSTOMER_IDENTIFIER,
    ECCQTR.DISTRIBUTOR_END_CUSTOMER_NAME,
    ECCQTR.DISTRIBUTOR_SHIP_TO_CUSTOMER_IDENTIFIER,
    ECCQTR.DISTRIBUTOR_SHIP_TO_CUSTOMER_NAME,
    ECCQTR.PRICE_CONTRACT,
    ECCQTR.SOURCE_OF_SALE,
    ECCQTR.SOURCE_OF_DATA,
    ECCQTR.ACTIVITY,
    ECCQTR.END_CORPORATION_DECODE  
