{{ 
config(
  description = 'ACTIVE AD USER view for Sales Analytics Team', 
  materialized = 'view', 
  schema = 'SALES', 
  tags = 'MART',
  alias = 'AD_USER_RPT'
) 
}} 

SELECT
    AD_USER_KEY,
    USERID,
    AD_GROUP,
    DN,
    OBJECTCLASS,
    ONCOMPANYDN,
    EMAILADDRESS,
    ONMODIFIER,
    ONACCOUNTTYPE,
    ONSPONSORDN,
    ONPREFERREDNAME,
    SN,
    ONMODIFYTIMESTAMP,
    TELEPHONENUMBER,
    ONDEPARTMENTDN,
    ONDISPLAY,
    OTHERSYSTEMS,
    ONMAILDROPDN,
    SPLIT_PART(DISPLAYNAME,'|',-1) AS DISPLAYNAME,
    ONCOMPUTERDN,
    ONSHOWPICTURE,
    GIVENNAME,
    ONLOCATIONDN,
    LOGINDISABLED,
    ONSYNCDATE,
    TITLE,
    FACSIMILETELEPHONENUMBER,
    ROOMNUMBER,
    ONSYNCTYPE,
    ONSUPERVISORDN,
    ONPURCHASEORDERDN,
    C,
    ONCID,
    ONPAGERDN,
    INITIALS,
    MOBILE,
    ONLICENSEPLATENUMBER,
    BASE,
    HASREPORTS,
    DEPARTMENT,
    ADVS_ONCOMPANYDN,
    MANAGER,
    ADVS_ONSPONSORDN,
    ADVS_ONLOCATIONDN,
    ADVS_ONMAILDROPDN,
    ONPERSONALPHONE,
    ONPERSONALPAGER,
    ONSSTANUMBER,
    ONBADGEEXPIREDATE,
    ONBADGEISSUEDATE,
    ONBIRTHDATESTR,
    DESCRIPTION,
    ONEXTERNALMANAGERNAME,
    ONEXTERNALMANAGERPHONE,
    ONSSN,
    MIRROR_SYNC_TIMESTAMP,
    ONPHONEDN,
    ONORACLEPERSONID,
    DBT_VALID_FROM AS EFFECTIVE_FROM_DATE,
    COALESCE(DBT_VALID_TO,'9999-12-31')::DATE AS EFFECTIVE_TO_DATE,
    BIW_INS_DTTM ,
    BIW_UPD_DTTM ,
    BIW_BATCH_ID,
    BIW_MD5_KEY
FROM
	{{ref('MART_AD_USER_HIST')}}
WHERE (AD_USER_KEY, DBT_VALID_FROM) IN (SELECT 
                                          AD_USER_KEY,
                                          MAX(DBT_VALID_FROM) 
                                        FROM {{ref('MART_AD_USER_HIST')}}
                                        GROUP BY 1
                                        )
