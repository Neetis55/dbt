{{ config(
  description = 'FUNNEL_RATING Dimension view for Sales Analytics Team', 
  materialized = 'view', 
  schema = 'SALES', 
  tags = 'MART_SALES',
  alias = 'FUNNEL_RATING_HIST_DIM'
) }} 

WITH FUNNEL_RATINGS AS
(
SELECT
        md5(ID) AS FUNNEL_RATING_KEY,
        ID,
        DESIGN_PART_MAPPING_AK::int AS DESIGN_PART_MAPPING_AK,
        MODELVERSION::int AS MODELVERSION,
        TRUNCATE(M1,4) AS M1,
        TRUNCATE(M2,4) AS M2,
        TRUNCATE(M3,4) AS M3,
        TRUNCATE(PROBABILITY,4) AS PROBABILITY,
        TRUNCATE(RATING,4) AS RATING,
        DESIGNPHASE::int AS DESIGNPHASE,
        PREDICTIONDATE::datetime AS PREDICTIONDATE,
        TRUNCATE(AGEWEEKS,4) AS AGEWEEKS,
        TRUNCATE(APPWINRATE,4) AS APPWINRATE,
        TRUNCATE(DISTIWINRATE,4) AS DISTIWINRATE,
        TRUNCATE(CUSTWINRATE,4) AS CUSTWINRATE,
        TRUNCATE(FAEWINRATE,4) AS FAEWINRATE,
        TRUNCATE(FSEWINRATE,4) AS FSEWINRATE,
        TRUNCATE(PAL4WINRATE,4) AS PAL4WINRATE,
        CUSTPAL3WON::int AS CUSTPAL3WON,
        CUSTPAL3BOUGHT::int AS CUSTPAL3BOUGHT,
        PREDICTION_FROM_PROCESS
FROM {{source ('PROJ_OPTR','FUNNEL_RATINGS')}}
WHERE
(PREDICTIONDATE < '2022-02-14' AND PREDICTION_FROM_PROCESS = 'Local Compute')
OR 
(PREDICTIONDATE > '2022-02-14' AND PREDICTION_FROM_PROCESS = 'AzureML Pipeline')
),

FISCAL_WEEK_VW AS 
(
    SELECT 
        CALENDAR_DATE,
        FISCAL_WEEK_PRIOR AS SNAPSHOTYYYYWK
    FROM 
    {{V_ANALYTICS_DB}}ENTERPRISE.DATE
)

SELECT 
  FUNNELDIM.FUNNEL_RATING_KEY,
  FIS_WEEK.SNAPSHOTYYYYWK,
  FUNNELDIM.ID,
  FUNNELDIM.DESIGN_PART_MAPPING_AK,
  FUNNELDIM.MODELVERSION,
  FUNNELDIM.M1,
  FUNNELDIM.M2,
  FUNNELDIM.M3,
  FUNNELDIM.PROBABILITY,
  FUNNELDIM.RATING,
  FUNNELDIM.DESIGNPHASE,
  FUNNELDIM.PREDICTIONDATE,
  FUNNELDIM.AGEWEEKS,
  FUNNELDIM.APPWINRATE,
  FUNNELDIM.DISTIWINRATE,
  FUNNELDIM.CUSTWINRATE,
  FUNNELDIM.FAEWINRATE,
  FUNNELDIM.FSEWINRATE,
  FUNNELDIM.PAL4WINRATE,
  FUNNELDIM.CUSTPAL3WON,
  FUNNELDIM.CUSTPAL3BOUGHT,
  FUNNELDIM.PREDICTION_FROM_PROCESS
FROM FUNNEL_RATINGS FUNNELDIM
INNER JOIN FISCAL_WEEK_VW FIS_WEEK 
ON FUNNELDIM.PREDICTIONDATE = FIS_WEEK.CALENDAR_DATE