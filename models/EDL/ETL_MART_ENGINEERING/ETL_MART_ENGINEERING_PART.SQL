/*---------------------------------------------------------------------------
Command to run model:
--  dbt build --select ETL_MART_ENGINEERING_PART
Version     Date            Author              Description
-------     --------        -----------         ----------------------------------
1.0         08 NOV 2022      KALI DANDAPANI     Added JRN_FLAG AND EFFT DATE filter in Agile union
2.0         10 NOV 2022      KALI DANDAPANI     Changed BUSINESS_GROUP mapping from SDM logic to xxon_fs_bu_rule 
                                                Added REPORTING_UNIT as new column using Financial team mapping table
3.0         30 JAN 2023      RAMYA NAGARAJ      Changed the mapping of column PREDOMINANT_OPN_PART_ID top APS.OPN
---------------------------------------------------------------------------*/

{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['PART_ID']-%}
{% if env_var('DBT_DEP_ENV') =='DEV' %}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
{%-set v_all_column_list =  edw_get_column_list( this ) -%}
{%-set v_update_column_list =  edw_get_quoted_column_list( this ,v_pk_list|list + ['BIW_INS_DTTM']|list) -%}
{%-set v_md5_column_list =  edw_get_md5_column_list( this ,v_pk_list|list+ v_house_keeping_column|list ) -%}
--DBT Variable
--SELECT {{v_all_column_list}}  
--SELECT {{v_update_column_list}}  
--SELECT {{v_md5_column_list}}
{% endif %}
{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'DBT_ETL_MART_ENGINEERING_PART'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}


{################# Snowflake Object Configuration #################}
{{
    config(
         description = 'Building ETL table PART for Engineering Mart'
        ,transient=true   
        ,materialized='view'
        ,schema ='ETL_MART_ENGINEERING'
        ,alias='PART'
        ,tags =['MART_ENGINEERING','MART_SALES']
        ,post_hook= [v_sql_upd_success_batch]	
        )
}}

WITH AGILE_PART AS 
(
    SELECT 
        PART_ID,
        EFFECTIVE_DATE ,
        PART_DESCRIPTION,
        PART_SOURCE,
        LEGACY_PART_ID,
        PAL1_CODE,
        PAL2_CODE,    
        PAL3_CODE,
        PAL4_CODE,    
        PART_CLASS_CODE,
        PART_CLASS_DESCRIPTION,
        AEC_QUALIFIED_CODE,
        CASE_OUTLINE_CODE,
        COMMODITY_CODE,
        ECAT_CODE,
        ECCN_CODE,
        ERP_RESOURCE_ASY_CODE,
        ERP_RESOURCE_ASY_DESCRIPTION, 
        ERP_RESOURCE_BSP_CODE,
        ERP_RESOURCE_FAB_CODE,
        ERP_RESOURCE_FSP_CODE,
        ERP_RESOURCE_MEF_CODE,
        ERP_RESOURCE_SWF_CODE,
        ERP_RESOURCE_TST_CODE,
        MSL_VALUE,
        MSL_TEMPERATURE,
        PART_RELEASE_STATUS_CODE,
        PART_RELEASE_STATUS_DESCRIPTION,
        PART_SPEC_ID,
        QUALITY_LVL_CODE,
        QUALITY_LVL_TARGET_MARKET_DESCRIPTION,
        PDPW_VALUE,
        IS_UL_LISTED,
        UOM_OPERATIONS_CODE,
        WAFER_SIZE_VALUE,
        LAST_ORDER_DATE,
        LAST_SHIP_DATE,
        NEW_PART_DEFINITION_DATE,
        NEW_PART_EXP_DATE,
        PART_RELEASE_PRODUCTION_DATE,
        IS_BURN_IN,
        BUY_SELL_CODE,
        IS_CUSTOM_ELEC_TEST,
        IS_CUSTOM_MARK_ONLY,
        IS_CUSTOMER_CONSIGN_TO_ON,
        IS_ENG_PART,
        IS_HALIDE_FREE,
        IS_ITAR,
        LEADED_DIE_ATTACH_CODE,
        MILITARY_COMPLIANCE_CODE,
        IS_OPN,
        IS_PB_FREE_LEADS,
        ROHS_CHINA_CODE,
        ROHS_EU_EXEMPTION_CODE,
        ROHS_EU_CODE,
        SAMPLE_ALLOW_CODE,
        SOQ_QUANTITY, 
        IS_VALUED_PART,
        CREATE_BY,
        CREATE_DATE,
        PART_TYPE_DESCRIPTION,
        PART_SUB_TYPE_CD,
        LIFECYCLE_PHASE_DESCRIPTION,
        MARKET_PART_LIFECYCLE_DESCRIPTION,
        PACKING_CONFIG_ID,
        PART_OWNER_DESCRIPTION,
        CORE_PART_NO_CONFIG_ID,
        SAFE_LAUNCH_CODE,
        DESIGN_TYPE_DESC,
        MKT_SEG_SUBSEG_EUC_PRI_DESC,
        WSTS_CD,
        PROJECT_NUMBER_CD,
        CASE_OUTLINE_ID,
        DIE_DESIGN_CONFIG_ID,
        WAFER_BACKSIDE_VAR_ID,
        WAFER_FRONTSIDE_VARIANT_ID,
        WAFER_TECH_VARIANT_ID,
        PART_QUALITY_TARGET_MARKET_TYPE,
        PART_QUALITY_TARGET_MARKET_DESCRIPTION,
        LEGACY_COMPANY_NAME,
        SUPPLY_CHN_PLNG_CODE, 
        ANCHOR_STAR_PRODUCT_CODE,
        MARKET_PN,
        IS_MARKET_PN,
        ENG_PKG_VAR_ID,
        FLOW_CODE, 
        IS_SPEC_CNTRL_BOM,
        PPAP_CAPABLE_CODE,
        CUST_SPEC_CONTROLLED_CODE,
        ENGG_CHNG_ORDER_ID,
        AEC_QUAL,
        GLOBAL_PART_ID,
        PART_OWNER_NAME,
        ENG_PKG_CODE,
        IS_CONTAIN_ENCRYPT,
        SOLUTION_SELLING_TYPE,
        MFG_PART_ID,
        IS_PB_FREE_PART,
        PB_FREE_PART_DESCRIPTION,
        PB_FREE_PART_EXEMPT,
        IS_LABEL_SYMBOL_ROHS_EU,
        IS_LABEL_SYMBOL_ROHS_CHINA, 
        LABEL_SYMBOL_ROHS_CHINA_VALUE,
        IS_LABEL_SYMBOL_PBFREE_2LI,
        IS_LABEL_SYMBOL_2LI,
        IS_LABEL_SYMBOL_ECAT,
        IS_LABEL_SYMBOL_HALIDE_FREE,
        IS_LABEL_SYMBOL_RU,
        LABEL_SYMBOL_ECAT_CODE,
        PACKAGE_CODE_DESCRIPTION,
        PART_REL_FCST_DATE, 
        SUBJECT_EXPORT_ADMIN_REG,
        EXEMPTIONS,
        IS_ROHS,
        ----- Hardcoded value----------
        EXPERT_DATA_SOURCE_NAME, 
        IS_ON_TARGET,
        --------------PACK_CONFIG---------------------------------------
        MPQ_PRI_CONTAINER_CODE,
        MPQ_PRI_CONTAINER_QUANTITY,
        IS_TAPE_REEL,
        -----------------CUST_CONFIG---------------------------------------
        HTS_EU_CODE,
        HTS_US_CODE,
        HTS_US_CODE_DESCRIPTION,
        LAST_CHANGE_DATE,
        HTS_EU_8_CODE, 
        ------------------CASE_OUTLINE And Package---------------
        ENG_PKG_TYPE_DESC,
        ENG_PKG_FAM_DESC,
        -------------------WAFER_VAR----------------------------------
        WAFER_TECH_TYPE_ID,
        ----------------------WAFER_FAM-----------------------------------
        WAFER_TECH_FAM_ID,
        -----------------GPS Owner-----------------------------------
        PART_PROGRAM_CODE, 
        IS_NCNR,
        MARKET_CD,
        STEP_PRICE_FLG,
        ONPN,
        PRICE_BOOK_FLG,
        IS_PRICE_BOOK,
        ----------------EBS Attributes----------------
        BUSINESS_UNIT_CODE,
        GROUP_CODE,
        GROUP_DESCRIPTION,
        DIVISION_CODE,
        DIVISION_DESCRIPTION,
        BUSINESS_UNIT_DESCRIPTION,
        OPERTNL_CODE,
        OPERTNL_DESC,
        ---------------MainFrame Description for PAL Code --------------
        PAL2_DESCRIPTION,
        PAL3_DESCRIPTION,
        PAL4_DESCRIPTION,
        ------------APS Attributes -----------------------
        DEFLT_APS_STAGE_CD,
        DEFLT_FE_BE_CD,
        --------------------DWH_IO Attributes -------------------------
        PART_AVAILABILITY_STATUS_CODE,
        --------------------Dataware Attributes -------------------------
        SBU_SHORT_DESCRIPTION,
        DOCUMENT_ISSUE,    
        JRN_FLAG,
        FSP_DATE
    FROM {{ ref('ETL_MART_ENGINEERING_PART_AGILE')}}
),

APS_PART AS
(
    SELECT 
        PART_ID,
        DEFLT_APS_STAGE_CD,
        BASE_PART_ID,
        AREA,
        SUB_AREA,
        ASSY_RATIO,
        AVERAGE_USAGE,
        CAPC_GROUP_CD,
        WFA_SITES,
        WPR_SITES,
        CAPC_CONSTR_COLOR,
        CAPC_CONSTR_PRIM_CONSTR_RG,
        PACKAGE_GROUP_CD,
        DCE_CT,
        FAMILY_LT,
        POINT_LT,
        TREND_LT,
        OVERRIDE_LT,
        TBOT_LT,
        MBOI_ASSY_SITES,
        MBOI_TEST_SITES,
        APS_ASSY_SITES,
        APS_TEST_SITES,
        AGILE_ASSY_SITES,
        AGILE_TEST_SITES,
        COLOR_ADJUSTED,
        COLOR_OVERRIDE,
        CREATED_USERID,
        REASON_DESC,
        APS_REL_FLG,
        SCA_UID,
        SCA_USERNAME,
        MAIL,
        DIR_UID,
        DIR_NAME,
        BUPM_USERNAME,
        BUPM_UID,
        APS_BUILD_CATEGORY_CODE,
        IO_PART_CLASS,
        IO_CATEGORY,
        IO_OVERRIDE_CATEGORY,
        MLQ,
        OPN
    FROM {{ ref('ETL_MART_ENGINEERING_PART_APS')}}
),

MAINFRAME_PART AS 
(
    SELECT 
        PART_ID,
        PART_ADD_DT,
        PART_STATUS_CD,
        PART_STATUS_DESCRIPTION,
        HTS_EU_CD_DESC,
        FO_LEADTIME_WK_NUM,
        PRODLINE_COMPTYPE,
        PROD_LINE_ID,
        SBU_CD,
        LAST_CHG_USERID,
        PROD_CLASS_CD,
        PART_STATUS_GROUP,
        CUSTSPEC_FLG,
        POQ_CONTAINER_CD,
        POQ_QTY,
        SOQ_CONTAINER_CD,
        DOCUMENT_NUMBER,
        BIW_INS_DTTM,
        BIW_UPD_DTTM,
        BIW_BATCH_ID
    FROM {{ ref('ETL_MART_ENGINEERING_PART_MAINFRAME')}}
),
STG_MODELN_PRICING_OWNER AS
(
    SELECT 
        MPN,
        CREATED_DATE,
        OID AS PART_OID_AK_ID,
        MULT AS MOQ_QUANTITY
    FROM {{source ('STG_MODELN_PRICING_OWNER','PART')}}
    QUALIFY( row_number() OVER (PARTITION BY MPN ORDER BY BIW_UPD_DTTM DESC)=1) 
)
,STG_XXON_FS_BU_RULE AS
(
    SELECT 
        BU_CD,
        BUSINESS_GROUP,
        REPORTING_UNIT
    FROM {{source('STG_EBS_APPS','XXON_FS_BU_RULE')}}
    QUALIFY( ROW_NUMBER() OVER (PARTITION BY BU_CD ORDER BY BIW_UPD_DTTM DESC)=1) 
)

,AGILE_FINAL_CTE AS 
(
SELECT 
    AGILE.PART_ID,
    AGILE.EFFECTIVE_DATE,
    AGILE.PART_DESCRIPTION,
    AGILE.PART_SOURCE,
    AGILE.LEGACY_PART_ID,
    AGILE.PAL1_CODE,
    AGILE.PAL2_CODE,
    AGILE.PAL2_DESCRIPTION,
    AGILE.PAL3_CODE,
    AGILE.PAL3_DESCRIPTION,
    AGILE.PAL4_CODE,
    AGILE.PAL4_DESCRIPTION,
    AGILE.PART_CLASS_CODE,
    AGILE.PART_CLASS_DESCRIPTION,
    COALESCE(MAINFRAME.PART_STATUS_CD,'~') AS PART_TRANS_STATUS_CODE,
    COALESCE(MAINFRAME.PART_STATUS_DESCRIPTION,'Unassigned') AS PART_TRANS_STATUS_DESCRIPTION,
    AGILE.AEC_QUALIFIED_CODE,
    COALESCE(APS.APS_BUILD_CATEGORY_CODE,' ') AS APS_BUILD_CATEGORY_CODE,
    AGILE.CASE_OUTLINE_CODE,
    AGILE.COMMODITY_CODE,
    AGILE.ECAT_CODE,
    AGILE.ECCN_CODE,
    AGILE.ERP_RESOURCE_ASY_CODE,
    AGILE.ERP_RESOURCE_ASY_DESCRIPTION,
    AGILE.ERP_RESOURCE_BSP_CODE,
    AGILE.ERP_RESOURCE_FAB_CODE,
    AGILE.ERP_RESOURCE_FSP_CODE,
    AGILE.ERP_RESOURCE_MEF_CODE,
    AGILE.ERP_RESOURCE_SWF_CODE,
    AGILE.ERP_RESOURCE_TST_CODE,
    AGILE.HTS_EU_CODE,
    NVL(MAINFRAME.HTS_EU_CD_DESC,' ') AS HTS_EU_CODE_DESCRIPTION,
    AGILE.HTS_US_CODE,
    AGILE.HTS_US_CODE_DESCRIPTION,
    NVL(MAINFRAME.FO_LEADTIME_WK_NUM,-1) AS MARKET_LEADTIME_WEEKS,
    NVL(MODELN.MOQ_QUANTITY,0) AS MOQ_QUANTITY,
    AGILE.MPQ_PRI_CONTAINER_CODE,
    AGILE.MPQ_PRI_CONTAINER_QUANTITY,
    AGILE.MSL_VALUE,
    AGILE.MSL_TEMPERATURE,
    NVL(MAINFRAME.PRODLINE_COMPTYPE,' ') AS PART_COMP_TYPE_CODE,
    AGILE.PART_RELEASE_STATUS_CODE,
    AGILE.PART_RELEASE_STATUS_DESCRIPTION,
    AGILE.PART_SPEC_ID,
    NVL(MAINFRAME.POQ_CONTAINER_CD,' ') AS POQ_CONTAINER_CODE,
    NVL(MAINFRAME.POQ_QTY,0) AS POQ_QUANTITY,
    AGILE.PPAP_CAPABLE_CODE,
    NVL(MAINFRAME.PROD_LINE_ID,' ') AS PART_LINE_ID,
    AGILE.PART_AVAILABILITY_STATUS_CODE,
    AGILE.QUALITY_LVL_CODE,
    AGILE.QUALITY_LVL_TARGET_MARKET_DESCRIPTION,
    NVL(MAINFRAME.SBU_CD,' ') AS SBU_CODE,
    NVL(MAINFRAME.SOQ_CONTAINER_CD,' ') AS SOQ_CONTAINER_CODE,
    AGILE.PDPW_VALUE,
    AGILE.IS_UL_LISTED,
    AGILE.UOM_OPERATIONS_CODE,
    AGILE.WAFER_SIZE_VALUE,
    AGILE.LAST_CHANGE_DATE,
    AGILE.LAST_ORDER_DATE,
    AGILE.LAST_SHIP_DATE,
    AGILE.NEW_PART_DEFINITION_DATE,
    AGILE.NEW_PART_EXP_DATE,
    AGILE.PART_RELEASE_PRODUCTION_DATE,
    coalesce(try_to_boolean(APS.APS_REL_FLG),'False')::BOOLEAN AS  IS_APS_RELEVANT,
    AGILE.IS_BURN_IN,
    AGILE.BUY_SELL_CODE,
    AGILE.IS_CUSTOM_ELEC_TEST,
    AGILE.IS_CUSTOM_MARK_ONLY,
    coalesce(try_to_boolean(MAINFRAME.CUSTSPEC_FLG),'False')::BOOLEAN AS  IS_CUSTOM_PART_ID,
    AGILE.IS_CUSTOMER_CONSIGN_TO_ON,
    AGILE.IS_ENG_PART,
    AGILE.IS_HALIDE_FREE,
    AGILE.IS_ITAR,
    AGILE.LEADED_DIE_ATTACH_CODE,
    AGILE.MILITARY_COMPLIANCE_CODE,
    CASE 
    WHEN AGILE.ONPN IS NOT NULL
        AND MAINFRAME.PROD_CLASS_CD IN ('AA','CP','CW','WD','KT','AM','WU')
        AND AGILE.PART_PROGRAM_CODE ='M'
        AND AGILE.IS_PRICE_BOOK ='TRUE'
	THEN 'Y' 
    ELSE 'N' 
    END::BOOLEAN AS IS_MPP,
    AGILE.IS_NCNR,
    AGILE.IS_OPN,
    AGILE.IS_PB_FREE_LEADS,
    AGILE.IS_PRICE_BOOK,
    AGILE.ROHS_CHINA_CODE,
    AGILE.ROHS_EU_EXEMPTION_CODE,
    AGILE.ROHS_EU_CODE,
    AGILE.SAMPLE_ALLOW_CODE,
    CASE
        WHEN MAINFRAME.CUSTSPEC_FLG ='Y'
        THEN 'Y'
        WHEN MAINFRAME.CUSTSPEC_FLG ='N' 
            AND AGILE.MARKET_CD in ('S','Q') AND AGILE.ONPN IS NOT NULL
            AND MAINFRAME.PROD_CLASS_CD IN ('AA','CP','CW','WD','KT','AM','WU')
        THEN 'Y'
        ELSE 'N'
    END::BOOLEAN AS IS_SOLE_SOURCE,
    coalesce(try_to_boolean(
    CASE 
    WHEN AGILE.ONPN IS NOT NULL
        AND MAINFRAME.PROD_CLASS_CD IN ('AA','CP','CW','WD','KT','AM','WU')
    THEN AGILE.STEP_PRICE_FLG
    ELSE 'N' 
    END),'FALSE')::BOOLEAN AS  IS_STEP_PRICE,
    AGILE.IS_TAPE_REEL,
    AGILE.IS_VALUED_PART,
    AGILE.CREATE_BY,
    AGILE.CREATE_DATE,
    NVL(MAINFRAME.LAST_CHG_USERID,' ') AS LAST_CHANGE_USER_ID,
    NVL(MODELN.PART_OID_AK_ID,-1) AS PART_OID_AK_ID,
    AGILE.PART_TYPE_DESCRIPTION,
    AGILE.PART_SUB_TYPE_CD,
    AGILE.LIFECYCLE_PHASE_DESCRIPTION,
    AGILE.MARKET_PART_LIFECYCLE_DESCRIPTION,
    AGILE.PACKING_CONFIG_ID,
    AGILE.PART_OWNER_DESCRIPTION,
    AGILE.CORE_PART_NO_CONFIG_ID,
    AGILE.SAFE_LAUNCH_CODE,
    AGILE.DESIGN_TYPE_DESC,
    AGILE.MKT_SEG_SUBSEG_EUC_PRI_DESC,
    AGILE.WSTS_CD,
    AGILE.PROJECT_NUMBER_CD,
    AGILE.CASE_OUTLINE_ID,
    AGILE.DIE_DESIGN_CONFIG_ID,
    AGILE.WAFER_BACKSIDE_VAR_ID,
    AGILE.WAFER_FRONTSIDE_VARIANT_ID,
    AGILE.WAFER_TECH_VARIANT_ID,
    AGILE.WAFER_TECH_TYPE_ID,
    AGILE.WAFER_TECH_FAM_ID,
    AGILE.ENG_PKG_TYPE_DESC,
    AGILE.ENG_PKG_FAM_DESC,
    AGILE.DEFLT_APS_STAGE_CD,
    AGILE.DEFLT_FE_BE_CD,
    AGILE.ENGG_CHNG_ORDER_ID,
    coalesce(AGILE.CUST_SPEC_CONTROLLED_CODE,'N') AS CUST_SPEC_CONTROLLED_CODE,
    'TBD' AS COMPONENT_COUNT,
    'TBD' AS TOTAL_COMPONENT_COUNT,    
    'TBD' AS DISTINCT_COMPONENT_COUNT, 
    AGILE.EXPERT_DATA_SOURCE_NAME,
    NVL(APS.OPN,' ') AS PREDOMINANT_OPN_PART_ID,
    NVL(APS.SCA_UID,' ') AS EXPERT_USER_ID,
    --- USERID TABLE---
    NVL(APS.MAIL, ' ') AS EXPERT_EMAIL,
    NVL(APS.SCA_USERNAME, ' ') AS EXPERT_NAME,
    NVL(APS.DIR_UID, ' ')  AS PLANNING_DIRECTOR_ID,
    NVL(APS.DIR_NAME, ' ')  AS PLANNING_DIRECTOR_NAME,

    NVL(APS.BUPM_USERNAME,' ') AS BU_MANAGER_NAME,
    NVL(APS.BUPM_UID,' ') AS BU_MANAGER_ID,

    AGILE.PART_QUALITY_TARGET_MARKET_TYPE,
    AGILE.PART_QUALITY_TARGET_MARKET_DESCRIPTION,
    AGILE.LEGACY_COMPANY_NAME,
    AGILE.SBU_SHORT_DESCRIPTION,
    AGILE.GLOBAL_PART_ID,
    AGILE.PART_OWNER_NAME,
    NVL(APS.PACKAGE_GROUP_CD,' ')  AS PACKAGE_GROUP_CODE,

    NVL(APS.DCE_CT,0) AS DCE_CYCLE_TIME_DAYS,
    NVL(APS.FAMILY_LT,0) AS FAMILY_LEAD_TIME_DAYS,
    NVL(APS.POINT_LT,0) AS POINT_LEAD_TIME_DAYS,
    NVL(APS.TREND_LT,0) AS TREND_LEAD_TIME_DAYS,
    NVL(APS.OVERRIDE_LT,0) AS OVERRIDE_LEAD_TIME_DAYS,
    NVL(APS.TBOT_LT,0) AS PLANNING_SYSTEM_LEAD_TIME_DAYS,

    NVL(APS.MBOI_ASSY_SITES,' ') AS MBOI_ASSEMBLY_SITE_CODE,
    NVL(APS.MBOI_TEST_SITES,' ') AS MBOI_TEST_SITE_CODE,
    NVL(APS.APS_ASSY_SITES,' ') AS APS_ASSEMBLY_SITE_CODE,
    NVL(APS.APS_TEST_SITES,' ') AS APS_TEST_SITE_CODE,
    NVL(APS.AGILE_ASSY_SITES,' ') AS AGILE_ASSEMBLY_SITE_CODE,
    NVL(APS.AGILE_TEST_SITES,' ') AS AGILE_TEST_SITE_CODE,

    NVL(APS.CAPC_GROUP_CD,' ') AS CAPACITY_GROUP_CODE,
    NVL(APS.WFA_SITES,' ') AS WFA_SITE_CODE,
    NVL(APS.WPR_SITES,' ') AS WPR_SITE_CODE,

    AGILE.BUSINESS_UNIT_CODE,

    NVL(APS.AREA,' ') AS PART_AREA_CODE,
    NVL(APS.SUB_AREA,' ') AS PART_SUB_AREA_CODE,
    NVL(APS.ASSY_RATIO,0) AS ASSEMBLY_RATIO_NUMBER,
    NVL(APS.AVERAGE_USAGE,0) AS AVERAGE_USAGE_NUMBER,

    AGILE.PART_PROGRAM_CODE,
    AGILE.SUPPLY_CHN_PLNG_CODE,
    COALESCE(AGILE.ANCHOR_STAR_PRODUCT_CODE,' ') AS ANCHOR_STAR_PRODUCT_CODE,

    
    COALESCE(APS.IO_PART_CLASS,' ') AS IO_PART_CLASS,
    COALESCE(APS.IO_CATEGORY,' ') AS IO_CATEGORY,

    AGILE.MFG_PART_ID,
    AGILE.GROUP_CODE,
    AGILE.GROUP_DESCRIPTION,
    AGILE.DIVISION_CODE,
    AGILE.DIVISION_DESCRIPTION,
    AGILE.BUSINESS_UNIT_DESCRIPTION,
    AGILE.OPERTNL_CODE,
    AGILE.OPERTNL_DESC,
    COALESCE(APS.IO_OVERRIDE_CATEGORY,' ') IO_OVERRIDE_CATEGORY,
    AGILE.MARKET_PN,
    AGILE.IS_MARKET_PN,
    AGILE.ENG_PKG_VAR_ID,
    AGILE.FLOW_CODE,
    AGILE.IS_SPEC_CNTRL_BOM,
    AGILE.DOCUMENT_ISSUE,
    AGILE.ENG_PKG_CODE,
    AGILE.IS_CONTAIN_ENCRYPT,
    AGILE.SOLUTION_SELLING_TYPE,
    NVL(APS.CAPC_CONSTR_COLOR, ' ') AS CAPC_CONSTR_COLOR,
    NVL(APS.COLOR_ADJUSTED, ' ') AS CAPC_CONSTR_COLOR_CALCED,
    NVL(APS.COLOR_OVERRIDE, ' ') AS CAPC_CONSTR_COLOR_OVRD,
    NVL(APS.CREATED_USERID, ' ') AS CAPC_CONSTR_COLOR_OVRD_UID,
    NVL(APS.REASON_DESC, ' ') AS CAPC_CONSTR_COLOR_OVRD_RSN,
    APS.CAPC_CONSTR_PRIM_CONSTR_RG,

    AGILE.SUBJECT_EXPORT_ADMIN_REG,
    NVL(APS.MLQ,0) AS MAX_LINE_QUANTITY,
    AGILE.IS_PB_FREE_PART,
    AGILE.PB_FREE_PART_DESCRIPTION,
    AGILE.PB_FREE_PART_EXEMPT,
    AGILE.IS_LABEL_SYMBOL_ROHS_EU,
    AGILE.IS_LABEL_SYMBOL_ROHS_CHINA,
    AGILE.LABEL_SYMBOL_ROHS_CHINA_VALUE,
    AGILE.IS_LABEL_SYMBOL_PBFREE_2LI,
    AGILE.IS_LABEL_SYMBOL_2LI,
    AGILE.IS_LABEL_SYMBOL_ECAT,
    AGILE.IS_LABEL_SYMBOL_HALIDE_FREE,
    AGILE.IS_LABEL_SYMBOL_RU,
    AGILE.LABEL_SYMBOL_ECAT_CODE,
    AGILE.HTS_EU_8_CODE,
    AGILE.PART_REL_FCST_DATE,
    COALESCE(MAINFRAME.PART_STATUS_GROUP,'Active') PART_STATUS_GROUP,
    AGILE.PART_RELEASE_PRODUCTION_DATE AS RELEASE_DATE,
    AGILE.SOQ_QUANTITY,
    AGILE.PACKAGE_CODE_DESCRIPTION,
    AGILE.EXEMPTIONS,
    AGILE.IS_ROHS,
    AGILE.NEW_PART_DEFINITION_DATE AS NPD_DATE,
    AGILE.IS_ON_TARGET,
    COALESCE(MAINFRAME.PART_ADD_DT, MODELN.CREATED_DATE,'1/1/1990') AS PART_ADD_TIMESTAMP,
    NVL(BU_RULE.BUSINESS_GROUP,'MISC') AS BUSINESS_GROUP,
    BU_RULE.REPORTING_UNIT,
    NVL(AGILE.FSP_DATE,DATE('01-01-1900','MM-DD-YYYY') ) AS FSP_DATE
FROM AGILE_PART AGILE

LEFT JOIN APS_PART APS
    ON AGILE.PART_ID = APS.PART_ID 

LEFT JOIN MAINFRAME_PART MAINFRAME
    ON AGILE.PART_ID = MAINFRAME.PART_ID 

LEFT OUTER JOIN STG_MODELN_PRICING_OWNER MODELN
   ON AGILE.PART_ID=MODELN.MPN 

LEFT OUTER JOIN  STG_XXON_FS_BU_RULE BU_RULE 
    ON AGILE.PAL3_CODE= BU_RULE.BU_CD 
)

---------------------------------------------------------------------------------------
-----------------------MAINFRAME/LEGACY PARTS------------------------------------------
---------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------

,LEGACY_FINAL_CTE AS (
SELECT 
    LEGACY.PART_ID,
    TO_DATE('1-1-1900', 'MM-DD-YYYY') AS EFFECTIVE_DATE,
    LEGACY.PART_DESC AS PART_DESCRIPTION,
    LEGACY.PART_SOURCE,
    COALESCE(LEGACY.PART_ID, ' ') AS LEGACY_PART_ID,
    LEGACY.PAL1_CODE AS PAL1_CODE,
    LEGACY.PAL2_CODE AS PAL2_CODE,
    LEGACY.PAL2_DESC AS PAL2_DESCRIPTION,
    LEGACY.PAL3_CODE AS PAL3_CODE,
    LEGACY.PAL3_DESC AS PAL3_DESCRIPTION,
    LEGACY.PTI4_CD AS PAL4_CODE,
    LEGACY.PAL4_DESC AS PAL4_DESCRIPTION,
    LEGACY.PART_CLASS_CD AS PART_CLASS_CODE,
    LEGACY.DISCRIPTION AS PART_CLASS_DESCRIPTION,
    NVL(LEGACY.PART_STATUS_CD,' ') AS PART_TRANS_STATUS_CODE,
    LEGACY.PART_STATUS_DESCRIPTION AS PART_TRANS_STATUS_DESCRIPTION,
    LEGACY.AEC_QUALIFIED_CD AS AEC_QUALIFIED_CODE,
    COALESCE(APS.APS_BUILD_CATEGORY_CODE,' ') AS APS_BUILD_CATEGORY_CODE,
    NVL(LEGACY.MOTOROLA_CASE_NO,' ')AS CASE_OUTLINE_CODE,
    LEGACY.COMMODITY_CD AS COMMODITY_CODE,
    LEGACY.FINISH_CODE AS ECAT_CODE,
    LEGACY.ECCN_CD AS ECCN_CODE,
    NVL(LEGACY.ERP_RESOURCE_ASY_CD,' ') AS ERP_RESOURCE_ASY_CODE,
    LEGACY.ERP_RESOURCE_ASY_DESC AS ERP_RESOURCE_ASY_DESCRIPTION,
    LEGACY.ERP_RESOURCE_BSP_CD AS ERP_RESOURCE_BSP_CODE,
    LEGACY.ERP_RESOURCE_FAB_CD AS ERP_RESOURCE_FAB_CODE,
    LEGACY.ERP_RESOURCE_FSP_CD AS ERP_RESOURCE_FSP_CODE,
    LEGACY.ERP_RESOURCE_MEF_CD AS ERP_RESOURCE_MEF_CODE,
    LEGACY.ERP_RESOURCE_SWF_CD AS ERP_RESOURCE_SWF_CODE,
    LEGACY.ERP_RESOURCE_TST_CD AS ERP_RESOURCE_TST_CODE,
    LEGACY.HTS_EU_CD AS HTS_EU_CODE,
    NVL(LEGACY.HTS_EU_CD_DESC,' ') AS HTS_EU_CODE_DESCRIPTION,
    NVL(LEGACY.HARMONIZE_CD,' ')  AS HTS_US_CODE,
    LEGACY.HTS_US_CD_DESC AS HTS_US_CODE_DESCRIPTION,
    NVL(LEGACY.FO_LEADTIME_WK_NUM,0) AS MARKET_LEADTIME_WEEKS,
    NVL(MODELN.MOQ_QUANTITY,0) AS MOQ_QUANTITY,
    LEGACY.MPQ_PRI_CONTAINER_CD AS MPQ_PRI_CONTAINER_CODE,
    LEGACY.MPQ_PRI_CONTAINER_QTY AS MPQ_PRI_CONTAINER_QUANTITY,
    NVL(AGILE.MSL_VALUE,' ') AS MSL_VALUE,
    NVL(AGILE.MSL_TEMPERATURE,0 )AS MSL_TEMPERATURE,
    LEGACY.PART_COMP_TYPE_CD AS PART_COMP_TYPE_CODE,
    LEGACY.PART_RELEASE_STATUS_CD AS PART_RELEASE_STATUS_CODE,
    NVL(LEGACY.QUAL_STATUS_DESC,' ') AS PART_RELEASE_STATUS_DESCRIPTION,
    LEGACY.PART_SPEC_ID,
    NVL(LEGACY.POQ_CONTAINER_CD,' ') AS POQ_CONTAINER_CODE,
    NVL(LEGACY.POQ_QTY,0) AS POQ_QUANTITY,
    LEGACY.PPAP_CAPABLE_CD AS PPAP_CAPABLE_CODE,
    LEGACY.PART_LINE_ID AS PART_LINE_ID,
    NVL((
        CASE 
            WHEN( LEGACY.PART_STATUS_CD = 'B' OR
                LEGACY.PART_STATUS_CD = '0' OR
                LEGACY.PART_STATUS_CD = 'X' OR
                LEGACY.PART_STATUS_CD = 'V')
            THEN
                CASE 
                    WHEN LEGACY.FO_LEADTIME_WK_NUM <=0 OR LEGACY.FO_LEADTIME_WK_NUM >=99 
                        THEN 'CF'
                    WHEN LEGACY.FO_LEADTIME_WK_NUM = 95 
                        THEN 'BRIDG'
                    WHEN LEGACY.FO_LEADTIME_WK_NUM = 96 
                        THEN 'FACT'
                    WHEN LEGACY.FO_LEADTIME_WK_NUM = 97 
                        THEN 'ALLOC'
                    WHEN LEGACY.FO_LEADTIME_WK_NUM = 98 
                        THEN 'LTDRL'
                ELSE LEGACY.FO_LEADTIME_WK_NUM||'W'
                END
            ELSE 'CF'
        END)
        ,'##')  AS PART_AVAILABILITY_STATUS_CODE,
    LEGACY.QUALITY_LVL_CD AS QUALITY_LVL_CODE,
    LEGACY.QUALITY_LVL_TGT_MRKT_DESC AS QUALITY_LVL_TARGET_MARKET_DESCRIPTION,
    LEGACY.SBU_CD AS SBU_CODE,
    NVL(LEGACY.SOQ_CONTAINER_CD,' ') AS SOQ_CONTAINER_CODE,
    LEGACY.PDPW_VAL AS PDPW_VALUE,
    LEGACY.UL_LISTED_FLG AS IS_UL_LISTED,
    LEGACY.UOM_OPERATIONS_CD AS UOM_OPERATIONS_CODE,
    LEGACY.WAFER_SIZE_VAL AS WAFER_SIZE_VALUE,
    LEGACY.LAST_CHG_DT AS LAST_CHANGE_DATE,
    LEGACY.LAST_ORDER_DT AS LAST_ORDER_DATE,
    LEGACY.LAST_SHIP_DT AS LAST_SHIP_DATE,
    NVL(AGILE.NEW_PART_DEFINITION_DATE,TO_DATE('1-1-1900', 'MM-DD-YYYY')),
    NVL(AGILE.NEW_PART_EXP_DATE,TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS NEW_PART_EXP_DATE,
    NVL(AGILE.PART_RELEASE_PRODUCTION_DATE,TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS PART_RELEASE_PRODUCTION_DATE,
    COALESCE(try_to_boolean(APS.APS_REL_FLG),'False')::BOOLEAN AS  IS_APS_RELEVANT,
    LEGACY.BURN_IN_FLG AS IS_BURN_IN,
    LEGACY.BUY_SELL_FLG AS BUY_SELL_CODE,
    LEGACY.CUSTOM_ELEC_TEST_FLG AS IS_CUSTOM_ELEC_TEST,
    LEGACY.IS_CUSTOM_MARK_ONLY,
    COALESCE(TRY_TO_BOOLEAN(LEGACY.CUSTSPEC_FLG),'FALSE')::BOOLEAN AS IS_CUSTOM_PART_ID,
    LEGACY.IS_CUSTOMER_CONSIGN_TO_ON,
    LEGACY.IS_ENG_PART,
    LEGACY.IS_HALIDE_FREE,
    COALESCE(TRY_TO_BOOLEAN(LEGACY.ITAR_FLG),'FALSE')::BOOLEAN AS IS_ITAR,
    LEGACY.LEADED_DIE_ATTACH_FLG AS LEADED_DIE_ATTACH_CODE,
    COALESCE(LEGACY.MILITARY_FLG,'N')AS MILITARY_COMPLIANCE_CODE,
    COALESCE(TRY_TO_BOOLEAN(
        CASE 
            WHEN LEGACY.ONPN IS NOT NULL
                AND LEGACY.PROD_CLASS_CD IN ('AA','CP','CW','WD','KT','AM','WU')
                AND LEGACY.PROGRAM_CD ='M'
                AND LEGACY.PRICE_BOOK_FLG ='Y'
            THEN 'Y' 
            ELSE 'N' 
        END)
        ,'FALSE')::BOOLEAN AS IS_MPP,
    COALESCE(TRY_TO_BOOLEAN(LEGACY.NCNR_FLAG),'FALSE')::BOOLEAN AS IS_NCNR,
    COALESCE ( TRY_TO_BOOLEAN ( CASE 
                                    WHEN LEGACY.EFFECTIVE_TO_DATE ='31-DEC-3999'
                                    THEN
                                        CASE 
                                            WHEN
                                                LEGACY.TV_STATUS_CD ='A' AND
                                                LEGACY.PART_CLASS_CD IN ('AM', 'WU', '66', 'NP','AA', 'CP', 'WD', 'KT','CW','WV', 'CT')
                                            THEN 'Y'
                                            ELSE 'N'
                                        END
                                    ELSE NULL 
                                    END),
                                'FALSE')  AS IS_OPN,
    LEGACY.IS_PB_FREE_LEADS,
    COALESCE(TRY_TO_BOOLEAN(LEGACY.PRICE_BOOK_FLG),'FALSE')::BOOLEAN AS IS_PRICE_BOOK,
    CASE 
        WHEN LEGACY.EFFECTIVE_TO_DATE ='31-DEC-3999'
        THEN
            CASE 
                WHEN LEGACY.FINISH_CODE in ('NA','00')
                    OR LEGACY.LEADED_DIE_ATTACH_FLG ='Y'
                THEN 'N'
                ELSE 'Y'
            END
    ELSE NULL 
    END AS ROHS_CHINA_CODE,
    NVL((CASE 
            WHEN ( LEGACY.FINISH_CODE NOT IN ('NA','00')
            AND LEGACY.LEADED_DIE_ATTACH_FLG = 'Y' )
            THEN '7a'
            ELSE 'NONE'
        END)
        ,'##') AS ROHS_EU_EXEMPTION_CODE,
    NVL((CASE 
        WHEN LEGACY.EFFECTIVE_TO_DATE ='31-DEC-3999'
        THEN 
            CASE 
                WHEN  LEGACY.FINISH_CODE IN ('NA','00')
                    THEN 'N'
                ELSE 'Y'
            END
        ELSE NULL 
    END),'N')AS ROHS_EU_CODE,
    NVL(DECODE(LEGACY.SOQ_QTY,'1','Y','N'),'#') AS SAMPLE_ALLOW_CODE,
    CASE
        WHEN LEGACY.CUSTSPEC_FLG ='Y'
        THEN 'Y'
        WHEN LEGACY.CUSTSPEC_FLG ='N' 
            AND AGILE.MARKET_CD in ('S','Q') AND AGILE.ONPN IS NOT NULL
            AND LEGACY.PROD_CLASS_CD IN ('AA','CP','CW','WD','KT','AM','WU')
        THEN 'Y'
        ELSE 'N'
    END::BOOLEAN AS IS_SOLE_SOURCE,
    COALESCE(TRY_TO_BOOLEAN(CASE 
                            WHEN LEGACY.ONPN IS NOT NULL
                                AND LEGACY.PROD_CLASS_CD IN ('AA','CP','CW','WD','KT','AM','WU')
                            THEN LEGACY.STEP_PRICE_FLG
                            ELSE 'N' 
                            END)
            ,'FALSE')::BOOLEAN AS  IS_STEP_PRICE,
    LEGACY.TAPE_REEL_FLG AS IS_TAPE_REEL,
    LEGACY.IS_VALUED_PART,
    'DW' AS CREATE_BY,
    NVL(current_date(),TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS CREATE_DATE,
    NVL(LEGACY.LAST_CHG_USERID,' ') AS LAST_CHANGE_USER_ID,
    NVL(MODELN.PART_OID_AK_ID,0) AS PART_OID_AK_ID,
    NVL(AGILE.PART_TYPE_DESCRIPTION,' ') AS PART_TYPE_DESCRIPTION,
    NVL(AGILE.PART_SUB_TYPE_CD,' ')AS PART_SUB_TYPE_CD,
    NVL(AGILE.LIFECYCLE_PHASE_DESCRIPTION,' ') AS LIFECYCLE_PHASE_DESCRIPTION,
    NVL(AGILE.MARKET_PART_LIFECYCLE_DESCRIPTION,' ') AS MARKET_PART_LIFECYCLE_DESCRIPTION,
    NVL(AGILE.PACKING_CONFIG_ID,' ') AS PACKING_CONFIG_ID,
    NVL(AGILE.PART_OWNER_DESCRIPTION,' ') AS PART_OWNER_DESCRIPTION,
    NVL(AGILE.CORE_PART_NO_CONFIG_ID,' ') AS CORE_PART_NO_CONFIG_ID,
    NVL(AGILE.SAFE_LAUNCH_CODE,' ') AS SAFE_LAUNCH_CODE,
    NVL(AGILE.DESIGN_TYPE_DESC,' ') AS DESIGN_TYPE_DESC,
    NVL(AGILE.MKT_SEG_SUBSEG_EUC_PRI_DESC,' ') AS MKT_SEG_SUBSEG_EUC_PRI_DESC,
    NVL(AGILE.WSTS_CD,' ') AS WSTS_CD,
    NVL(AGILE.PROJECT_NUMBER_CD,' ') AS PROJECT_NUMBER_CD,
    NVL(AGILE.CASE_OUTLINE_ID,' ') AS CASE_OUTLINE_ID,
    NVL(AGILE.DIE_DESIGN_CONFIG_ID,' ') AS DIE_DESIGN_CONFIG_ID,
    NVL(AGILE.WAFER_BACKSIDE_VAR_ID,' ') AS WAFER_BACKSIDE_VAR_ID,
    NVL(AGILE.WAFER_FRONTSIDE_VARIANT_ID,' ') AS WAFER_FRONTSIDE_VARIANT_ID,
    NVL(AGILE.WAFER_TECH_VARIANT_ID,' ') AS WAFER_TECH_VARIANT_ID,
    NVL(AGILE.WAFER_TECH_TYPE_ID,' ') AS WAFER_TECH_TYPE_ID,
    NVL(AGILE.WAFER_TECH_FAM_ID,' ') AS WAFER_TECH_FAM_ID,
    NVL(AGILE.ENG_PKG_TYPE_DESC,' ') AS ENG_PKG_TYPE_DESC,
    NVL(AGILE.ENG_PKG_FAM_DESC,' ') AS ENG_PKG_FAM_DESC,
    NVL(AGILE.DEFLT_APS_STAGE_CD,' ') AS DEFLT_APS_STAGE_CD,
    NVL(AGILE.DEFLT_FE_BE_CD,' ') AS DEFLT_FE_BE_CD,
    LEGACY.ENGG_CHNG_ORDER_ID AS ENGG_CHNG_ORDER_ID,
    Coalesce(LEGACY.CUST_SPEC_CONTROLLED_FLG,'N') AS CUST_SPEC_CONTROLLED_CODE,
    LEGACY.COMPNT_CNT AS COMPONENT_COUNT,
    LEGACY.TOTAL_COMPNT_CNT AS TOTAL_COMPONENT_COUNT,
    LEGACY.DISTINCT_COMPNT_CNT AS DISTINCT_COMPONENT_COUNT,
    LEGACY.EXPERT_DATA_SRC_NM AS EXPERT_DATA_SOURCE_NAME,
    LEGACY.PREDOMINANT_OPN_PART_ID AS PREDOMINANT_OPN_PART_ID,
    LEGACY.EXPERT_USER_ID,
    LEGACY.EXPERT_EMAIL AS EXPERT_EMAIL,
    LEGACY.EXPERT_NM AS EXPERT_NAME,
    LEGACY.PLANNING_DIR_ID AS PLANNING_DIRECTOR_ID,
    LEGACY.PLANNING_DIR_NM AS PLANNING_DIRECTOR_NAME,
    LEGACY.BU_MGR_NM AS BU_MANAGER_NAME,
    LEGACY.BU_MGR_ID AS BU_MANAGER_ID,
    LEGACY.PART_QUAL_TRGT_MKT_DESC AS PART_QUALITY_TARGET_MARKET_TYPE,
    LEGACY.PART_QUAL_TRGT_MKT_DESC AS PART_QUALITY_TARGET_MARKET_DESCRIPTION,
    LEGACY.LEGACY_COMPANY_NM AS LEGACY_COMPANY_NAME,
    NVL(LEGACY.SBU_SHORT_DESC,' ') AS SBU_SHORT_DESCRIPTION,
    LEGACY.GLOBAL_PART_ID,
    LEGACY.PART_OWNER_NM AS PART_OWNER_NAME,
    NVL(APS.PACKAGE_GROUP_CD,' ') AS PACKAGE_GROUP_CODE,
    LEGACY.DCE_CYCLE_TM_DAYS AS DCE_CYCLE_TIME_DAYS,
    LEGACY.FAMILY_LEAD_TM_DAYS AS FAMILY_LEAD_TIME_DAYS,
    LEGACY.POINT_LEAD_TM_DAYS AS POINT_LEAD_TIME_DAYS,
    LEGACY.TREND_LEAD_TM_DAYS AS TREND_LEAD_TIME_DAYS,
    LEGACY.OVERRIDE_LEAD_TM_DAYS AS OVERRIDE_LEAD_TIME_DAYS,
    LEGACY.PLANNING_SYSTEM_LEAD_TM_DAYS AS PLANNING_SYSTEM_LEAD_TIME_DAYS,
    NVL(APS.MBOI_ASSY_SITES,' ') AS MBOI_ASSEMBLY_SITE_CODE,
    NVL(APS.MBOI_TEST_SITES,' ') AS MBOI_TEST_SITE_CODE,
    NVL(APS.APS_ASSY_SITES,' ') AS APS_ASSEMBLY_SITE_CODE,
    NVL(APS.APS_TEST_SITES,' ') AS APS_TEST_SITE_CODE,
    NVL(APS.AGILE_ASSY_SITES,' ') AS AGILE_ASSEMBLY_SITE_CODE,
    NVL(APS.AGILE_TEST_SITES,' ') AS AGILE_TEST_SITE_CODE,
    LEGACY.CAPACITY_GROUP_CD AS CAPACITY_GROUP_CODE,
    LEGACY.WFA_SITE_CD AS WFA_SITE_CODE,
    LEGACY.WPR_SITE_CD AS WPR_SITE_CODE,
    LEGACY.BSNSS_UNIT_CD AS BUSINESS_UNIT_CODE,
    LEGACY.PART_AREA_CD AS PART_AREA_CODE,
    LEGACY.PART_SUB_AREA_CD AS PART_SUB_AREA_CODE,
    LEGACY.ASSMBLY_RATIO_NUM AS ASSEMBLY_RATIO_NUMBER,
    LEGACY.AVG_USAGE_NUM AS AVERAGE_USAGE_NUMBER,
    LEGACY.PART_PROGRAM_CD AS PART_PROGRAM_CODE,
    LEGACY.SUPPLY_CHN_PLNG_FLG AS SUPPLY_CHN_PLNG_CODE,
    LEGACY.ANCHOR_STAR_PROD_FLG AS ANCHOR_STAR_PRODUCT_CODE,
    LEGACY.IO_PART_CLASS AS IO_PART_CLASS,
    Coalesce(LEGACY.IO_CATEGORY,' ') AS IO_CATEGORY,
    LEGACY.MFG_PART_ID AS MFG_PART_ID,
    NVL(LEGACY.GROUP_CD,' ') AS GROUP_CODE,
    NVL(LEGACY.GROUP_DESC,' ') AS GROUP_DESCRIPTION,
    LEGACY.DIVISION_CD AS DIVISION_CODE,
    LEGACY.DIVISION_DESC AS DIVISION_DESCRIPTION,
    LEGACY.BSNSS_UNIT_DESC AS BUSINESS_UNIT_DESCRIPTION,
    LEGACY.OPERTNL_CD AS OPERTNL_CODE,
    LEGACY.OPERTNL_DESC AS OPERTNL_DESC,
    LEGACY.IO_OVERRIDE_CATEGORY AS IO_OVERRIDE_CATEGORY,
    LEGACY.MARKET_PN,
    LEGACY.IS_MARKET_PN,
    LEGACY.ENG_PKG_VAR_ID,
    LEGACY.FLOW_CODE,
    LEGACY.IS_SPEC_CNTRL_BOM,
    LEGACY.DOCUMENT_ISSUE,
    LEGACY.ENG_PKG_CODE,
    LEGACY.IS_CONTAIN_ENCRYPT,
    LEGACY.SOLUTION_SELLING_TYPE,
    LEGACY.CAPC_CONSTR_COLOR,
    LEGACY.CAPC_CONSTR_COLOR_CALCED,
    LEGACY.CAPC_CONSTR_COLOR_OVRD,
    LEGACY.CAPC_CONSTR_COLOR_OVRD_UID,
    LEGACY.CAPC_CONSTR_COLOR_OVRD_RSN,
    LEGACY.CAPC_CONSTR_PRIM_CONSTR_RG,
    LEGACY.SUBJECT_EXPORT_ADMIN_REG AS SUBJECT_EXPORT_ADMIN_REG,
    LEGACY.MLQ AS MAX_LINE_QUANTITY,
    LEGACY.PB_FREE_PART_FLG AS IS_PB_FREE_PART,
    LEGACY.PB_FREE_PART_DESC AS PB_FREE_PART_DESCRIPTION,
    LEGACY.PB_FREE_PART_EXEMPT AS PB_FREE_PART_EXEMPT,
    LEGACY.LABEL_SYMBOL_ROHS_EU_FLG AS IS_LABEL_SYMBOL_ROHS_EU,
    LEGACY.LABEL_SYMBOL_ROHS_CHINA_FLG AS IS_LABEL_SYMBOL_ROHS_CHINA,
    LEGACY.LABEL_SYMBOL_ROHS_CHINA_VAL AS LABEL_SYMBOL_ROHS_CHINA_VALUE,
    LEGACY.LABEL_SYMBOL_PBFREE_2LI_FLG AS IS_LABEL_SYMBOL_PBFREE_2LI,
    LEGACY.LABEL_SYMBOL_2LI_FLG AS IS_LABEL_SYMBOL_2LI,
    LEGACY.LABEL_SYMBOL_ECAT_FLG AS IS_LABEL_SYMBOL_ECAT,
    LEGACY.LABEL_SYMBOL_HALIDE_FREE_FLG AS IS_LABEL_SYMBOL_HALIDE_FREE,
    LEGACY.LABEL_SYMBOL_RU_FLG AS IS_LABEL_SYMBOL_RU,
    LEGACY.LABEL_SYMBOL_ECAT_CD AS LABEL_SYMBOL_ECAT_CODE,
    LEGACY.HTS_EU_8_CD AS HTS_EU_8_CODE,
    LEGACY.PART_REL_FCST_DT AS PART_REL_FCST_DATE,
    LEGACY.PART_STATUS_GROUP,
    LEGACY.RELEASE_DATE,
    LEGACY.SOQ_QUANTITY,
    LEGACY.PACKAGE_CODE_DESCRIPTION,
    LEGACY.EXEMPTIONS,
    LEGACY.IS_ROHS,
    LEGACY.NPD_DATE,
    LEGACY.IS_ON_TARGET,
    LEGACY.PART_ADD_TIMESTAMP,
    NVL(BU_RULE.BUSINESS_GROUP,'MISC') AS BUSINESS_GROUP,
    BU_RULE.REPORTING_UNIT,
    NVL(AGILE.FSP_DATE,DATE('01-01-1900','MM-DD-YYYY') ) AS FSP_DATE
FROM {{ref('ETL_MART_ENGINEERING_PART_MAINFRAME')}} LEGACY
-- NEED TO REVALIDATE BELOW JOIN IS USELESS
    LEFT JOIN AGILE_PART AGILE
        ON LEGACY.PART_ID=AGILE.PART_ID
    LEFT JOIN APS_PART APS
        ON LEGACY.PART_ID=APS.PART_ID
    LEFT OUTER JOIN STG_MODELN_PRICING_OWNER MODELN
        ON LEGACY.PART_ID=MODELN.MPN
    LEFT OUTER JOIN  STG_XXON_FS_BU_RULE BU_RULE 
        ON LEGACY.PAL3_CODE= BU_RULE.BU_CD 
)
---------------------------------------------------------------------------------------
----------------------- APS PARTS -----------------------------------------------------
---------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------
,APS_FINAL_CTE AS (
SELECT 
    	APS.PART_ID,
    COALESCE(AGILE_APS.EFFECTIVE_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS EFFECTIVE_DATE,
    AGILE_APS.PART_DESCRIPTION,
    'APS' PART_SOURCE,
    APS.BASE_PART_ID AS LEGACY_PART_ID,
    AGILE_APS.PAL1_CODE,
    AGILE_APS.PAL2_CODE,
    AGILE_APS.PAL2_DESCRIPTION,
    AGILE_APS.PAL3_CODE,
    AGILE_APS.PAL3_DESCRIPTION,
    AGILE_APS.PAL4_CODE,
    AGILE_APS.PAL4_DESCRIPTION,
    AGILE_APS.PART_CLASS_CODE,
    AGILE_APS.PART_CLASS_DESCRIPTION,
    COALESCE(AGILE_APS.PART_TRANS_STATUS_CODE,'~') AS PART_TRANS_STATUS_CODE,
    COALESCE(AGILE_APS.PART_TRANS_STATUS_DESCRIPTION,'Unassigned') AS PART_TRANS_STATUS_DESCRIPTION,
    AGILE_APS.AEC_QUALIFIED_CODE,
    APS.APS_BUILD_CATEGORY_CODE,
    AGILE_APS.CASE_OUTLINE_CODE,
    AGILE_APS.COMMODITY_CODE,
    AGILE_APS.ECAT_CODE,
    AGILE_APS.ECCN_CODE,
    AGILE_APS.ERP_RESOURCE_ASY_CODE,
    AGILE_APS.ERP_RESOURCE_ASY_DESCRIPTION,
    AGILE_APS.ERP_RESOURCE_BSP_CODE,
    AGILE_APS.ERP_RESOURCE_FAB_CODE,
    AGILE_APS.ERP_RESOURCE_FSP_CODE,
    AGILE_APS.ERP_RESOURCE_MEF_CODE,
    AGILE_APS.ERP_RESOURCE_SWF_CODE,
    AGILE_APS.ERP_RESOURCE_TST_CODE,
    AGILE_APS.HTS_EU_CODE,
    NVL(AGILE_APS.HTS_EU_CODE_DESCRIPTION,' ') AS HTS_EU_CODE_DESCRIPTION,
    AGILE_APS.HTS_US_CODE,
    AGILE_APS.HTS_US_CODE_DESCRIPTION,
    NVL(AGILE_APS.MARKET_LEADTIME_WEEKS,-1) AS MARKET_LEADTIME_WEEKS,
    NVL(MODELN.MOQ_QUANTITY,-1) AS MOQ_QUANTITY,
    AGILE_APS.MPQ_PRI_CONTAINER_CODE,
    NVL(AGILE_APS.MPQ_PRI_CONTAINER_QUANTITY,-1) AS MPQ_PRI_CONTAINER_QUANTITY,
    AGILE_APS.MSL_VALUE,
    NVL(AGILE_APS.MSL_TEMPERATURE,-1) AS MSL_TEMPERATURE,
    NVL(AGILE_APS.PART_COMP_TYPE_CODE,' ') AS PART_COMP_TYPE_CODE,
    AGILE_APS.PART_RELEASE_STATUS_CODE,
    AGILE_APS.PART_RELEASE_STATUS_DESCRIPTION,
    AGILE_APS.PART_SPEC_ID,
    NVL(AGILE_APS.POQ_CONTAINER_CODE,' ') AS POQ_CONTAINER_CODE,
    NVL(AGILE_APS.POQ_QUANTITY,-1) AS POQ_QUANTITY,
    AGILE_APS.PPAP_CAPABLE_CODE,
    NVL(AGILE_APS.PART_LINE_ID,' ') AS PART_LINE_ID,
    AGILE_APS.PART_AVAILABILITY_STATUS_CODE,
    AGILE_APS.QUALITY_LVL_CODE,
    AGILE_APS.QUALITY_LVL_TARGET_MARKET_DESCRIPTION,
    NVL(AGILE_APS.SBU_CODE,' ') AS SBU_CODE,
    NVL(AGILE_APS.SOQ_CONTAINER_CODE,' ') AS SOQ_CONTAINER_CODE,
    NVL(AGILE_APS.PDPW_VALUE,-1) AS PDPW_VALUE,
    AGILE_APS.IS_UL_LISTED,
    AGILE_APS.UOM_OPERATIONS_CODE,
    NVL(AGILE_APS.WAFER_SIZE_VALUE,0) AS WAFER_SIZE_VALUE,
    COALESCE(AGILE_APS.LAST_CHANGE_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS LAST_CHANGE_DATE,
    COALESCE(AGILE_APS.LAST_ORDER_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS LAST_ORDER_DATE,
    COALESCE(AGILE_APS.LAST_SHIP_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS LAST_SHIP_DATE,
    COALESCE(AGILE_APS.NEW_PART_DEFINITION_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS NEW_PART_DEFINITION_DATE,
    COALESCE(AGILE_APS.NEW_PART_EXP_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS NEW_PART_EXP_DATE,
    COALESCE(AGILE_APS.PART_RELEASE_PRODUCTION_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS PART_RELEASE_PRODUCTION_DATE,
    COALESCE(try_to_boolean(APS.APS_REL_FLG),'False')::BOOLEAN AS  IS_APS_RELEVANT,
    AGILE_APS.IS_BURN_IN,
    AGILE_APS.BUY_SELL_CODE,
    AGILE_APS.IS_CUSTOM_ELEC_TEST,
    AGILE_APS.IS_CUSTOM_MARK_ONLY,
    COALESCE(try_to_boolean(AGILE_APS.IS_CUSTOM_PART_ID),'False')::BOOLEAN AS  IS_CUSTOM_PART_ID,
    AGILE_APS.IS_CUSTOMER_CONSIGN_TO_ON,
    AGILE_APS.IS_ENG_PART,
    AGILE_APS.IS_HALIDE_FREE,
    AGILE_APS.IS_ITAR,
    AGILE_APS.LEADED_DIE_ATTACH_CODE,
    AGILE_APS.MILITARY_COMPLIANCE_CODE,
    AGILE_APS.IS_MPP,
    AGILE_APS.IS_NCNR,
    AGILE_APS.IS_OPN,
    AGILE_APS.IS_PB_FREE_LEADS,
    AGILE_APS.IS_PRICE_BOOK,
    AGILE_APS.ROHS_CHINA_CODE,
    AGILE_APS.ROHS_EU_EXEMPTION_CODE,
    NVL(AGILE_APS.ROHS_EU_CODE,'N') AS ROHS_EU_CODE,
    AGILE_APS.SAMPLE_ALLOW_CODE,
    AGILE_APS.IS_SOLE_SOURCE,
    AGILE_APS.IS_STEP_PRICE,
    AGILE_APS.IS_TAPE_REEL,
    AGILE_APS.IS_VALUED_PART,
    AGILE_APS.CREATE_BY,
    COALESCE(AGILE_APS.CREATE_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) AS CREATE_DATE,
    AGILE_APS.LAST_CHANGE_USER_ID,
    NVL(AGILE_APS.PART_OID_AK_ID,-1) AS PART_OID_AK_ID,
    AGILE_APS.PART_TYPE_DESCRIPTION,
    CASE WHEN APS.BASE_PART_ID = 'COE' 
    THEN 'COE'
    ELSE AGILE_APS.PART_SUB_TYPE_CD 
    END AS PART_SUB_TYPE_CD,
    AGILE_APS.LIFECYCLE_PHASE_DESCRIPTION,
    AGILE_APS.MARKET_PART_LIFECYCLE_DESCRIPTION,
    AGILE_APS.PACKING_CONFIG_ID,
    AGILE_APS.PART_OWNER_DESCRIPTION,
    AGILE_APS.CORE_PART_NO_CONFIG_ID,
    AGILE_APS.SAFE_LAUNCH_CODE,
    AGILE_APS.DESIGN_TYPE_DESC,
    AGILE_APS.MKT_SEG_SUBSEG_EUC_PRI_DESC,
    AGILE_APS.WSTS_CD,
    AGILE_APS.PROJECT_NUMBER_CD,
    AGILE_APS.CASE_OUTLINE_ID,
    AGILE_APS.DIE_DESIGN_CONFIG_ID,
    AGILE_APS.WAFER_BACKSIDE_VAR_ID,
    AGILE_APS.WAFER_FRONTSIDE_VARIANT_ID,
    AGILE_APS.WAFER_TECH_VARIANT_ID,
    AGILE_APS.WAFER_TECH_TYPE_ID,
    AGILE_APS.WAFER_TECH_FAM_ID,
    AGILE_APS.ENG_PKG_TYPE_DESC,
    AGILE_APS.ENG_PKG_FAM_DESC,
    APS.DEFLT_APS_STAGE_CD,
    CASE WHEN APS.BASE_PART_ID = 'COE' 
    THEN 'BE'
    ELSE AGILE_APS.DEFLT_FE_BE_CD
    END AS DEFLT_FE_BE_CD,
    AGILE_APS.ENGG_CHNG_ORDER_ID,
    Coalesce(AGILE_APS.CUST_SPEC_CONTROLLED_CODE,'N') AS CUST_SPEC_CONTROLLED_CODE,
    'TBD' AS COMPONENT_COUNT,
    'TBD' AS TOTAL_COMPONENT_COUNT,    
    'TBD' AS DISTINCT_COMPONENT_COUNT, 
    AGILE_APS.EXPERT_DATA_SOURCE_NAME,
    NVL(APS.OPN,' ') AS PREDOMINANT_OPN_PART_ID,
    NVL(APS.SCA_UID,' ') AS EXPERT_USER_ID,
    --- USERID TABLE---
    NVL(APS.MAIL, ' ') AS EXPERT_EMAIL,
    NVL(APS.SCA_USERNAME, ' ') AS EXPERT_NAME,
    NVL(APS.DIR_UID, ' ')  AS PLANNING_DIRECTOR_ID,
    NVL(APS.DIR_NAME, ' ')  AS PLANNING_DIRECTOR_NAME,




    NVL(APS.BUPM_USERNAME,' ') AS BU_MANAGER_NAME,
    NVL(APS.BUPM_UID,' ') AS BU_MANAGER_ID,

    AGILE_APS.PART_QUALITY_TARGET_MARKET_TYPE,
    AGILE_APS.PART_QUALITY_TARGET_MARKET_DESCRIPTION,
    AGILE_APS.LEGACY_COMPANY_NAME,
    AGILE_APS.SBU_SHORT_DESCRIPTION,
    AGILE_APS.GLOBAL_PART_ID,
    AGILE_APS.PART_OWNER_NAME,
    NVL(APS.PACKAGE_GROUP_CD,' ')  AS PACKAGE_GROUP_CODE,
    NVL(APS.DCE_CT,0) AS DCE_CYCLE_TIME_DAYS,
    NVL(APS.FAMILY_LT,0) AS FAMILY_LEAD_TIME_DAYS,
    NVL(APS.POINT_LT,0) AS POINT_LEAD_TIME_DAYS,
    NVL(APS.TREND_LT,0) AS TREND_LEAD_TIME_DAYS,
    NVL(APS.OVERRIDE_LT,0) AS OVERRIDE_LEAD_TIME_DAYS,
    NVL(APS.TBOT_LT,0) AS PLANNING_SYSTEM_LEAD_TIME_DAYS,
    NVL(APS.MBOI_ASSY_SITES,' ') AS MBOI_ASSEMBLY_SITE_CODE,
    NVL(APS.MBOI_TEST_SITES,' ') AS MBOI_TEST_SITE_CODE,
    NVL(APS.APS_ASSY_SITES,' ') AS APS_ASSEMBLY_SITE_CODE,
    NVL(APS.APS_TEST_SITES,' ') AS APS_TEST_SITE_CODE,
    NVL(APS.AGILE_ASSY_SITES,' ') AS AGILE_ASSEMBLY_SITE_CODE,
    NVL(APS.AGILE_TEST_SITES,' ') AS AGILE_TEST_SITE_CODE,
    NVL(APS.CAPC_GROUP_CD,' ') AS CAPACITY_GROUP_CODE,
    NVL(APS.WFA_SITES,' ') AS WFA_SITE_CODE,
    NVL(APS.WPR_SITES,' ') AS WPR_SITE_CODE,
    AGILE_APS.BUSINESS_UNIT_CODE,
    NVL(APS.AREA,' ') AS PART_AREA_CODE,
    NVL(APS.SUB_AREA,' ') AS PART_SUB_AREA_CODE,
    NVL(APS.ASSY_RATIO,0) AS ASSEMBLY_RATIO_NUMBER,
    NVL(APS.AVERAGE_USAGE,0) AS AVERAGE_USAGE_NUMBER,
    AGILE_APS.PART_PROGRAM_CODE,
    AGILE_APS.SUPPLY_CHN_PLNG_CODE,
    AGILE_APS.ANCHOR_STAR_PRODUCT_CODE,
    COALESCE(APS.IO_PART_CLASS,' ') AS IO_PART_CLASS,
    COALESCE(APS.IO_CATEGORY,' ') AS IO_CATEGORY,
    AGILE_APS.MFG_PART_ID,
    AGILE_APS.GROUP_CODE,
    AGILE_APS.GROUP_DESCRIPTION,
    AGILE_APS.DIVISION_CODE,
    AGILE_APS.DIVISION_DESCRIPTION,
    AGILE_APS.BUSINESS_UNIT_DESCRIPTION,
    AGILE_APS.OPERTNL_CODE,
    AGILE_APS.OPERTNL_DESC,
    COALESCE(APS.IO_OVERRIDE_CATEGORY,' ') IO_OVERRIDE_CATEGORY,
    AGILE_APS.MARKET_PN,
    AGILE_APS.IS_MARKET_PN,
    AGILE_APS.ENG_PKG_VAR_ID,
    AGILE_APS.FLOW_CODE,
    AGILE_APS.IS_SPEC_CNTRL_BOM,
    AGILE_APS.DOCUMENT_ISSUE,
    AGILE_APS.ENG_PKG_CODE,
    AGILE_APS.IS_CONTAIN_ENCRYPT,
    AGILE_APS.SOLUTION_SELLING_TYPE,
    NVL(APS.CAPC_CONSTR_COLOR, ' ') AS CAPC_CONSTR_COLOR,
    NVL(APS.COLOR_ADJUSTED, ' ') AS CAPC_CONSTR_COLOR_CALCED,
    NVL(APS.COLOR_OVERRIDE, ' ') AS CAPC_CONSTR_COLOR_OVRD,
    NVL(APS.CREATED_USERID, ' ') AS CAPC_CONSTR_COLOR_OVRD_UID,
    NVL(APS.REASON_DESC, ' ') AS CAPC_CONSTR_COLOR_OVRD_RSN,
    APS.CAPC_CONSTR_PRIM_CONSTR_RG,
    AGILE_APS.SUBJECT_EXPORT_ADMIN_REG,
    NVL(APS.MLQ,0) AS MAX_LINE_QUANTITY,
    AGILE_APS.IS_PB_FREE_PART,
    AGILE_APS.PB_FREE_PART_DESCRIPTION,
    AGILE_APS.PB_FREE_PART_EXEMPT,
    AGILE_APS.IS_LABEL_SYMBOL_ROHS_EU,
    AGILE_APS.IS_LABEL_SYMBOL_ROHS_CHINA,
    AGILE_APS.LABEL_SYMBOL_ROHS_CHINA_VALUE,
    AGILE_APS.IS_LABEL_SYMBOL_PBFREE_2LI,
    AGILE_APS.IS_LABEL_SYMBOL_2LI,
    AGILE_APS.IS_LABEL_SYMBOL_ECAT,
    AGILE_APS.IS_LABEL_SYMBOL_HALIDE_FREE,
    AGILE_APS.IS_LABEL_SYMBOL_RU,
    AGILE_APS.LABEL_SYMBOL_ECAT_CODE,
    AGILE_APS.HTS_EU_8_CODE,
    COALESCE(AGILE_APS.PART_REL_FCST_DATE, TO_DATE('1-1-1900', 'MM-DD-YYYY')) PART_REL_FCST_DATE,
    AGILE_APS.PART_STATUS_GROUP,
    AGILE_APS.PART_RELEASE_PRODUCTION_DATE AS RELEASE_DATE,
    AGILE_APS.SOQ_QUANTITY,
    AGILE_APS.PACKAGE_CODE_DESCRIPTION,
    AGILE_APS.EXEMPTIONS,
    AGILE_APS.IS_ROHS,
    AGILE_APS.NEW_PART_DEFINITION_DATE AS NPD_DATE,
    AGILE_APS.IS_ON_TARGET,
    AGILE_APS.PART_ADD_TIMESTAMP,
    NVL(BU_RULE.BUSINESS_GROUP,'MISC') AS BUSINESS_GROUP,
    BU_RULE.REPORTING_UNIT,
    NVL(AGILE_APS.FSP_DATE ,DATE('01-01-1900', 'MM-DD-YYYY')) AS FSP_DATE  
FROM APS_PART APS
LEFT JOIN AGILE_FINAL_CTE AGILE_APS
    ON APS.BASE_PART_ID = AGILE_APS.PART_ID
LEFT JOIN MAINFRAME_PART MAINFRAME
    ON APS.BASE_PART_ID = MAINFRAME.PART_ID 
LEFT OUTER JOIN STG_MODELN_PRICING_OWNER MODELN
    ON APS.BASE_PART_ID = MODELN.MPN
LEFT OUTER JOIN  STG_XXON_FS_BU_RULE BU_RULE 
    ON AGILE_APS.PAL3_CODE= BU_RULE.BU_CD    
)

,FINAL_SQL AS (
    SELECT 
        * 
    FROM AGILE_FINAL_CTE FINAL
    UNION ALL
    SELECT 
        * 
    FROM LEGACY_FINAL_CTE
        WHERE PART_ID NOT IN (SELECT PART_ID FROM {{ ref('ETL_MART_ENGINEERING_PART_AGILE')}})
    UNION ALL
    SELECT 
        * 
    FROM APS_FINAL_CTE
        WHERE PART_ID NOT IN (SELECT PART_ID FROM {{ ref('ETL_MART_ENGINEERING_PART_AGILE')}})
        AND PART_ID NOT IN (SELECT PART_ID FROM {{ref('ETL_MART_ENGINEERING_PART_MAINFRAME')}})
)
SELECT 
    STG.*,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
    '{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
    {{V_BIW_BATCH_ID}} as BIW_BATCH_ID,
    md5(object_construct ('col1',EFFECTIVE_DATE::string, 'col2',PART_DESCRIPTION::string, 'col3',PART_SOURCE::string,
    'col4',LEGACY_PART_ID::string, 'col5',PAL1_CODE::string, 'col6',PAL2_CODE::string, 'col7',PAL2_DESCRIPTION::string, 'col8',PAL3_CODE::string,
    'col9',PAL3_DESCRIPTION::string, 'col10',PAL4_CODE::string, 'col11',PAL4_DESCRIPTION::string, 'col12',PART_CLASS_CODE::string,
    'col13',PART_CLASS_DESCRIPTION::string, 'col14',PART_TRANS_STATUS_CODE::string, 'col15',PART_TRANS_STATUS_DESCRIPTION::string,
    'col16',AEC_QUALIFIED_CODE::string, 'col17',APS_BUILD_CATEGORY_CODE::string, 'col18',CASE_OUTLINE_CODE::string, 'col19',COMMODITY_CODE::string,
    'col20',ECAT_CODE::string, 'col21',ECCN_CODE::string, 'col22',ERP_RESOURCE_ASY_CODE::string, 'col23',ERP_RESOURCE_ASY_DESCRIPTION::string,
    'col24',ERP_RESOURCE_BSP_CODE::string, 'col25',ERP_RESOURCE_FAB_CODE::string, 'col26',ERP_RESOURCE_FSP_CODE::string, 'col27',ERP_RESOURCE_MEF_CODE::string,
    'col28',ERP_RESOURCE_SWF_CODE::string, 'col29',ERP_RESOURCE_TST_CODE::string, 'col30',HTS_EU_CODE::string, 'col31',HTS_EU_CODE_DESCRIPTION::string,
    'col32',HTS_US_CODE::string, 'col33',HTS_US_CODE_DESCRIPTION::string, 'col34',MARKET_LEADTIME_WEEKS::string, 'col35',MOQ_QUANTITY::string,
    'col36',MPQ_PRI_CONTAINER_CODE::string, 'col37',MPQ_PRI_CONTAINER_QUANTITY::string, 'col38',MSL_VALUE::string, 'col39',MSL_TEMPERATURE::string,
    'col40',PART_COMP_TYPE_CODE::string, 'col41',PART_RELEASE_STATUS_CODE::string, 'col42',PART_RELEASE_STATUS_DESCRIPTION::string,
    'col43',PART_SPEC_ID::string, 'col44',POQ_CONTAINER_CODE::string, 'col45',POQ_QUANTITY::string, 'col46',PPAP_CAPABLE_CODE::string,
    'col47',PART_LINE_ID::string, 'col48',PART_AVAILABILITY_STATUS_CODE::string, 'col49',QUALITY_LVL_CODE::string,
    'col50',QUALITY_LVL_TARGET_MARKET_DESCRIPTION::string, 'col51',SBU_CODE::string, 'col52',SOQ_CONTAINER_CODE::string, 'col53',PDPW_VALUE::string,
    'col54',IS_UL_LISTED::string, 'col55',UOM_OPERATIONS_CODE::string, 'col56',WAFER_SIZE_VALUE::string, 'col57',LAST_CHANGE_DATE::string,
    'col58',LAST_ORDER_DATE::string, 'col59',LAST_SHIP_DATE::string, 'col60',NEW_PART_DEFINITION_DATE::string, 'col61',NEW_PART_EXP_DATE::string,
    'col62',PART_RELEASE_PRODUCTION_DATE::string, 'col63',IS_APS_RELEVANT::string, 'col64',IS_BURN_IN::string, 'col65',BUY_SELL_CODE::string,
    'col66',IS_CUSTOM_ELEC_TEST::string, 'col67',IS_CUSTOM_MARK_ONLY::string, 'col68',IS_CUSTOM_PART_ID::string, 'col69',IS_CUSTOMER_CONSIGN_TO_ON::string,
    'col70',IS_ENG_PART::string, 'col71',IS_HALIDE_FREE::string, 'col72',IS_ITAR::string, 'col73',LEADED_DIE_ATTACH_CODE::string,
    'col74',MILITARY_COMPLIANCE_CODE::string, 'col75',IS_MPP::string, 'col76',IS_NCNR::string, 'col77',IS_OPN::string, 'col78',IS_PB_FREE_LEADS::string,
    'col79',IS_PRICE_BOOK::string, 'col80',ROHS_CHINA_CODE::string, 'col81',ROHS_EU_EXEMPTION_CODE::string, 'col82',ROHS_EU_CODE::string,
    'col83',SAMPLE_ALLOW_CODE::string, 'col84',IS_SOLE_SOURCE::string, 'col85',IS_STEP_PRICE::string, 'col86',IS_TAPE_REEL::string,
    'col87',IS_VALUED_PART::string, 'col88',CREATE_BY::string, 'col89',CREATE_DATE::string, 'col90',LAST_CHANGE_USER_ID::string,
    'col91',PART_OID_AK_ID::string, 'col92',PART_TYPE_DESCRIPTION::string, 'col93',PART_SUB_TYPE_CD::string, 'col94',LIFECYCLE_PHASE_DESCRIPTION::string,
    'col95',MARKET_PART_LIFECYCLE_DESCRIPTION::string, 'col96',PACKING_CONFIG_ID::string, 'col97',PART_OWNER_DESCRIPTION::string, 'col98',CORE_PART_NO_CONFIG_ID::string,
    'col99',SAFE_LAUNCH_CODE::string, 'col100',DESIGN_TYPE_DESC::string, 'col101',MKT_SEG_SUBSEG_EUC_PRI_DESC::string, 'col102',WSTS_CD::string,
    'col103',PROJECT_NUMBER_CD::string, 'col104',CASE_OUTLINE_ID::string, 'col105',DIE_DESIGN_CONFIG_ID::string, 'col106',WAFER_BACKSIDE_VAR_ID::string,
    'col107',WAFER_FRONTSIDE_VARIANT_ID::string, 'col108',WAFER_TECH_VARIANT_ID::string, 'col109',WAFER_TECH_TYPE_ID::string, 'col110',WAFER_TECH_FAM_ID::string,
    'col111',ENG_PKG_TYPE_DESC::string, 'col112',ENG_PKG_FAM_DESC::string, 'col113',DEFLT_APS_STAGE_CD::string, 'col114',DEFLT_FE_BE_CD::string,
    'col115',ENGG_CHNG_ORDER_ID::string, 'col116',CUST_SPEC_CONTROLLED_CODE::string, 'col117',COMPONENT_COUNT::string, 'col118',TOTAL_COMPONENT_COUNT::string,
    'col119',DISTINCT_COMPONENT_COUNT::string, 'col120',EXPERT_DATA_SOURCE_NAME::string, 'col121',PREDOMINANT_OPN_PART_ID::string, 'col122',EXPERT_USER_ID::string,
    'col123',EXPERT_EMAIL::string, 'col124',EXPERT_NAME::string, 'col125',PLANNING_DIRECTOR_ID::string, 'col126',PLANNING_DIRECTOR_NAME::string,
    'col127',BU_MANAGER_NAME::string, 'col128',BU_MANAGER_ID::string, 'col129',PART_QUALITY_TARGET_MARKET_TYPE::string,
    'col130',PART_QUALITY_TARGET_MARKET_DESCRIPTION::string, 'col131',LEGACY_COMPANY_NAME::string, 'col132',SBU_SHORT_DESCRIPTION::string, 'col133',GLOBAL_PART_ID::string,
    'col134',PART_OWNER_NAME::string, 'col135',PACKAGE_GROUP_CODE::string, 'col136',DCE_CYCLE_TIME_DAYS::string, 'col137',FAMILY_LEAD_TIME_DAYS::string,
    'col138',POINT_LEAD_TIME_DAYS::string, 'col139',TREND_LEAD_TIME_DAYS::string, 'col140',OVERRIDE_LEAD_TIME_DAYS::string,
    'col141',PLANNING_SYSTEM_LEAD_TIME_DAYS::string, 'col142',MBOI_ASSEMBLY_SITE_CODE::string, 'col143',MBOI_TEST_SITE_CODE::string,
    'col144',APS_ASSEMBLY_SITE_CODE::string, 'col145',APS_TEST_SITE_CODE::string, 'col146',AGILE_ASSEMBLY_SITE_CODE::string, 'col147',AGILE_TEST_SITE_CODE::string,
    'col148',CAPACITY_GROUP_CODE::string, 'col149',WFA_SITE_CODE::string, 'col150',WPR_SITE_CODE::string, 'col151',BUSINESS_UNIT_CODE::string,
    'col152',PART_AREA_CODE::string, 'col153',PART_SUB_AREA_CODE::string, 'col154',ASSEMBLY_RATIO_NUMBER::string, 'col155',AVERAGE_USAGE_NUMBER::string,
    'col156',PART_PROGRAM_CODE::string, 'col157',SUPPLY_CHN_PLNG_CODE::string, 'col158',ANCHOR_STAR_PRODUCT_CODE::string, 'col159',IO_PART_CLASS::string,
    'col160',IO_CATEGORY::string, 'col161',MFG_PART_ID::string, 'col162',GROUP_CODE::string, 'col163',GROUP_DESCRIPTION::string,
    'col164',DIVISION_CODE::string, 'col165',DIVISION_DESCRIPTION::string, 'col166',BUSINESS_UNIT_DESCRIPTION::string, 'col167',OPERTNL_CODE::string,
    'col168',OPERTNL_DESC::string, 'col169',IO_OVERRIDE_CATEGORY::string, 'col170',MARKET_PN::string, 'col171',IS_MARKET_PN::string,
    'col172',ENG_PKG_VAR_ID::string, 'col173',FLOW_CODE::string, 'col174',IS_SPEC_CNTRL_BOM::string, 'col175',DOCUMENT_ISSUE::string,
    'col176',ENG_PKG_CODE::string, 'col177',IS_CONTAIN_ENCRYPT::string, 'col178',SOLUTION_SELLING_TYPE::string, 'col179',CAPC_CONSTR_COLOR::string,
    'col180',CAPC_CONSTR_COLOR_CALCED::string, 'col181',CAPC_CONSTR_COLOR_OVRD::string, 'col182',CAPC_CONSTR_COLOR_OVRD_UID::string,
    'col183',CAPC_CONSTR_COLOR_OVRD_RSN::string, 'col184',CAPC_CONSTR_PRIM_CONSTR_RG::string, 'col185',SUBJECT_EXPORT_ADMIN_REG::string,
    'col186',MAX_LINE_QUANTITY::string, 'col187',IS_PB_FREE_PART::string, 'col188',PB_FREE_PART_DESCRIPTION::string, 'col189',PB_FREE_PART_EXEMPT::string,
    'col190',IS_LABEL_SYMBOL_ROHS_EU::string, 'col191',IS_LABEL_SYMBOL_ROHS_CHINA::string, 'col192',LABEL_SYMBOL_ROHS_CHINA_VALUE::string,
    'col193',IS_LABEL_SYMBOL_PBFREE_2LI::string, 'col194',IS_LABEL_SYMBOL_2LI::string, 'col195',IS_LABEL_SYMBOL_ECAT::string,
    'col196',IS_LABEL_SYMBOL_HALIDE_FREE::string, 'col197',IS_LABEL_SYMBOL_RU::string, 'col198',LABEL_SYMBOL_ECAT_CODE::string, 'col199',HTS_EU_8_CODE::string,
    'col200',PART_REL_FCST_DATE::string, 'col201',PART_STATUS_GROUP::string, 'col202',RELEASE_DATE::string, 'col203',SOQ_QUANTITY::string,
    'col204',PACKAGE_CODE_DESCRIPTION::string, 'col205',EXEMPTIONS::string, 'col206',IS_ROHS::string, 'col207',NPD_DATE::string, 'col208',IS_ON_TARGET::string,
    'col209',PART_ADD_TIMESTAMP::string, 'col210',BUSINESS_GROUP::string, 'col211',REPORTING_UNIT::string,'col212',FSP_DATE::string)::string ) as BIW_MD5_KEY 
FROM FINAL_SQL STG