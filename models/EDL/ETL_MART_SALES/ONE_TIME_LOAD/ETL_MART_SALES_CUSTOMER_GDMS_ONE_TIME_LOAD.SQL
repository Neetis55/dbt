/*---------------------------------------------------------------------------
Command to run model:
-- dbt run --full-refresh --select ETL_MART_SALES_CUSTOMER_GDMS_ONE_TIME_LOAD
-- dbt run --select ETL_MART_SALES_CUSTOMER_GDMS_ONE_TIME_LOAD

Version     Date            Author          Description
-------     --------        -----------     ----------------------------------
1.0         07/11/2022      SRUTHI KASBE     Initial Version
---------------------------------------------------------------------------*/
{################# EDW Job Template Variables #################}
{%-set v_pk_list = ['CUSTOMER_KEY']-%}
{%-set v_house_keeping_column = ['BIW_INS_DTTM','BIW_UPD_DTTM','BIW_BATCH_ID','BIW_MD5_KEY']-%}
/*--DBT Variable used during development*/
{% if is_incremental() %}
{%-set v_all_column_list =  edw_get_column_list( this ) -%}
{%-set v_update_column_list = edw_get_quoted_column_list( this ,v_pk_list|list + ['BIW_INS_DTTM']|list) -%}
{%-set v_md5_column_list =  edw_get_md5_column_list( this ,v_pk_list|list+ v_house_keeping_column|list ) -%}
/*--DBT Variable*/
/*--SELECT {{v_all_column_list}}*/
/*--SELECT {{v_update_column_list}}*/
/*--SELECT {{v_md5_column_list}}*/
{% endif %}
{################# Batch control insert and update SQL #################}
{%- set v_dbt_job_name = 'DBT_ETL_MART_SALES_CUSTOMER_GDMS_ONE_TIME_LOAD'-%}
-- Step 1 Batch process info
{%- set v_watermark = edw_batch_control(v_dbt_job_name,config.get('schema'),config.get('alias') ,config.get('tags'),config.get('materialized') ) -%}
{%- set V_LWM = v_watermark[0] -%}
{%- set V_HWM = v_watermark[1] -%}
{%- set V_START_DTTM = v_watermark[2] -%}
{%- set V_BIW_BATCH_ID = v_watermark[3] -%}
{%- set v_sql_upd_success_batch = "CALL UTILITY.EDW_BATCH_SUCCESS_PROC('"~v_dbt_job_name~"')" -%}
{%- set V_EDW_DB = var('V_EDW_DEFAULT_DB') +env_var('DBT_DEP_ENV')+'.' -%}

{################# Snowflake Object Configuration #################}
{{
    config(
         description = 'Building ETL VIEW CUSTOMER Fact Historical GDMS for Sales Mart '
        ,transient=true
        ,materialized='view'
        ,schema ='ETL_MART_SALES'
        ,alias='CUSTOMER_GDMS_ONE_TIME_LOAD'
        ,tags =['MART_SALES']
        )
}}

WITH GDMS_CUSTOMER AS (
    SELECT 
        MD5(GDMS.CUST_CD) AS CUSTOMER_KEY,
		GDMS.CUST_CD AS CUSTOMER_CODE, 
		NULL AS ERP_SITE_USE_ID, 
		NULL AS ERP_STATUS, 
		NULL AS CRM_CUSTOMER_OID, 
		NULL AS CRM_STATUS, 
		GDMS.CUST_NM AS CUSTOMER_NAME, 
		NULL AS CUSTOMER_TYPE_CODE, 
		NULL AS CUSTOMER_TYPE_DESCRIPTION, 
		COALESCE(GDMS.SOURCE_SYSTEM_ID,'HISTORY_GDMS_DWH')  AS CUSTOMER_SOURCE, 
		NULL AS BUSINESS_CLASS_CODE, 
		NULL AS CORPORATION_CODE, 
		NULL AS CORPORATION_DESCRIPTION, 
		NULL AS END_CORPORATION_CODE, 
		NULL AS END_CORPORATION_DESCRIPTION, 
		NULL AS SALES_ORGANIZATION_CODE, 
		NULL AS END_USE_CODE, 
		NULL AS END_USE_DESCRIPTION, 
		NULL AS CURRENCY_CODE, 
		NULL AS ISO_CURRENCY_CODE, 
		NULL AS HAS_CREDIT_HOLD, 
		NULL AS HAS_SERVICE_HOLD, 
		NULL AS HAS_APPROVAL, 
		NULL AS ORDER_PROCESSING_REGION_CODE, 
		NULL AS CRD_SHIP_EARLY_DAYS_QUANTITY, 
		NULL AS HAS_CRD_PARTIAL, 
		NULL AS SHIP_VIA_CODE, 
		NULL AS HAS_SHIP_TO_CRD, 
		NULL AS SHIP_LATE_DAYS_QUANTITY, 
		NULL AS BILL_CUSTOMER_CODE, 
		NULL AS HANDLING_METHOD_CODE, 
		NULL AS HANDLING_METHOD_CODE_DESCRIPTION, 
		NULL AS IS_EDI_CUSTOMER, 
		NULL AS FINAL_DESTINATION_DESCRIPTION, 
		NULL AS BILL_COUNTRY_SOURCE_CODE, 
		NULL AS FOB_OPTION_CODE, 
		NULL AS PAYMENT_TERM_CODE, 
		NULL AS FINANCIAL_BANK_ID, 
		NULL AS TRANSIT_DAYS_QUANTITY, 
		NULL AS DELIVERY_TYPE_CODE, 
		NULL AS DATE_CODE_MAXIMUM_AGE_QUANTITY, 
		NULL AS IS_CPN_REQUIRED, 
		NULL AS VAT_TAX_CODE, 
		NULL AS MINIMUM_DOLLAR_VALUE_AMOUNT, 
		NULL AS IS_MINIMUM_DOLLAR_VALUE_VALID, 
		NULL AS CORPORATION_CATEGORY_CODE, 
		NULL AS CORPORATION_CATEGORY_DESCRIPTION, 
		NULL AS CUSTOMER_ENTITY_CODE, 
		NULL AS FORECAST_TYPE_CODE, 
		NULL AS IS_FORECAST_CUSTOMER, 
		NULL AS FORECAST_CUSTOMER_STATUS_CODE, 
		NULL AS REPLENISHMENT_CODE, 
		NULL AS SERVICE_TYPE_CODE, 
		NULL AS CHANGE_ORDER_APROVAL_REQUIRED_CODE, 
		NULL AS UDC_GENERIC_PROG_DESCRIPTION, 
		NULL AS CREATE_BY_ID, 
		NULL AS CREATE_DTTM, 
		NULL AS LAST_UPDATE_BY_ID, 
		NULL AS LAST_UPDATE_DTTM, 
		NULL AS IS_DELETED, 
		NULL AS QUALITY_CODE, 
		NULL AS FISCAL_ACCOUNT_NUMBER, 
		NULL AS CREDIT_LIMIT_AMOUNT, 
		NULL AS DIVISION, 
		NULL AS SALES_STRUCTURE, 
		NULL AS MARKET_SEGMENT_CODE, 
		NULL AS IS_ASSEMBLY_LOCATION, 
		NULL AS OPERATING_UNIT, 
		NULL AS COF_CODE, 
		NULL AS COG_CODE, 
		NULL AS CUSTOMER_SHUT_DOWN_FROM_DATE, 
		NULL AS CUSTOMER_SHUT_DOWN_TO_DATE, 
		NULL AS FOB_OPTION_DESCRIPTION, 
		NULL AS TAX_CODE, 
		NULL AS ORACLE_ORDER_TYPE, 
		NULL AS ORACLE_PAYMENT_TERM, 
		NULL AS ORACLE_SITE_STATUS, 
		NULL AS ORACLE_SITE_NUMBER, 
		NULL AS ORACLE_SHIP_METHOD, 
		NULL AS FREE_TRADE_ZONE, 
		NULL AS COLLECTOR_NAME, 
		NULL AS IS_SHUTDOWN, 
		NULL AS CSR_USER_ID, 
		NULL AS CSR_FIRST_NAME, 
		NULL AS CSR_LAST_NAME, 
		NULL AS CSR_EMAIL, 
		NULL AS CSR_PHONE, 
		NULL AS CSR_CONTACT_LAST_UPDATE_BY, 
		NULL AS CSR_CONTACT_CREATED_BY, 
		NULL AS FQA_USER_ID, 
		NULL AS FQA_FIRST_NAME, 
		NULL AS FQA_LAST_NAME, 
		NULL AS FQA_EMAIL, 
		NULL AS FQA_PHONE, 
		NULL AS FQA_CONTACT_LAST_UPDATE_BY, 
		NULL AS FQA_CONTACT_CREATED_BY, 
		NULL AS BUYER_USER_ID, 
		NULL AS BUYER_FIRST_NAME, 
		NULL AS BUYER_LAST_NAME, 
		NULL AS BUYER_EMAIL, 
		NULL AS BUYER_PHONE, 
		NULL AS BUYER_CONTACT_LAST_UPDATE_BY, 
		NULL AS BUYER_CONTACT_CREATED_BY, 
		NULL AS FSE_USER_ID, 
		NULL AS FSE_FIRST_NAME, 
		NULL AS FSE_LAST_NAME, 
		NULL AS FSE_EMAIL, 
		NULL AS FSE_PHONE, 
		NULL AS FSE_CONTACT_LAST_UPDATE_BY, 
		NULL AS FSE_CONTACT_CREATED_BY, 
		'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
		'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
		{{V_BIW_BATCH_ID}} AS BIW_BATCH_ID
    FROM 
        {{ source('STG_DWH_MARTS', 'DISTRIBUTOR_POS_CUSTOMER_DIM') }} GDMS
    QUALIFY( ROW_NUMBER() OVER (PARTITION BY CUST_CD ORDER BY BIW_UPD_DTTM DESC)=1)
UNION ALL
    SELECT 
        MD5(DISTI.DISTI_CD) AS CUSTOMER_KEY, 
		DISTI.DISTI_CD AS CUSTOMER_CODE, 
		NULL AS ERP_SITE_USE_ID, 
		NULL AS ERP_STATUS, 
		NULL AS CRM_CUSTOMER_OID, 
		NULL AS CRM_STATUS, 
		NULL AS CUSTOMER_NAME,  -- WE ARE NOT SURE ON DATA MAPPING
		NULL AS CUSTOMER_TYPE_CODE, 
		NULL AS CUSTOMER_TYPE_DESCRIPTION, 
		COALESCE(DISTI.SOURCE_SYSTEM_ID,'HISTORY_GDMS_DWH') AS CUSTOMER_SOURCE, 
		NULL AS BUSINESS_CLASS_CODE, 
		NULL AS CORPORATION_CODE, 
		NULL AS CORPORATION_DESCRIPTION, 
		NULL AS END_CORPORATION_CODE, 
		NULL AS END_CORPORATION_DESCRIPTION, 
		NULL AS SALES_ORGANIZATION_CODE, 
		NULL AS END_USE_CODE, 
		NULL AS END_USE_DESCRIPTION, 
		NULL AS CURRENCY_CODE, 
		NULL AS ISO_CURRENCY_CODE, 
		NULL AS HAS_CREDIT_HOLD, 
		NULL AS HAS_SERVICE_HOLD, 
		NULL AS HAS_APPROVAL, 
		NULL AS ORDER_PROCESSING_REGION_CODE, 
		NULL AS CRD_SHIP_EARLY_DAYS_QUANTITY, 
		NULL AS HAS_CRD_PARTIAL, 
		NULL AS SHIP_VIA_CODE, 
		NULL AS HAS_SHIP_TO_CRD, 
		NULL AS SHIP_LATE_DAYS_QUANTITY, 
		NULL AS BILL_CUSTOMER_CODE, 
		NULL AS HANDLING_METHOD_CODE, 
		NULL AS HANDLING_METHOD_CODE_DESCRIPTION, 
		NULL AS IS_EDI_CUSTOMER, 
		NULL AS FINAL_DESTINATION_DESCRIPTION, 
		NULL AS BILL_COUNTRY_SOURCE_CODE, 
		NULL AS FOB_OPTION_CODE, 
		NULL AS PAYMENT_TERM_CODE, 
		NULL AS FINANCIAL_BANK_ID, 
		NULL AS TRANSIT_DAYS_QUANTITY, 
		NULL AS DELIVERY_TYPE_CODE, 
		NULL AS DATE_CODE_MAXIMUM_AGE_QUANTITY, 
		NULL AS IS_CPN_REQUIRED, 
		NULL AS VAT_TAX_CODE, 
		NULL AS MINIMUM_DOLLAR_VALUE_AMOUNT, 
		NULL AS IS_MINIMUM_DOLLAR_VALUE_VALID, 
		NULL AS CORPORATION_CATEGORY_CODE, 
		NULL AS CORPORATION_CATEGORY_DESCRIPTION, 
		NULL AS CUSTOMER_ENTITY_CODE, 
		NULL AS FORECAST_TYPE_CODE, 
		NULL AS IS_FORECAST_CUSTOMER, 
		NULL AS FORECAST_CUSTOMER_STATUS_CODE, 
		NULL AS REPLENISHMENT_CODE, 
		NULL AS SERVICE_TYPE_CODE, 
		NULL AS CHANGE_ORDER_APROVAL_REQUIRED_CODE, 
		NULL AS UDC_GENERIC_PROG_DESCRIPTION, 
		NULL AS CREATE_BY_ID, 
		NULL AS CREATE_DTTM, 
		NULL AS LAST_UPDATE_BY_ID, 
		NULL AS LAST_UPDATE_DTTM, 
		NULL AS IS_DELETED, 
		NULL AS QUALITY_CODE, 
		NULL AS FISCAL_ACCOUNT_NUMBER, 
		NULL AS CREDIT_LIMIT_AMOUNT, 
		NULL AS DIVISION, 
		NULL AS SALES_STRUCTURE, 
		NULL AS MARKET_SEGMENT_CODE, 
		NULL AS IS_ASSEMBLY_LOCATION, 
		NULL AS OPERATING_UNIT, 
		NULL AS COF_CODE, 
		NULL AS COG_CODE, 
		NULL AS CUSTOMER_SHUT_DOWN_FROM_DATE, 
		NULL AS CUSTOMER_SHUT_DOWN_TO_DATE, 
		NULL AS FOB_OPTION_DESCRIPTION, 
		NULL AS TAX_CODE, 
		NULL AS ORACLE_ORDER_TYPE, 
		NULL AS ORACLE_PAYMENT_TERM, 
		NULL AS ORACLE_SITE_STATUS, 
		NULL AS ORACLE_SITE_NUMBER, 
		NULL AS ORACLE_SHIP_METHOD, 
		NULL AS FREE_TRADE_ZONE, 
		NULL AS COLLECTOR_NAME, 
		NULL AS IS_SHUTDOWN, 
		NULL AS CSR_USER_ID, 
		NULL AS CSR_FIRST_NAME, 
		NULL AS CSR_LAST_NAME, 
		NULL AS CSR_EMAIL, 
		NULL AS CSR_PHONE, 
		NULL AS CSR_CONTACT_LAST_UPDATE_BY, 
		NULL AS CSR_CONTACT_CREATED_BY, 
		NULL AS FQA_USER_ID, 
		NULL AS FQA_FIRST_NAME, 
		NULL AS FQA_LAST_NAME, 
		NULL AS FQA_EMAIL, 
		NULL AS FQA_PHONE, 
		NULL AS FQA_CONTACT_LAST_UPDATE_BY, 
		NULL AS FQA_CONTACT_CREATED_BY, 
		NULL AS BUYER_USER_ID, 
		NULL AS BUYER_FIRST_NAME, 
		NULL AS BUYER_LAST_NAME, 
		NULL AS BUYER_EMAIL, 
		NULL AS BUYER_PHONE, 
		NULL AS BUYER_CONTACT_LAST_UPDATE_BY, 
		NULL AS BUYER_CONTACT_CREATED_BY, 
		NULL AS FSE_USER_ID, 
		NULL AS FSE_FIRST_NAME, 
		NULL AS FSE_LAST_NAME, 
		NULL AS FSE_EMAIL, 
		NULL AS FSE_PHONE, 
		NULL AS FSE_CONTACT_LAST_UPDATE_BY, 
		NULL AS FSE_CONTACT_CREATED_BY, 
		'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_INS_DTTM ,
		'{{V_START_DTTM}}'::TIMESTAMP_NTZ BIW_UPD_DTTM ,
		{{V_BIW_BATCH_ID}} AS BIW_BATCH_ID
    FROM 
        {{ source('STG_DWH_MARTS', 'DISTRIBUTOR_POS_CUSTOMER_DIM') }} DISTI
    QUALIFY( ROW_NUMBER() OVER (PARTITION BY DISTI_CD ORDER BY BIW_UPD_DTTM DESC)=1)
)


SELECT 
    CUST.* ,
    md5(object_construct ('col1',CUSTOMER_KEY::string, 'col2',CUSTOMER_CODE::string, 'col3',BUSINESS_CLASS_CODE::string, 'col4',CORPORATION_CODE::string, 'col5',END_CORPORATION_CODE::string
    , 'col6',SALES_ORGANIZATION_CODE::string, 'col7',END_USE_CODE::string, 'col8',CURRENCY_CODE::string, 'col9',ISO_CURRENCY_CODE::string, 'col10',CUSTOMER_TYPE_CODE::string
    , 'col11',SHIP_VIA_CODE::string, 'col12',ORDER_PROCESSING_REGION_CODE::string, 'col13',BILL_CUSTOMER_CODE::string, 'col14',HANDLING_METHOD_CODE::string, 'col15',BILL_COUNTRY_SOURCE_CODE::string
    , 'col16',FOB_OPTION_CODE::string, 'col17',PAYMENT_TERM_CODE::string, 'col18',CORPORATION_CATEGORY_CODE::string, 'col19',VAT_TAX_CODE::string, 'col20',CUSTOMER_ENTITY_CODE::string
    , 'col21',FORECAST_TYPE_CODE::string, 'col22',FORECAST_CUSTOMER_STATUS_CODE::string, 'col23',REPLENISHMENT_CODE::string, 'col24',SERVICE_TYPE_CODE::string, 'col25',CHANGE_ORDER_APROVAL_REQUIRED_CODE::string
    , 'col26',QUALITY_CODE::string, 'col27',COF_CODE::string, 'col28',COG_CODE::string, 'col29',TAX_CODE::string, 'col30',MARKET_SEGMENT_CODE::string
    , 'col31',IS_EDI_CUSTOMER::string, 'col32',IS_CPN_REQUIRED::string, 'col33',IS_MINIMUM_DOLLAR_VALUE_VALID::string, 'col34',IS_FORECAST_CUSTOMER::string, 'col35',IS_DELETED::string
    , 'col36',IS_ASSEMBLY_LOCATION::string, 'col37',IS_SHUTDOWN::string, 'col38',HAS_CREDIT_HOLD::string, 'col39',HAS_SERVICE_HOLD::string, 'col40',HAS_APPROVAL::string
    , 'col41',HAS_CRD_PARTIAL::string, 'col42',HAS_SHIP_TO_CRD::string, 'col43',CORPORATION_DESCRIPTION::string, 'col44',END_CORPORATION_DESCRIPTION::string, 'col45',END_USE_DESCRIPTION::string
    , 'col46',CUSTOMER_TYPE_DESCRIPTION::string, 'col47',HANDLING_METHOD_CODE_DESCRIPTION::string, 'col48',FINAL_DESTINATION_DESCRIPTION::string, 'col49',CORPORATION_CATEGORY_DESCRIPTION::string, 'col50',UDC_GENERIC_PROG_DESCRIPTION::string
    , 'col51',FOB_OPTION_DESCRIPTION::string, 'col52',CUSTOMER_SOURCE::string, 'col53',ERP_SITE_USE_ID::string, 'col54',ERP_STATUS::string, 'col55',CRM_CUSTOMER_OID::string
    , 'col56',CRM_STATUS::string, 'col57',CUSTOMER_NAME::string, 'col58',CRD_SHIP_EARLY_DAYS_QUANTITY::string, 'col59',SHIP_LATE_DAYS_QUANTITY::string, 'col60',FINANCIAL_BANK_ID::string
    , 'col61',TRANSIT_DAYS_QUANTITY::string, 'col62',DELIVERY_TYPE_CODE::string, 'col63',DATE_CODE_MAXIMUM_AGE_QUANTITY::string, 'col64',MINIMUM_DOLLAR_VALUE_AMOUNT::string, 'col65',CREATE_BY_ID::string
    , 'col66',CREATE_DTTM::string, 'col67',LAST_UPDATE_BY_ID::string, 'col68',LAST_UPDATE_DTTM::string, 'col69',FISCAL_ACCOUNT_NUMBER::string, 'col70',CREDIT_LIMIT_AMOUNT::string
    , 'col71',DIVISION::string, 'col72',SALES_STRUCTURE::string, 'col73',OPERATING_UNIT::string, 'col74',CUSTOMER_SHUT_DOWN_FROM_DATE::string, 'col75',CUSTOMER_SHUT_DOWN_TO_DATE::string
    , 'col76',ORACLE_ORDER_TYPE::string, 'col77',ORACLE_PAYMENT_TERM::string, 'col78',ORACLE_SITE_STATUS::string, 'col79',ORACLE_SITE_NUMBER::string, 'col80',ORACLE_SHIP_METHOD::string
    , 'col81',FREE_TRADE_ZONE::string, 'col82',COLLECTOR_NAME::string, 'col83',CSR_USER_ID::string, 'col84',CSR_FIRST_NAME::string, 'col85',CSR_LAST_NAME::string
    , 'col86',CSR_EMAIL::string, 'col87',CSR_PHONE::string, 'col88',CSR_CONTACT_LAST_UPDATE_BY::string, 'col89',CSR_CONTACT_CREATED_BY::string, 'col90',FQA_USER_ID::string
    , 'col91',FQA_FIRST_NAME::string, 'col92',FQA_LAST_NAME::string, 'col93',FQA_EMAIL::string, 'col94',FQA_PHONE::string, 'col95',FQA_CONTACT_LAST_UPDATE_BY::string
    , 'col96',FQA_CONTACT_CREATED_BY::string, 'col97',BUYER_USER_ID::string, 'col98',BUYER_FIRST_NAME::string, 'col99',BUYER_LAST_NAME::string, 'col100',BUYER_EMAIL::string
    , 'col101',BUYER_PHONE::string, 'col102',BUYER_CONTACT_LAST_UPDATE_BY::string, 'col103',BUYER_CONTACT_CREATED_BY::string, 'col104',FSE_USER_ID::string, 'col105',FSE_FIRST_NAME::string
    , 'col106',FSE_LAST_NAME::string, 'col107',FSE_EMAIL::string, 'col108',FSE_PHONE::string, 'col109',FSE_CONTACT_LAST_UPDATE_BY::string, 'col110',FSE_CONTACT_CREATED_BY::string)::string )::BINARY as BIW_MD5_KEY
FROM    
    GDMS_CUSTOMER AS CUST
QUALIFY( ROW_NUMBER() OVER (PARTITION BY CUSTOMER_CODE ORDER BY BIW_UPD_DTTM DESC)=1)